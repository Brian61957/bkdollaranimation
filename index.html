<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deriv Pro Toolkit</title>
<meta name="description" content="Dashboard • Botbuilder • DTrade • Chart • Strategies" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%23e80020'/%3E%3Ctext x='50%25' y='52%25' text-anchor='middle' font-size='36' font-family='Arial' fill='white'%3ED%3C/text%3E%3C/svg%3E" />
<style>
  :root{
    --brand-red:#e80020;
    --brand-black:#000;
    --brand-white:#fff;
    --text:#111;
    --muted:#6b7280;
    --pill-green-bg:#0b3d0b;
    --pill-green-border:#1a6b1a;
    --pill-green-text:#b6ffb6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:#ffffff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  button{cursor:pointer}
  .container{max-width:1200px;margin:0 auto;padding:0 12px}

  /* ======= HEADER (black to match sessions bar) ======= */
  .topbar{background:var(--brand-black);color:#fff}
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:10px 0;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;letter-spacing:.3px}
  .brand-badge{display:inline-grid;place-items:center;width:26px;height:26px;border-radius:8px;background:var(--brand-red);color:#fff;font-weight:900}
  .right-actions{display:flex;align-items:center;gap:10px}
  .cta{display:inline-flex;align-items:center;gap:8px;border:1px solid #333;background:#111;color:#fff;padding:6px 10px;border-radius:10px}
  .cta:hover{filter:brightness(1.1)}
  .social{display:flex;align-items:center;gap:8px;margin:0 6px}
  .icon-btn{display:inline-grid;place-items:center;width:32px;height:32px;border-radius:50%;background:#111;border:1px solid #333}
  .icon-btn:hover{filter:brightness(1.1)}
  .icon{width:18px;height:18px;display:block}
  .dots{position:relative}
  .dots-menu{position:absolute;right:0;top:38px;background:#111;border:1px solid #333;border-radius:10px;min-width:210px;display:none;padding:6px}
  .dots-menu a,.dots-menu button{display:flex;justify-content:space-between;align-items:center;width:100%;padding:10px;border-radius:8px;color:#fff;background:transparent;border:0}
  .dots-menu a:hover,.dots-menu button:hover{background:#1a1a1a}

  /* ======= MARQUEE ======= */
  .marquee-wrap{background:#111;color:#fff;border-top:1px solid #222;border-bottom:1px solid #222}
  .marquee{white-space:nowrap;overflow:hidden}
  .marquee span{display:inline-block;padding:8px 0;animation:scroll 26s linear infinite}
  @keyframes scroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

  /* ======= SESSIONS BAR (one line) ======= */
  .tabs-bar{background:#000;color:#fff;border-bottom:1px solid #111}
  .tabs{display:flex;gap:6px;overflow:auto;white-space:nowrap;padding:8px 0}
  .tab{background:#111;color:#fff;border:1px solid #333;padding:8px 12px;border-radius:999px;font-weight:600;font-size:13px}
  .tab.active{background:var(--brand-red);border-color:var(--brand-red)}
  .tabs::-webkit-scrollbar{height:6px}
  .tabs::-webkit-scrollbar-thumb{background:#222;border-radius:999px}

  /* ======= CONTENT SECTIONS ======= */
  section{padding:16px 0}
  .hidden{display:none!important}

  /* ==== DASHBOARD cards (collapsible on upload) ==== */
  .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .card{border:1px solid #e5e5e5;border-radius:12px;padding:12px;background:#fff}
  .card h4{margin:0 0 6px}
  .upload-target{border:1px dashed #bbb;padding:14px;border-radius:12px;text-align:center;background:#fafafa}
  .upload-target input{display:none}
  .upload-target label{display:inline-block;padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff}

  /* ==== Strategy embed box ==== */
  .strategy-embed-wrap{position:relative;width:100%;height:78vh;max-height:900px;border:1px solid #e5e5e5;border-radius:12px;overflow:hidden;background:#fff}
  .strategy-embed-wrap iframe{width:100%;height:100%;border:0}
  .strategy-fallback{display:none;position:absolute;inset:0;background:#fff;align-items:center;justify-content:center;text-align:center;padding:24px}
  .strategy-fallback.show{display:flex}

  /* ==== DTrade / Chart embeds ==== */
  .embed-box{height:78vh;border:1px solid #e5e5e5;border-radius:12px;overflow:hidden}
  .embed-box iframe{width:100%;height:100%;border:0}

  /* ======= Free Bots grid ======= */
  .bots-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .bot{border:1px solid #e5e5e5;border-radius:12px;padding:12px;background:#fff}
  .bot h5{margin:0 0 6px}
  .bot .actions{display:flex;gap:8px;margin-top:8px}
  .bot button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff}

  /* ======= Run Bot button + Slide-up Console ======= */
  .run-fixed{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:1000}
  .run-btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand-red);color:#fff;border:0;padding:12px 18px;border-radius:999px;font-weight:800;box-shadow:0 6px 18px rgba(232,0,32,.35)}
  .run-btn:hover{filter:brightness(.96)}
  .slide{position:fixed;left:0;right:0;bottom:-60vh;height:60vh;background:#fff;border-top:3px solid var(--brand-red);box-shadow:0 -8px 30px rgba(0,0,0,.2);border-top-left-radius:16px;border-top-right-radius:16px;transition:bottom .35s ease;z-index:999}
  .slide.open{bottom:0}
  .slide-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eee}
  .slide-title{font-weight:800}
  .slide-body{height:calc(100% - 52px);overflow:auto;padding:12px 16px}
  .log{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap}
  .stat{display:inline-block;margin-right:12px;padding:6px 10px;background:#f5f5f5;border-radius:999px;border:1px solid #eee}

  /* ======= Live Balance pill (top-left; hidden until login) ======= */
  #balance-pill{display:none;position:fixed;top:10px;left:12px;z-index:1200;background:var(--pill-green-bg);color:var(--pill-green-text);border:1px solid var(--pill-green-border);padding:6px 10px;border-radius:999px;font:600 13px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;box-shadow:0 2px 8px rgba(0,0,0,.15);white-space:nowrap;gap:8px;align-items:center}
  #balance-pill .badge{width:18px;height:18px;display:inline-grid;place-items:center;border-radius:50%;font-size:11px;font-weight:700;background:#fff;color:#111}
  #balance-pill .amt{font-weight:700;letter-spacing:.2px}

  /* ======= Responsive ======= */
  @media (max-width:1000px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}.bots-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:640px){.cards{grid-template-columns:1fr}.bots-grid{grid-template-columns:1fr}.tabs{gap:6px}.tab{padding:8px 10px;font-size:12px}}
</style>
</head>
<body>

<!-- Live Balance pill (appears only after sign-in) -->
<div id="balance-pill" aria-live="polite">
  <span id="acc-badge" class="badge" title="Account type">?</span>
  <span class="amt" id="balance-amount">—</span>
</div>

<!-- ======= HEADER ======= -->
<header class="topbar">
  <div class="container topbar-inner">
    <div class="brand">
      <span class="brand-badge">D</span>
      <span>Deriv Pro Toolkit</span>
    </div>
    <div class="social">
      <a class="icon-btn" href="https://chat.whatsapp.com/I9pHdE0sNuTJbKMzgJ84GD?mode=ac_t" target="_blank" rel="noopener" title="WhatsApp">
        <img class="icon" alt="wa" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20'%3E%3Cpath fill='%23fff' d='M10 1.5A8.5 8.5 0 0 0 2.2 14.4L1 19l4.7-1.2A8.5 8.5 0 1 0 10 1.5Zm0 1.7a6.8 6.8 0 0 1 5.8 10.4l-.3.4.8 3-3-.8-.4.2A6.8 6.8 0 1 1 10 3.2Zm-3 3.5c.1-.3.3-.5.6-.5h.5c.2 0 .4.1.5.3l.5 1c.1.2.1.4 0 .6l-.3.5c-.2.3-.2.6 0 .9c.4.7 1 1.3 1.7 1.7c.3.2.6.2.9 0l.5-.3c.2-.1.4-.1.6 0l1 .5c.2.1.3.3.3.5v.5c0 .3-.2.5-.5.6c-.5.2-1 .4-1.5.4c-1.1 0-2.3-.5-3.4-1.5S6.6 10 6.6 8.9c0-.5.2-1 .4-1.5Z'/%3E%3C/svg%3E" />
      </a>
      <a class="icon-btn" href="https://t.me/+BsA8dvAh_lA2YzRk" target="_blank" rel="noopener" title="Telegram">
        <img class="icon" alt="tg" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20'%3E%3Cpath fill='%23fff' d='M19.7 2.7L1.5 10.2c-1 .4-1 1.8 0 2.1l4.5 1.6l2 6.2c.2.6 1 .7 1.4.3l2.9-3l5.8 4.3c.6.4 1.5.1 1.7-.6l3.2-17.5c.2-1-0.8-1.8-1.7-1.4zM7.2 15l8.5-7.9c.2-.2.5.1.3.3l-7.3 8.9c-.1.2-.4.2-.5 0l-1-1.1z'/%3E%3C/svg%3E" />
      </a>
    </div>
    <div class="right-actions">
      <a id="signin" class="cta" href="#" title="Sign in / Sign up">Sign in / Sign up</a>
      <div class="dots">
        <button id="dotsBtn" class="cta" aria-haspopup="true" aria-expanded="false">⋮</button>
        <div id="dotsMenu" class="dots-menu" role="menu" aria-hidden="true">
          <button id="accountSettings" role="menuitem">Account settings <span>›</span></button>
          <a href="https://app.deriv.com/cashier/deposit" target="_blank" rel="noopener" role="menuitem">Cashier (Deposit/Withdraw) <span>↗</span></a>
          <button id="toggleDark" role="menuitem">Dark mode <span>☾</span></button>
          <button id="signOut" role="menuitem">Sign out <span>↩</span></button>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ======= RUNNING WORDS ======= -->
<div class="marquee-wrap">
  <div class="container">
    <div class="marquee"><span>Trade responsibly. Analyze first, then run your bot. Demo account starts at $10,000. Monitor ticks, wins, losses, and P/L in real time. — Trade responsibly. Analyze first, then run your bot…</span></div>
  </div>
</div>

<!-- ======= SESSIONS BAR (one row) ======= -->
<nav class="tabs-bar">
  <div class="container">
    <div id="tabs" class="tabs" role="tablist" aria-label="Sessions">
      <button class="tab active" data-tab="dashboard" role="tab" aria-selected="true">Dashboard</button>
      <button class="tab" data-tab="botbuilder" role="tab">Botbuilder</button>
      <button class="tab" data-tab="analysis" role="tab">Analysis Tool</button>
      <button class="tab" data-tab="signals" role="tab">Signal Tool</button>
      <button class="tab" data-tab="dtrade" role="tab">DTrade</button>
      <button class="tab" data-tab="chart" role="tab">Chart</button>
      <button class="tab" data-tab="strategy" role="tab">Strategies</button>
      <button class="tab" data-tab="tutorial" role="tab">Tutorial</button>
      <button class="tab" data-tab="freebots" role="tab">Free Bots</button>
    </div>
  </div>
</nav>

<!-- ======= CONTENT ======= -->
<main class="container">

  <!-- DASHBOARD -->
  <section id="dashboard" role="tabpanel">
    <div class="cards" id="dashCards">
      <div class="card">
        <h4>Upload Local Bot</h4>
        <div class="upload-target">
          <input id="localXml" type="file" accept=".xml" />
          <label for="localXml">Choose XML</label>
          <p class="muted" style="color:#6b7280;margin-top:8px;">Loads into dashboard ready to be fed &amp; run</p>
        </div>
      </div>
      <div class="card">
        <h4>Google Drive Bot</h4>
        <div class="upload-target">
          <input id="driveUrl" type="url" placeholder="Paste Drive link…" />
          <label id="fetchDrive" for="driveUrl">Fetch</label>
          <p class="muted" style="color:#6b7280;margin-top:8px;">Public file or export link</p>
        </div>
      </div>
      <div class="card">
        <h4>Botbuilder Default</h4>
        <div class="upload-target">
          <button id="loadDefault">Load Default Bot</button>
          <p class="muted" style="color:#6b7280;margin-top:8px;">Loads the built-in default to edit</p>
        </div>
      </div>
      <div class="card">
        <h4>Quick Strategy</h4>
        <div class="upload-target">
          <button id="quickStrat">Open Strategy Options</button>
          <p class="muted" style="color:#6b7280;margin-top:8px;">Even/Odd • Matches/Differs • Over/Under • Rise/Fall</p>
        </div>
      </div>
    </div>

    <div id="botCanvas" class="card hidden" style="margin-top:12px;">
      <h4>Bot Ready to Configure</h4>
      <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">
        <div>
          <label>Market / Volatility</label>
          <select id="volSel">
            <option>Volatility 10 Index</option>
            <option>Volatility 10 (1s) Index</option>
            <option>Volatility 25 Index</option>
            <option>Volatility 25 (1s) Index</option>
            <option>Volatility 30 Index</option>
            <option>Volatility 30 (1s) Index</option>
            <option>Volatility 50 Index</option>
            <option>Volatility 50 (1s) Index</option>
            <option>Volatility 75 Index</option>
            <option>Volatility 75 (1s) Index</option>
            <option>Volatility 100 Index</option>
            <option>Volatility 100 (1s) Index</option>
          </select>
        </div>
        <div>
          <label>Stake</label>
          <input id="stake" type="number" step="0.01" value="1.00" />
        </div>
        <div>
          <label>Take Profit (optional)</label>
          <input id="tp" type="number" step="0.01" placeholder="Auto by bot if empty" />
        </div>
        <div>
          <label>Stop Loss</label>
          <input id="sl" type="number" step="0.01" placeholder="e.g. 10.00" />
        </div>
        <div>
          <label>Ticks</label>
          <input id="ticks" type="number" value="3" min="1" max="10" />
        </div>
        <div>
          <label>
            <input id="copyDemoReal" type="checkbox" />
            Copy Demo to Real (toggle)
          </label>
        </div>
      </div>
      <div style="margin-top:12px">
        <textarea id="xmlView" rows="10" style="width:100%;font-family:ui-monospace,Consolas,monospace"></textarea>
      </div>
    </div>
  </section>

  <!-- BOTBUILDER -->
  <section id="botbuilder" class="hidden" role="tabpanel">
    <div class="card">
      <h4>Default Bot</h4>
      <p style="margin:6px 0 12px;color:#6b7280">Loaded same as dashboard “Load Default Bot”. Edit and run.</p>
      <textarea id="builderXml" rows="16" style="width:100%;font-family:ui-monospace,Consolas,monospace"></textarea>
    </div>
  </section>

  <!-- ANALYSIS -->
  <section id="analysis" class="hidden" role="tabpanel">
    <div class="card"><h4>Analysis Tool (coming next)</h4><p>We’ll link the custom analysis engine here.</p></div>
  </section>

  <!-- SIGNALS -->
  <section id="signals" class="hidden" role="tabpanel">
    <div class="card"><h4>Signal Tool (coming next)</h4><p>Matches/Differs predictor will appear here.</p></div>
  </section>

  <!-- DTRADE (embedded) -->
  <section id="dtrade" class="hidden" role="tabpanel">
    <div class="embed-box">
      <iframe title="DTrade" src="https://app.deriv.com/?lang=en"></iframe>
    </div>
  </section>

  <!-- CHART (embedded) -->
  <section id="chart" class="hidden" role="tabpanel">
    <div class="embed-box">
      <iframe title="Chart" src="https://app.deriv.com/?lang=en"></iframe>
    </div>
  </section>

  <!-- STRATEGY (embedded Deriv with fallback) -->
  <section id="strategy" class="hidden" role="tabpanel">
    <div class="strategy-embed-wrap">
      <iframe id="strategy-embed" title="Deriv Strategy" referrerpolicy="no-referrer" allow="clipboard-read; clipboard-write; fullscreen" src="https://app.deriv.com/?lang=en"></iframe>
      <div id="strategy-fallback" class="strategy-fallback">
        <div>
          <h3 style="margin:0 0 10px;">Open Strategy in Deriv</h3>
          <p style="margin:0 0 18px;max-width:560px;">
            Your browser blocked the embedded view. Click below to open the exact Strategy page
            (Accumulators, Matches/Differs, Over/Under, Even/Odd, live ticks & percentages).
          </p>
          <button id="open-deriv-btn" style="cursor:pointer;padding:12px 16px;border-radius:10px;border:1px solid #dcdcdc;background:#e80020;color:#fff;font-weight:700">Open in Deriv</button>
        </div>
      </div>
    </div>
  </section>

  <!-- TUTORIAL -->
  <section id="tutorial" class="hidden" role="tabpanel">
    <div class="card"><h4>Tutorial</h4><p>Short video & steps on connecting your Deriv account, loading bots, and running safely.</p></div>
  </section>

  <!-- FREE BOTS -->
  <section id="freebots" class="hidden" role="tabpanel">
    <div class="bots-grid" id="botsGrid">
      <!-- Example entries; clicking “Load to Dashboard” collapses dashboard cards and shows bot -->
      <div class="bot">
        <h5>Entry Touch B-Bot</h5>
        <p class="muted" style="color:#6b7280">Digits / Touch logic</p>
        <div class="actions">
          <button data-bot="entry_touch">Load to Dashboard</button>
        </div>
      </div>
      <div class="bot">
        <h5>Digit Ranger Auto</h5>
        <p class="muted" style="color:#6b7280">Digits strategy</p>
        <div class="actions">
          <button data-bot="digit_ranger">Load to Dashboard</button>
        </div>
      </div>
      <div class="bot">
        <h5>Premium Rise/Fall</h5>
        <p class="muted" style="color:#6b7280">Rise/Fall variant</p>
        <div class="actions">
          <button data-bot="premium_rf">Load to Dashboard</button>
        </div>
      </div>
      <div class="bot">
        <h5>RF-Marble</h5>
        <p class="muted" style="color:#6b7280">RF marble flow</p>
        <div class="actions">
          <button data-bot="rf_marble">Load to Dashboard</button>
        </div>
      </div>
      <div class="bot">
        <h5>Accumulator Starter</h5>
        <p class="muted" style="color:#6b7280">Accumulators base</p>
        <div class="actions">
          <button data-bot="accum_base">Load to Dashboard</button>
        </div>
      </div>
      <div class="bot">
        <h5>Even/Odd Quick</h5>
        <p class="muted" style="color:#6b7280">Digits even/odd</p>
        <div class="actions">
          <button data-bot="even_odd">Load to Dashboard</button>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- ======= RUN BOT button (persistent) ======= -->
<div class="run-fixed">
  <button id="runBotBtn" class="run-btn">▶ RUN BOT</button>
</div>
<div id="runSlide" class="slide" aria-hidden="true">
  <div class="slide-head">
    <div class="slide-title">Running Bot</div>
    <div>
      <span class="stat" id="sTicks">Ticks: 0</span>
      <span class="stat" id="sWins">Wins: 0</span>
      <span class="stat" id="sLoss">Losses: 0</span>
      <span class="stat" id="sPL">P/L: $0.00</span>
      <button id="closeSlide" class="cta" style="background:#111;border-color:#333;color:#fff">Close</button>
    </div>
  </div>
  <div class="slide-body">
    <pre id="log" class="log">Waiting to start…</pre>
  </div>
</div>

<!-- =================== SCRIPTS =================== -->
<script>
(() => {
  // ========== CONFIG ==========
  const APP_ID = 96503; // your final app id
  const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
  const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&brand=deriv&scope=read,trade`;
  const AFFIL_REDIRECT = location.href; // redirect back to same page

  // ========== HEADER actions ==========
  const signin = document.getElementById('signin');
  const dotsBtn = document.getElementById('dotsBtn');
  const dotsMenu = document.getElementById('dotsMenu');
  const signOutBtn = document.getElementById('signOut');
  const accountSettings = document.getElementById('accountSettings');
  const toggleDark = document.getElementById('toggleDark');

  // Dots menu
  dotsBtn.addEventListener('click', () => {
    const open = dotsMenu.style.display === 'block';
    dotsMenu.style.display = open ? 'none' : 'block';
    dotsBtn.setAttribute('aria-expanded', String(!open));
    dotsMenu.setAttribute('aria-hidden', String(open));
  });
  document.addEventListener('click', (e) => {
    if (!dotsMenu.contains(e.target) && e.target !== dotsBtn) dotsMenu.style.display = 'none';
  });

  // Dark mode
  const DARK_CLS = 'dark';
  toggleDark.addEventListener('click', () => {
    document.documentElement.classList.toggle(DARK_CLS);
    if (document.documentElement.classList.contains(DARK_CLS)) {
      document.body.style.background = '#0b0b0b';
      document.body.style.color = '#f5f5f5';
    } else {
      document.body.style.background = '#ffffff';
      document.body.style.color = '#111';
    }
  });

  // Account settings (open Deriv)
  accountSettings.addEventListener('click', () => {
    window.open('https://app.deriv.com/account/personal-details', '_blank', 'noopener');
  });

  // Sign out
  signOutBtn.addEventListener('click', () => {
    localStorage.removeItem('deriv_token');
    location.reload();
  });

  // Sign in / up
  signin.addEventListener('click', (e) => {
    e.preventDefault();
    location.href = OAUTH_URL + '&redirect_url=' + encodeURIComponent(AFFIL_REDIRECT);
  });

  // Hide Sign-in after authorized
  function hideSignin() { signin.style.display = 'none'; }

  // ========== TABS ==========
  const tabs = document.querySelectorAll('.tab');
  const panels = {
    dashboard: document.getElementById('dashboard'),
    botbuilder: document.getElementById('botbuilder'),
    analysis: document.getElementById('analysis'),
    signals: document.getElementById('signals'),
    dtrade: document.getElementById('dtrade'),
    chart: document.getElementById('chart'),
    strategy: document.getElementById('strategy'),
    tutorial: document.getElementById('tutorial'),
    freebots: document.getElementById('freebots')
  };
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    Object.values(panels).forEach(p => p.classList.add('hidden'));
    panels[t.dataset.tab]?.classList.remove('hidden');
  }));

  // ========== BALANCE via WS ==========
  const pill = document.getElementById('balance-pill');
  const amt = document.getElementById('balance-amount');
  const badge = document.getElementById('acc-badge');
  let ws = null;

  function getQueryParam(name){ return new URL(location.href).searchParams.get(name); }
  function saveTokenFromURL(){
    const t = getQueryParam('token1') || getQueryParam('token');
    if (t) localStorage.setItem('deriv_token', t);
    return t;
  }
  function getStoredToken(){ return localStorage.getItem('deriv_token') || ''; }
  function formatUSD(n){ return Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}); }

  function showPill(isVirtual, amount){
    pill.style.display = 'inline-flex';
    if (typeof amount==='number') amt.textContent = formatUSD(amount);
    if (typeof isVirtual!=='undefined'){
      if (isVirtual){ badge.textContent = 'D'; badge.title='Demo account'; }
      else { badge.textContent = '🇺🇸'; badge.title='Real account'; }
    }
  }
  function hidePill(){ pill.style.display='none'; }

  function connectBalance(token){
    try{ ws && ws.close(); }catch(_){}
    ws = new WebSocket(WS_URL);
    ws.onopen = () => ws.send(JSON.stringify({authorize: token}));
    ws.onmessage = (e) => {
      const m = JSON.parse(e.data);
      if (m.error){ hidePill(); return; }
      if (m.msg_type==='authorize'){
        hideSignin(); // hide sign-in once authorized
        showPill(!!m.authorize.is_virtual);
        ws.send(JSON.stringify({balance:1, subscribe:1}));
      }
      if (m.msg_type==='balance' && m.balance){
        showPill(undefined, Number(m.balance.balance));
      }
    };
  }

  // Capture token from URL and connect
  const fromURL = saveTokenFromURL();
  const token = fromURL || getStoredToken();
  if (token) connectBalance(token);

  // ========== DASHBOARD interactions ==========
  const dashCards = document.getElementById('dashCards');
  const botCanvas = document.getElementById('botCanvas');
  const localXml = document.getElementById('localXml');
  const builderXml = document.getElementById('builderXml');
  const xmlView = document.getElementById('xmlView');
  const loadDefault = document.getElementById('loadDefault');
  const quickStrat = document.getElementById('quickStrat');

  function collapseCardsAndShowBot(xml){
    dashCards.classList.add('hidden');
    botCanvas.classList.remove('hidden');
    xmlView.value = xml.trim();
    builderXml.value = xml.trim();
  }

  // Minimal sample default XML (placeholder bot XML)
  const DEFAULT_XML = `
<xml xmlns="https://developers.google.com/blockly/xml">
  <variables>
    <variable id="stake">stake</variable>
  </variables>
  <block type="trade_definition_market" id="mkt" x="20" y="20">
    <field name="MARKET_LIST">synthetic_index</field>
    <field name="SUBMARKET_LIST">random_index</field>
    <field name="SYMBOL_LIST">R_100</field>
  </block>
</xml>`.trim();

  loadDefault.addEventListener('click', () => collapseCardsAndShowBot(DEFAULT_XML));

  localXml.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const txt = await f.text();
    collapseCardsAndShowBot(txt);
    tabs.forEach(x=>x.classList.remove('active')); document.querySelector('.tab[data-tab="dashboard"]').classList.add('active');
    Object.values(panels).forEach(p=>p.classList.add('hidden')); panels.dashboard.classList.remove('hidden');
  });

  quickStrat.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active')); document.querySelector('.tab[data-tab="strategy"]').classList.add('active');
    Object.values(panels).forEach(p=>p.classList.add('hidden')); panels.strategy.classList.remove('hidden');
  });

  // Free bots → load into dashboard
  document.getElementById('botsGrid').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-bot]');
    if(!btn) return;
    const key = btn.getAttribute('data-bot');
    // In this build, we use a simple mapping to canned XML. Replace with real bot XML if needed.
    const LIB = {
      entry_touch: DEFAULT_XML,
      digit_ranger: DEFAULT_XML,
      premium_rf: DEFAULT_XML,
      rf_marble: DEFAULT_XML,
      accum_base: DEFAULT_XML,
      even_odd: DEFAULT_XML
    };
    const xml = LIB[key] || DEFAULT_XML;
    // Switch to dashboard and show bot
    tabs.forEach(x=>x.classList.remove('active')); document.querySelector('.tab[data-tab="dashboard"]').classList.add('active');
    Object.values(panels).forEach(p=>p.classList.add('hidden')); panels.dashboard.classList.remove('hidden');
    collapseCardsAndShowBot(xml);
    // Collapse the four dashboard images/cards already done by collapseCardsAndShowBot
  });

  // ========== Strategy iframe fallback ==========
  const stratFrame = document.getElementById('strategy-embed');
  const stratFallback = document.getElementById('strategy-fallback');
  const openDerivBtn = document.getElementById('open-deriv-btn');
  let loaded = false;
  const guard = setTimeout(()=>{ if(!loaded) stratFallback.classList.add('show'); }, 3000);
  stratFrame?.addEventListener('load', ()=>{ loaded=true; clearTimeout(guard); stratFallback.classList.remove('show'); });
  openDerivBtn?.addEventListener('click', ()=> window.open('https://app.deriv.com/?lang=en','_blank','noopener'));

  // ========== RUN BOT slide + dummy log (visual behavior; connect your real runner here) ==========
  const runBtn = document.getElementById('runBotBtn');
  const runSlide = document.getElementById('runSlide');
  const closeSlide = document.getElementById('closeSlide');
  const logEl = document.getElementById('log');
  const sTicks = document.getElementById('sTicks');
  const sWins  = document.getElementById('sWins');
  const sLoss  = document.getElementById('sLoss');
  const sPL    = document.getElementById('sPL');

  let ticks=0,wins=0,loss=0,pl=0, timer=null;

  function openSlide(){ runSlide.classList.add('open'); runSlide.setAttribute('aria-hidden','false'); }
  function closeSlideFn(){ runSlide.classList.remove('open'); runSlide.setAttribute('aria-hidden','true'); }

  function log(line){ logEl.textContent += `\n${line}`; logEl.scrollTop = logEl.scrollHeight; }
  function resetStats(){ ticks=0; wins=0; loss=0; pl=0; sTicks.textContent='Ticks: 0'; sWins.textContent='Wins: 0'; sLoss.textContent='Losses: 0'; sPL.textContent='P/L: $0.00'; logEl.textContent='Starting bot…'; }

  runBtn.addEventListener('click', ()=>{
    openSlide();
    resetStats();
    // Visual-only demo loop
    clearInterval(timer);
    timer = setInterval(()=>{
      ticks++; const win = Math.random()>0.45;
      if(win){ wins++; pl += 0.35; log('✔ Buy → Profit +$0.35'); }
      else { loss++; pl -= 0.35; log('✖ Buy → Loss -$0.35'); }
      sTicks.textContent = 'Ticks: '+ticks;
      sWins.textContent  = 'Wins: '+wins;
      sLoss.textContent  = 'Losses: '+loss;
      sPL.textContent    = 'P/L: ' + (pl>=0?'+':'') + '$' + pl.toFixed(2);
    }, 1200);
  });
  closeSlide.addEventListener('click', ()=>{ clearInterval(timer); closeSlideFn(); });

})();
</script>
</body>
</html>
