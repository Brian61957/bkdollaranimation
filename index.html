<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Deriv Pro Tools</title>
<link rel="preconnect" href="https://ws.derivws.com" crossorigin>
<style>
  :root{
    /* brand */
    --deriv-red:#e61e24;
    --deriv-red-dark:#c01419;
    --ink:#0b1b28;
    --ink-2:#122432;
    --ink-3:#203140;
    --muted:#748a9d;
    --line:#e8edf2;
    --chip:#f5f7fa;
    --bg:#ffffff;
    --card:#ffffff;
    --green:#16a34a;
    --green-dark:#0f8c3e;
    --green-soft:#e9f7ef;
    --blue:#2563eb;
    --blue-soft:#e9f0ff;
    --amber:#f59e0b;
  }
  [data-theme="dark"]{
    --bg:#0c141b;
    --card:#0f1b24;
    --ink:#dfe8f1;
    --ink-2:#cdd9e3;
    --ink-3:#aebdcc;
    --line:#1e2a36;
    --chip:#122231;
    --blue-soft:#0e1930;
    --green-soft:#0f2318;
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }
  a{color:var(--blue);text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:12px}
  .topbar{
    display:flex;align-items:center;gap:10px;justify-content:space-between;
    padding:10px 12px;border-bottom:1px solid var(--line);background:var(--card);position:sticky;top:0;z-index:50;
  }
  .brand{font-weight:800;font-size:20px;letter-spacing:.2px}
  .right-tools{display:flex;align-items:center;gap:8px}
  .chip-btn{border:1px solid var(--line);background:var(--chip);padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:600}
  .primary{background:var(--deriv-red);color:#fff;border:none}
  .primary:hover{background:var(--deriv-red-dark)}
  .icon-btn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:var(--card);display:grid;place-items:center;cursor:pointer}
  .dot-menu{position:relative}
  .menu{position:absolute;right:0;top:42px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;min-width:210px;display:none;box-shadow:0 10px 30px rgba(0,0,0,.14)}
  .menu a,.menu button{display:flex;align-items:center;gap:10px;width:100%;padding:10px;border-radius:10px;border:none;background:transparent;color:var(--ink);cursor:pointer}
  .menu a:hover,.menu button:hover{background:var(--chip)}
  .ticker{background:var(--deriv-red);color:#fff;padding:6px 10px;font-weight:600;text-align:center}
  .nav{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
  .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:var(--card);cursor:pointer}
  .tab.active{background:var(--chip);border-color:var(--deriv-red);box-shadow:inset 0 0 0 2px rgba(230,30,36,.1)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:18px}
  @media (max-width:700px){.grid4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .tile{display:grid;place-items:center;padding:24px;border-radius:14px;background:var(--chip);border:1px dashed var(--line);cursor:pointer}
  .tile:hover{border-color:var(--deriv-red)}
  .muted{color:var(--muted)}
  /* balance row */
  .balance-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-weight:700}
  .badge .dot{width:18px;height:18px;border-radius:9px;display:grid;place-items:center;background:var(--green);color:#fff;font-size:12px}
  .badge .flag{width:18px;height:18px;border-radius:999px;background:#0a3161;position:relative;overflow:hidden}
  .badge .flag:before{content:"";position:absolute;inset:0;background:
    linear-gradient(#b22234 50%,#fff 50%) 0 0/100% 18%,
    linear-gradient(#fff 50%,#b22234 50%) 0 100%/100% 18%,
    #0a3161;}
  .green{color:var(--green)}
  /* strategies */
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .grow{flex:1 1 260px}
  .ctrl{display:flex;gap:8px;align-items:center}
  .ctrl input,.ctrl select{padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--bg);color:var(--ink)}
  .digits{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;margin-top:10px}
  .digit{border:1px solid var(--line);border-radius:14px;padding:12px 8px;text-align:center;background:var(--card)}
  .digit strong{font-size:18px;display:block;margin-bottom:4px}
  .digit .pct{font-size:12px}
  .digit.max{box-shadow:0 0 0 2px rgba(22,163,74,.25);border-color:var(--green)}
  .digit.max .pct{color:var(--green)}
  .digit.min{box-shadow:0 0 0 2px rgba(230,30,36,.25);border-color:var(--deriv-red)}
  .digit.min .pct{color:var(--deriv-red)}
  .digit.win{animation:winflash .7s ease-in-out 2}
  .digit.lose{animation:loseflash .7s ease-in-out 2}
  @keyframes winflash{50%{background:var(--green-soft)}}
  @keyframes loseflash{50%{background:#fee2e2}}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--chip);cursor:pointer;font-weight:700}
  .pill.active{background:var(--blue-soft);border-color:var(--blue)}
  .cta-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .buy{background:var(--green);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-weight:900;cursor:pointer}
  .buy:disabled{opacity:.5;cursor:not-allowed}
  .danger{background:var(--deriv-red);color:#fff;border:none;padding:10px 14px;border-radius:10px}
  /* free bots list */
  .bots{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .bot{border:1px solid var(--line);border-radius:12px;padding:12px;background:var(--card)}
  .bot h4{margin:0 0 6px 0}
  .bot .load{margin-top:10px}
  /* dtrader/chart */
  .embedbox{position:relative;height:72vh;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#000}
  .embedbox iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
  .embedbox .fallback{position:absolute;inset:0;display:grid;place-items:center;color:#fff;text-align:center;padding:24px}
  /* run bar */
  .runbar{
    position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:2px solid var(--line);z-index:60;
    display:flex;align-items:center;gap:12px;padding:10px;
  }
  .run-btn{background:#57d26a;color:#073b16;font-weight:900;border:none;padding:12px 18px;border-radius:12px;display:flex;align-items:center;gap:8px;cursor:pointer}
  .run-btn.stop{background:#fee4e2;color:#7a0000}
  .bar{flex:1;height:32px;border-radius:10px;border:1px solid #c7defd;background:#e7f0ff;display:flex;align-items:center;padding:0 10px;font-weight:800;color:#174ea6}
  .progress{height:6px;background:#4ea1ff;margin-top:6px;border-radius:999px;width:0%}
  .risk{position:absolute;right:12px;top:-26px;background:var(--deriv-red);color:#fff;padding:6px 10px;border-radius:10px}
  .expander{position:absolute;left:50%;transform:translateX(-50%);top:-18px;background:var(--card);border:1px solid var(--line);width:36px;height:18px;border-radius:10px;display:grid;place-items:center}
  .runpanel{display:none;position:fixed;left:0;right:0;bottom:62px;background:var(--card);border-top:1px solid var(--line);padding:12px;z-index:55}
  .runpanel.open{display:block}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">Deriv Pro Tools</div>

  <div class="right-tools">
    <!-- WhatsApp / Telegram quick icons -->
    <a class="icon-btn" href="https://wa.me/000000000000" target="_blank" title="WhatsApp">
      üìû
    </a>
    <a class="icon-btn" href="https://t.me/yourgroup" target="_blank" title="Telegram">
      üí¨
    </a>

    <!-- Balance chip (hidden until auth) -->
    <div id="balanceChip" class="badge" style="display:none">
      <span id="acctKindDot" class="dot">D</span>
      <span id="balanceText" class="green">$0.00</span>
    </div>

    <!-- Sign in / up -->
    <a id="signinBtn" class="chip-btn primary" href="#">Sign in</a>
    <a id="signupBtn" class="chip-btn" href="https://app.deriv.com/signup/?platform=deriv_app&brand=deriv" target="_blank">Sign up</a>

    <!-- 3-dots menu -->
    <div class="dot-menu">
      <button id="dots" class="icon-btn" aria-label="Menu">‚ãÆ</button>
      <div id="menu" class="menu">
        <a href="#" id="toggleTheme">üåì Toggle dark mode</a>
        <a href="https://app.deriv.com/account/personal-details" target="_blank">‚öôÔ∏è Account settings</a>
        <a href="https://app.deriv.com/cashier/deposit" target="_blank">üí≥ Cashier (Deposit/Withdraw)</a>
        <button id="logoutBtn">üö™ Logout</button>
      </div>
    </div>
  </div>
</div>

<!-- RUNNING WORDS -->
<div class="ticker">üì¢ Pro-grade Deriv tools ‚Ä¢ Live ticks ‚Ä¢ Matches/Differs ‚Ä¢ Odd/Even ‚Ä¢ Over/Under ‚Ä¢ Copy Demo ‚Üí Real (optional)</div>

<!-- NAV -->
<div class="container">
  <div class="nav" id="tabs">
    <button class="tab active" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="botbuilder">Botbuilder</button>
    <button class="tab" data-tab="analysis">Analysis Tool</button>
    <button class="tab" data-tab="signals">Signals Tool</button>
    <button class="tab" data-tab="dtrader">DTrader</button>
    <button class="tab" data-tab="chart">Chart</button>
    <button class="tab" data-tab="strategies">Strategies</button>
    <button class="tab" data-tab="freebots">Free Bots</button>
    <button class="tab" data-tab="tutorial">Tutorial</button>
  </div>

  <!-- BALANCE / ACCOUNT ROW (only after auth) -->
  <div id="acctRow" class="card balance-row" style="display:none">
    <span class="badge"><span id="kindIcon" class="dot">D</span> Demo</span>
    <span id="loginid" class="muted"></span>
    <strong>‚Ä¢ Balance: <span id="bigBalance" class="green">$0.00</span></strong>
    <div style="flex:1"></div>
    <div class="ctrl">
      <label class="muted">Account:</label>
      <select id="accountSelect"></select>
      <button id="copyDemoReal" class="pill" title="When ON, mirror demo trades to your real account if available">Copy Demo ‚Üí Real</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <section id="dashboard" class="card">
    <h3 style="margin-top:0;color:var(--deriv-red)">Load or build your bot</h3>
    <p class="muted">Import a bot from your computer or Google Drive, build it from scratch, or start with a quick strategy.</p>
    <div class="grid4">
      <div class="tile" id="pickLocal">üì±<div class="muted" style="margin-top:8px">Local</div></div>
      <div class="tile" id="pickDrive">üóÇÔ∏è<div class="muted" style="margin-top:8px">Google Drive</div></div>
      <div class="tile" id="gotoBuilder">üß©<div class="muted" style="margin-top:8px">Bot builder</div></div>
      <div class="tile" id="quickStrategy">üß†<div class="muted" style="margin-top:8px">Quick strategy</div></div>
    </div>

    <input type="file" id="fileInput" accept=".xml" style="display:none" />
    <div id="loadedBotWrap" style="margin-top:16px;display:none">
      <h4>Bot loaded:</h4>
      <pre id="loadedBot" class="card" style="overflow:auto;max-height:220px"></pre>
      <div class="cta-row">
        <button class="buy" id="useThisBot">Use this bot</button>
        <button class="pill" id="clearBot">Clear</button>
      </div>
    </div>
  </section>

  <!-- BOTBUILDER (simple, editable inputs; it receives prefill from Free Bots / Dashboard) -->
  <section id="botbuilder" class="card" style="display:none">
    <h3 style="margin-top:0">Botbuilder (default quick strategy)</h3>
    <div class="row">
      <div class="grow card" style="border-style:dashed">
        <h4>1. Trade parameters</h4>
        <div class="ctrl"><label>Market:</label><select id="bbSymbol"></select></div>
        <div class="ctrl"><label>Trade Type:</label>
          <select id="bbType">
            <option value="RISEFALL">Rise/Fall (demo only here)</option>
            <option value="DIGITMATCH">Digit Match</option>
            <option value="DIGITDIFF">Digit Differs</option>
            <option value="DIGITODD">Digit Odd</option>
            <option value="DIGITEVEN">Digit Even</option>
          </select></div>
        <div class="ctrl"><label>Duration (ticks):</label><input id="bbDur" type="number" min="1" value="3" /></div>
        <div class="ctrl"><label>Stake ($):</label><input id="bbStake" type="number" min="0.35" step="0.01" value="1" /></div>
      </div>
      <div class="grow card" style="border-style:dashed">
        <h4>2. Purchase conditions</h4>
        <div class="ctrl"><label>Digit (for Match):</label>
          <select id="bbDigit"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option selected>7</option><option>8</option><option>9</option></select>
        </div>
        <div class="cta-row"><button id="bbBuy" class="buy">Run single trade</button></div>
        <div id="bbLog" class="muted" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- ANALYSIS TOOL (placeholder) -->
  <section id="analysis" class="card" style="display:none">
    <h3 style="margin-top:0">Analysis Tool</h3>
    <p class="muted">Coming next: plug-in signal engines and custom scanners.</p>
  </section>

  <!-- SIGNALS TOOL (placeholder) -->
  <section id="signals" class="card" style="display:none">
    <h3 style="margin-top:0">Signals Tool</h3>
    <p class="muted">Reserved for your Matches/Differs signal module.</p>
  </section>

  <!-- DTRADER EMBED -->
  <section id="dtrader" class="card" style="display:none">
    <h3 style="margin-top:0">DTrader</h3>
    <div class="embedbox">
      <iframe id="dtraderFrame" src="https://dtrader.deriv.com/?platform=deriv_app&app_id=96503" allow="clipboard-read; clipboard-write"></iframe>
      <div class="fallback" id="dtraderFallback" style="display:none">
        <div>
          <p>Embedding is blocked by Deriv for security.<br/>Tap below to open DTrader in a new tab.</p>
          <p><a target="_blank" class="chip-btn primary" href="https://dtrader.deriv.com/?platform=deriv_app&app_id=96503">Open DTrader</a></p>
        </div>
      </div>
    </div>
  </section>

  <!-- CHART EMBED -->
  <section id="chart" class="card" style="display:none">
    <h3 style="margin-top:0">Chart / Accumulators</h3>
    <div class="embedbox">
      <iframe id="chartFrame" src="https://app.deriv.com/charts?app_id=96503"></iframe>
      <div class="fallback" id="chartFallback" style="display:none">
        <div>
          <p>Embedding blocked. Open the official chart:</p>
          <p><a target="_blank" class="chip-btn primary" href="https://app.deriv.com/charts?app_id=96503">Open Chart</a></p>
        </div>
      </div>
    </div>
  </section>

  <!-- STRATEGIES (LIVE) -->
  <section id="strategies" class="card" style="display:none">
    <h3 style="margin-top:0">Quick strategies (Live)</h3>
    <div class="row">
      <div class="grow">
        <div class="ctrl">
          <label>Volatility:</label>
          <select id="volSelect"></select>
          <label>Duration (ticks)</label><input id="ticksInput" type="number" min="1" value="3" />
          <label>Stake ($)</label><input id="stakeInput" type="number" min="0.35" value="10" />
        </div>
        <div class="ctrl" style="margin-top:8px">
          <span class="muted">Tick:</span> <strong id="tickSpot">‚Äî</strong>
        </div>
        <div id="digitsWrap" class="digits"></div>
        <div class="cta-row">
          <button class="pill" data-mode="MATCHES" id="modeMatches">Matches</button>
          <button class="pill" data-mode="DIFFERS" id="modeDiffers">Differs</button>
          <button class="pill" data-mode="OVER" id="modeOver">Over / Under</button>
          <button class="pill active" data-mode="ODDEVEN" id="modeOddEven">Odd / Even</button>
        </div>
        <div class="cta-row">
          <button id="buyOdd" class="buy">BUY Odd</button>
          <button id="buyEven" class="buy">BUY Even</button>
        </div>
      </div>
    </div>
  </section>

  <!-- FREE BOTS -->
  <section id="freebots" class="card" style="display:none">
    <h3 style="margin-top:0">Free Bots</h3>
    <div class="bots" id="botsList"></div>
  </section>

  <!-- TUTORIAL -->
  <section id="tutorial" class="card" style="display:none">
    <h3 style="margin-top:0">Tutorial</h3>
    <ul>
      <li>Sign in, choose Demo or Real from the balance chip.</li>
      <li>Try the <strong>Strategies</strong> section (Odd/Even, Matches, Differs).</li>
      <li>Use the bottom <strong>Run Bot</strong> bar to start/stop and monitor trades.</li>
      <li>In <strong>Free Bots</strong>, click any bot to auto-load it into Dashboard & Botbuilder.</li>
    </ul>
  </section>
</div>

<!-- RUN BOT BAR -->
<div class="runpanel card" id="runPanel">
  <div><strong>Session</strong>: <span id="sessionStatus" class="muted">Idle</span></div>
  <div style="margin-top:8px">
    Runs: <strong id="runs">0</strong> ‚Ä¢ Won: <strong id="won">0</strong> ‚Ä¢ Lost: <strong id="lost">0</strong> ‚Ä¢ P/L: <strong id="pl" class="green">$0.00</strong>
    <div id="progress" class="progress"></div>
  </div>
</div>
<div class="runbar">
  <div class="expander" id="expand">‚åÉ</div>
  <div class="risk">Risk Disclaimer</div>
  <button id="runBtn" class="run-btn"><span>‚ñ∂</span> Run</button>
  <div class="bar"><span id="barText">Bot is not running</span></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const APP_ID = 96503;
const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=EN&brand=deriv`;

/* =========================
   STATE
========================= */
let ws = null;
let authorized = false;
let accounts = [];
let activeLoginId = null;
let isVirtual = true;
let copyDemoReal = false;

let tickSubId = null;
let lastTicks = []; // keep last 100 ticks
let lastDigitPercents = Array(10).fill(10); // init ~10%

let strategyMode = 'ODDEVEN'; // default

let runOpen = false;
let stats = {runs:0, won:0, lost:0, pl:0};

/* =========================
   UTIL
========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function fmt(n){ return (n<0?'-':'') + '$' + Math.abs(n).toFixed(2); }
function setBar(text){ $('#barText').textContent = text; }
function setProgress(p){ $('#progress').style.width = Math.max(0,Math.min(100,p)) + '%'; }
function setRun(open){
  runOpen = open;
  $('#runPanel').classList.toggle('open', open);
  $('#runBtn').classList.toggle('stop', open);
  $('#runBtn').innerHTML = open ? '‚èπ Stop' : '‚ñ∂ Run';
  setBar(open ? 'Bot is running‚Ä¶' : 'Bot is not running');
}

/* =========================
   THEME + MENU
========================= */
$('#dots').addEventListener('click',()=>{$('#menu').style.display = $('#menu').style.display==='block'?'none':'block';});
document.addEventListener('click',e=>{
  if(!e.target.closest('.dot-menu')) $('#menu').style.display='none';
});
$('#toggleTheme').addEventListener('click',()=>{
  document.documentElement.dataset.theme = document.documentElement.dataset.theme==='dark' ? '' : 'dark';
});

/* =========================
   NAV
========================= */
$('#tabs').addEventListener('click', e=>{
  const b = e.target.closest('.tab'); if(!b) return;
  $$('.tab').forEach(t=>t.classList.toggle('active', t===b));
  const id = b.dataset.tab;
  ['dashboard','botbuilder','analysis','signals','dtrader','chart','strategies','freebots','tutorial'].forEach(s=>{
    document.getElementById(s).style.display = (s===id)?'block':'none';
  });
});

/* =========================
   AUTH / WS
========================= */
function connect(){
  ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
  ws.onmessage = onMsg;
}
connect();

function send(o){ ws && ws.readyState===1 && ws.send(JSON.stringify(o)); }

function onMsg(ev){
  const m = JSON.parse(ev.data);
  if(m.msg_type==='authorize'){
    authorized = true;
    accounts = m.authorize.account_list || [];
    activeLoginId = m.authorize.loginid;
    isVirtual = m.authorize.is_virtual;
    $('#signinBtn').style.display='none';
    $('#signupBtn').style.display='none';
    $('#acctRow').style.display='flex';
    $('#balanceChip').style.display='inline-flex';
    updateAcctBadge();
    // subscribe balance
    send({balance:1, subscribe:1});
    fillAccounts();
  }
  if(m.msg_type==='balance'){
    const b = m.balance;
    const usd = b.balance || 0;
    $('#balanceText').textContent = '$' + usd.toFixed(2);
    $('#bigBalance').textContent = '$' + usd.toFixed(2);
  }
  if(m.msg_type==='ticks'){
    const price = Number(m.tick.quote);
    $('#tickSpot').textContent = price.toFixed(5);
    const lastDigit = (''+Math.round(price*100000)).slice(-1)*1;
    lastTicks.unshift(lastDigit);
    if(lastTicks.length>100) lastTicks.length=100;
    recomputePercents();
    colorDigits(); // renew min/max
  }
  if(m.msg_type==='proposal'){
    // got proposal, proceed to buy
    if(m.proposal && m.proposal.id){
      send({buy: m.proposal.id, price: m.proposal.ask_price});
    }
  }
  if(m.msg_type==='buy'){
    stats.runs++; $('#runs').textContent = stats.runs;
    setBar('Contract bought. Monitoring‚Ä¶'); setRun(true);
    send({proposal_open_contract:1, contract_id: m.buy.contract_id, subscribe:1});
  }
  if(m.msg_type==='proposal_open_contract'){
    const poc = m.proposal_open_contract;
    // progress approx by current tick / duration
    if(poc.current_spot && poc.entry_spot && poc.tick_count){
      const done = (poc.tick_count || 0)/(poc.contract_duration || 1);
      setProgress(done*100);
    }
    if(poc.is_sold){
      setProgress(100);
      const profit = Number(poc.profit) || 0;
      stats.pl += profit;
      $('#pl').textContent = fmt(stats.pl);
      if(profit>0){ stats.won++; $('#won').textContent = stats.won; }
      else { stats.lost++; $('#lost').textContent = stats.lost; }
      setBar(profit>=0 ? `Settled: +${profit.toFixed(2)}` : `Settled: ${profit.toFixed(2)}`);
      setTimeout(()=>setRun(false), 1200);
      // flash digit result for Match
      if(poc.contract_type==='DIGITMATCH'){
        const last = (''+Math.round(Number(poc.exit_spot)*100000)).slice(-1)*1;
        const dEl = document.querySelector(`[data-digit="${last}"]`);
        if(dEl) dEl.classList.add(profit>0?'win':'lose'), setTimeout(()=>dEl.classList.remove('win','lose'),800);
      }
    }
  }
  // iframe blockers:
  if(m.msg_type==='website_status'){
    // no-op
  }
}

/* OAuth parse */
(function handleOAuth(){
  const p = new URLSearchParams(location.search);
  if(p.has('code')){
    const code = p.get('code');
    connect();
    ws.addEventListener('open', ()=> send({authorize: code}), {once:true});
    // Remove code from URL to keep things clean
    history.replaceState({}, '', location.pathname);
  }
})();

/* Sign in/out */
$('#signinBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  location.href = OAUTH_URL + '&scope=read,trade';
});
$('#logoutBtn').addEventListener('click', ()=>{
  authorized=false;
  accounts=[]; activeLoginId=null;
  $('#acctRow').style.display='none';
  $('#balanceChip').style.display='none';
  $('#signinBtn').style.display='inline-block';
  $('#signupBtn').style.display='inline-block';
  setBar('Bot is not running');
});

/* =========================
   BALANCE / ACCOUNT
========================= */
function fillAccounts(){
  const sel = $('#accountSelect');
  sel.innerHTML = '';
  accounts.forEach(a=>{
    const opt = document.createElement('option');
    opt.value = a.loginid;
    opt.textContent = `${a.loginid} ${a.is_virtual?'(Demo)':'(Real)'}`;
    if(a.loginid===activeLoginId) opt.selected = true;
    sel.appendChild(opt);
  });
}
$('#accountSelect').addEventListener('change', ()=>{
  const id = $('#accountSelect').value;
  const acc = accounts.find(x=>x.loginid===id);
  if(!acc) return;
  // Switch account requires a new authorize token; when using OAuth, user must re-login.
  alert('To switch account in this demo, sign out then sign in with the desired account.');
});
$('#copyDemoReal').addEventListener('click', ()=>{
  copyDemoReal = !copyDemoReal;
  $('#copyDemoReal').classList.toggle('active', copyDemoReal);
});

function updateAcctBadge(){
  $('#loginid').textContent = activeLoginId || '';
  const d = isVirtual;
  $('#kindIcon').textContent = d ? 'D' : 'üá∫üá∏';
  $('#acctKindDot').textContent = d ? 'D' : 'üá∫üá∏';
}

/* =========================
   SYMBOLS (Volatilities)
========================= */
const VOLATILITIES = [
 'R_10','R_10_1S','R_25','R_25_1S','R_30','R_30_1S','R_50','R_50_1S','R_75','R_75_1S','R_100','R_100_1S'
];
function fillSymbols(){
  const v1 = $('#volSelect'), v2 = $('#bbSymbol');
  VOLATILITIES.forEach(s=>{
    const label = s.replace('R_','Volatility ').replace('_1S',' (1s)');
    const o1 = new Option(label, s), o2 = new Option(label, s);
    v1.add(o1); v2.add(o2);
  });
  v1.value='R_30_1S'; v2.value='R_30_1S';
}
fillSymbols();

/* =========================
   LIVE TICKS
========================= */
function subscribeTicks(symbol){
  if(tickSubId){ send({forget: tickSubId}); tickSubId=null; }
  lastTicks.length = 0; recomputePercents(); renderDigits();
  send({ticks: symbol, subscribe:1});
}
$('#volSelect').addEventListener('change', e=> subscribeTicks(e.target.value));
subscribeTicks($('#volSelect').value);

/* =========================
   DIGIT PANEL
========================= */
function recomputePercents(){
  const counts = Array(10).fill(0);
  lastTicks.forEach(d=>counts[d]++);
  const N = Math.max(1,lastTicks.length);
  lastDigitPercents = counts.map(c=> (c/N)*100 );
}
function renderDigits(){
  const wrap = $('#digitsWrap'); wrap.innerHTML='';
  for(let d=0; d<=9; d++){
    const el = document.createElement('div');
    el.className = 'digit'; el.dataset.digit = d;
    el.innerHTML = `<strong>${d}</strong><span class="pct">10.0%</span>`;
    wrap.appendChild(el);
  }
  colorDigits();
}
function colorDigits(){
  const per = lastDigitPercents;
  let maxI = 0, minI = 0;
  for(let i=0;i<10;i++){ if(per[i]>per[maxI]) maxI=i; if(per[i]<per[minI]) minI=i; }
  $$('.digit').forEach((el,i)=>{
    el.classList.remove('max','min');
    el.querySelector('.pct').textContent = per[i].toFixed(1)+'%';
    if(i===maxI) el.classList.add('max');
    if(i===minI) el.classList.add('min');
  });
}
renderDigits();

/* =========================
   STRATEGY MODE + TRADING
========================= */
function setMode(m){
  strategyMode = m;
  $$('.cta-row .pill').forEach(p=>p.classList.toggle('active', p.dataset.mode===m));
}
$('#modeMatches').onclick = ()=> setMode('MATCHES');
$('#modeDiffers').onclick = ()=> setMode('DIFFERS');
$('#modeOver').onclick    = ()=> setMode('OVER');   // (placeholder buy)
$('#modeOddEven').onclick = ()=> setMode('ODDEVEN');

async function placeDigitTrade(kind){
  if(!authorized){ alert('Sign in first'); return; }
  const symbol = $('#volSelect').value;
  const dur = Math.max(1, parseInt($('#ticksInput').value||'3',10));
  const stake = Math.max(0.35, Number($('#stakeInput').value||'1'));
  let contract_type = '';
  if(strategyMode==='ODDEVEN') contract_type = (kind==='ODD')?'DIGITODD':'DIGITEVEN';
  if(strategyMode==='MATCHES') contract_type = 'DIGITMATCH';
  if(strategyMode==='DIFFERS') contract_type = 'DIGITDIFF';
  if(!contract_type){ alert('Unsupported mode'); return; }

  const req = {
    proposal:1, amount: stake, basis:'stake',
    contract_type, currency:'USD', duration: dur, duration_unit:'t', symbol
  };
  if(contract_type==='DIGITMATCH'){
    // pick the digit with lowest occurrence (min) ‚Äî or change as you wish
    const minIndex = lastDigitPercents.indexOf(Math.min(...lastDigitPercents));
    req.barrier = String(minIndex);
  }
  send(req);
}
$('#buyOdd').onclick  = ()=> placeDigitTrade('ODD');
$('#buyEven').onclick = ()=> placeDigitTrade('EVEN');

/* =========================
   RUN BAR
========================= */
$('#expand').addEventListener('click', ()=> setRun(!runOpen));
$('#runBtn').addEventListener('click', ()=> setRun(!runOpen));

/* =========================
   DASHBOARD actions
========================= */
$('#pickLocal').onclick = ()=> $('#fileInput').click();
$('#fileInput').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const txt = await file.text();
  $('#loadedBot').textContent = txt;
  $('#loadedBotWrap').style.display='block';
});
$('#clearBot').onclick = ()=>{
  $('#loadedBotWrap').style.display='none';
  $('#loadedBot').textContent='';
};
$('#useThisBot').onclick = ()=>{
  alert('Bot moved to Botbuilder (parameters pre-filled).');
  document.querySelector(`[data-tab="botbuilder"]`).click();
};
$('#gotoBuilder').onclick = ()=> document.querySelector(`[data-tab="botbuilder"]`).click();
$('#quickStrategy').onclick = ()=> document.querySelector(`[data-tab="strategies"]`).click();
$('#pickDrive').onclick = ()=> alert('Connect Google Drive picker in a later step.');

/* =========================
   BOTBUILDER quick hook
========================= */
$('#bbBuy').addEventListener('click', ()=>{
  const s = $('#bbSymbol').value;
  const dur = parseInt($('#bbDur').value||'3',10);
  const stake = Number($('#bbStake').value||'1');
  const type = $('#bbType').value;
  const d = $('#bbDigit').value;
  const req = {proposal:1, amount:stake, basis:'stake', contract_type:type, currency:'USD', duration:dur, duration_unit:'t', symbol:s};
  if(type==='DIGITMATCH') req.barrier = d;
  send(req);
  $('#bbLog').textContent = `Requested ${type} on ${s}, ${dur}t, $${stake}` + (req.barrier?`, digit ${req.barrier}`:'');
});

/* =========================
   FREE BOTS (7 slots)
========================= */
const FREE_BOTS = [
  {name:'Entry Touch (Default)', id:'entry-touch', note:'Digit entry touch style'},
  {name:'Digit Ranger Auto', id:'digit-ranger', note:'Digits ranger'},
  {name:'Rise/Fall Premium', id:'rf-premium', note:'Rise/Fall'},
  {name:'RF Marble', id:'rf-marble', note:'Rise/Fall variant'},
  {name:'Accumulator Helper', id:'acc-helper', note:'Support tool'},
  {name:'Vol Spike Hunter', id:'spike-hunter', note:'Experimental'},
  {name:'Safe Martingale', id:'safe-marti', note:'Use with care'}
];
function drawBots(){
  const wrap = $('#botsList'); wrap.innerHTML='';
  FREE_BOTS.forEach(b=>{
    const el = document.createElement('div');
    el.className='bot';
    el.innerHTML = `<h4>${b.name}</h4><div class="muted">${b.note}</div>
      <button class="pill load" data-id="${b.id}">Load to Dashboard</button>`;
    wrap.appendChild(el);
  });
  wrap.addEventListener('click', e=>{
    const btn = e.target.closest('.load'); if(!btn) return;
    alert(`${btn.dataset.id} loaded into Dashboard + Botbuilder.`);
    document.querySelector(`[data-tab="dashboard"]`).click();
    // simulate collapse of images by showing "loaded bot" panel:
    $('#loadedBotWrap').style.display='block';
    $('#loadedBot').textContent = `<!-- ${btn.dataset.id} -->\n<xml>‚Ä¶bot content‚Ä¶</xml>`;
  }, {once:true});
}
drawBots();

/* =========================
   IFRAMES fallback (X-Frame)
========================= */
function checkIframe(id, fb){
  const frame = $(id);
  let timed = setTimeout(()=> $(fb).style.display='grid', 2500);
  frame.addEventListener('load', ()=> { clearTimeout(timed); /* if blocked, timeout shows fallback */ });
}
checkIframe('#dtraderFrame','#dtraderFallback');
checkIframe('#chartFrame','#chartFallback');
</script>
</body>
</html>
