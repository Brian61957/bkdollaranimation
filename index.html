<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deriv Pro Suite — Dashboard</title>
<link rel="preconnect" href="https://static.deriv.com">
<link rel="preconnect" href="https://app.deriv.com">
<style>
  :root{
    --brand-red:#e31237;
    --brand-dark:#111;
    --brand-black:#000;
    --brand-white:#fff;
    --ok:#11a36a;
    --bad:#e53935;
    --muted:#6b7280;
    --bar:#0a0a0a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:#ffffff;color:#111;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:0 12px}
  /* TOP HEADER */
  .topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #eee}
  .toprow{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:10px 0}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
  .brand .dotmenu{margin-left:6px}
  .brand .logo-dot{width:10px;height:10px;border-radius:50%;background:var(--brand-red);display:inline-block}
  .auth{display:flex;align-items:center;gap:10px}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #eee;border-radius:999px;padding:6px 10px; background:#fafafa}
  .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:8px 12px;border:1px solid #e5e7eb;background:#fff;font-weight:600;cursor:pointer}
  .btn.red{background:var(--brand-red);border-color:var(--brand-red);color:#fff}
  .btn.black{background:#111;color:#fff;border-color:#111}
  .btn.ghost{background:#fff;border-color:#ddd}
  .btn.small{padding:6px 10px;font-size:.9rem}
  .badge{display:inline-flex;align-items:center;gap:6px;font-weight:700}
  .balance{display:flex;align-items:center;gap:8px}
  .balance .chip{display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px}
  .balance .chip.hidden{display:none}
  .balance .amt{font-weight:800;color:#0c7c3a}
  .icon{width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;border-radius:3px;font-size:.7rem;font-weight:800}
  .icon.D{background:#0ea5e9;color:#fff}
  .icon.R{background:#111;color:#fff}
  .menu{position:relative}
  .menu .menu-btn{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
  .menu-drop{position:absolute;right:0;top:110%;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);min-width:220px;display:none;overflow:hidden}
  .menu-drop a,.menu-drop button{display:flex;width:100%;padding:10px 12px;border:0;background:#fff;cursor:pointer;align-items:center;gap:8px}
  .menu-drop a:hover,.menu-drop button:hover{background:#f9fafb}
  .menu.open .menu-drop{display:block}
  .links{display:flex;align-items:center;gap:8px}
  .links .circle{width:36px;height:36px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #eee}
  .ticker{background:#fff;border-top:1px solid #eee;border-bottom:1px solid #eee}
  .ticker-inner{overflow:hidden;white-space:nowrap;padding:8px 0;color:#111;font-weight:600}
  .ticker-inner .track{display:inline-block; animation:move 20s linear infinite}
  @keyframes move{from{transform:translateX(0)}to{transform:translateX(-50%)}}
  /* NAV */
  .nav{background:var(--brand-black);color:#fff;border-bottom:2px solid #000;position:sticky;top:64px;z-index:40}
  .nav .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;padding:6px 0}
  .nav .tab{color:#fff;border:1px solid #222;background:#0b0b0b;padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
  .nav .tab.active{background:var(--brand-red);border-color:var(--brand-red)}
  /* SECTIONS */
  section{display:none;padding:18px 0 40px}
  section.active{display:block}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  .card{border:1px solid #eee;border-radius:14px;overflow:hidden;background:#fff}
  .card .img{height:120px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:800;color:#9ca3af}
  .card .body{padding:12px}
  .note{padding:10px 12px;border:1px dashed #ddd;border-radius:12px;background:#fcfcfd;color:#374151}
  /* STRATEGY PANEL */
  .digits{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:10px}
  .digit{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff;position:relative}
  .digit .n{font-weight:900;font-size:18px}
  .digit .pct{font-size:.8rem;color:#6b7280}
  .digit.least{outline:2px solid var(--bad)}
  .digit.most{outline:2px solid var(--ok)}
  .marker{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .marker .dot{width:16px;height:16px;border-radius:999px;box-shadow:0 0 0 4px rgba(16,185,129,.25);background:#10b981;opacity:.0;transform:scale(.7);transition:all .15s linear}
  .digit.hit .marker .dot{opacity:1;transform:scale(1)}
  .digit.miss{animation:missflash .4s}
  @keyframes missflash{from{box-shadow:0 0 0 0 rgba(229,57,53,.6)}to{box-shadow:0 0 0 10px rgba(229,57,53,0)}}
  .trail{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
  .trail .t{width:18px;height:18px;border-radius:4px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:800;color:#333}
  .trail .t.current{background:#10b981;color:#fff}
  .trail .t.prev{opacity:.7}
  .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .select, select, input[type=number]{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-weight:600;background:#fff}
  .switch{border:1px solid #e5e7eb;border-radius:999px;padding:4px;display:inline-flex;gap:4px}
  .switch .s{padding:6px 10px;border-radius:999px;cursor:pointer}
  .switch .s.active{background:#111;color:#fff}
  /* RUN BOT TRAY */
  .runbar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;z-index:60}
  .runbar .wrap{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 0}
  .runbtn{display:flex;align-items:center;gap:10px;background:var(--brand-red);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
  .tray{position:fixed;left:0;right:0;bottom:-320px;background:#fff;border-top:2px solid #111;box-shadow:0 -20px 40px rgba(0,0,0,.12);transition:bottom .25s ease;z-index:55}
  .tray.open{bottom:56px}
  .stats{display:flex;gap:10px;flex-wrap:wrap}
  .stat{border:1px solid #eee;border-radius:12px;padding:10px 12px;background:#fafafa}
  .stat .v{font-weight:900}
  .pl.plus{color:#10b981}
  .pl.minus{color:#e53935}
  /* RESPONSIVE */
  @media (max-width:900px){
    .grid-4{grid-template-columns:repeat(2,1fr)}
    .nav .row{gap:4px}
    .nav .tab{padding:6px 8px;font-size:.9rem}
  }
  @media (max-width:600px){
    .grid-4{grid-template-columns:1fr}
    .toprow{flex-wrap:wrap;gap:8px}
    .balance{order:3;width:100%;justify-content:flex-start}
    .links{order:2}
  }
</style>
</head>
<body>
  <header class="topbar">
    <div class="wrap toprow">
      <div class="brand">
        <span class="logo-dot"></span>
        <div>Deriv Pro Suite</div>
        <div class="menu" id="kebab">
          <button class="menu-btn" aria-label="menu" onclick="toggleMenu()">&#8942;</button>
          <div class="menu-drop" id="menuDrop">
            <button onclick="openSettings()">Account settings</button>
            <a id="cashierLink" target="_blank" href="https://app.deriv.com/cashier/deposit">Cashier (Deposit/Withdraw)</a>
            <button onclick="logout()">Logout</button>
            <div style="border-top:1px solid #eee"></div>
            <button onclick="toggleTheme()">Toggle Dark Mode</button>
          </div>
        </div>
      </div>

      <div class="links">
        <a class="circle" title="WhatsApp" target="_blank" href="https://chat.whatsapp.com/I9pHdE0sNuTJbKMzgJ84GD?mode=ac_t">WA</a>
        <a class="circle" title="Telegram" target="_blank" href="https://t.me/+BsA8dvAh_lA2YzRk">TG</a>
      </div>

      <div class="auth">
        <div class="balance" id="balanceBox" style="display:none">
          <div class="chip" id="acctChip">
            <span id="acctIcon" class="icon D">D</span>
            <select id="acctSwitch" class="select small" title="Account">
              <option value="demo">Demo</option>
              <option value="real">Real</option>
            </select>
          </div>
          <div class="chip">
            <span>Balance:</span>
            <span class="amt" id="balanceAmt">$0.00</span>
          </div>
        </div>
        <div id="authBtns">
          <a class="btn ghost small" id="signinBtn" href="#">Sign in</a>
          <a class="btn red small" id="signupBtn" target="_blank" href="https://deriv.com/signup/?t=96503">Sign up</a>
        </div>
      </div>
    </div>
  </header>

  <div class="ticker">
    <div class="wrap ticker-inner">
      <div class="track">
        ⚡ Trade smart — Analyze, build bots, run and track P/L live. &nbsp;&nbsp; • &nbsp;&nbsp;
        Matches/Differs — Even/Odd — Over/Under — Volatilities 10–100 (1s). &nbsp;&nbsp; • &nbsp;&nbsp;
        Copy Demo to Real (optional). &nbsp;&nbsp; • &nbsp;&nbsp;
        Always manage risk. Never overexpose capital.
        &nbsp;&nbsp; • &nbsp;&nbsp; App ID: 96503
      </div>
    </div>
  </div>

  <nav class="nav">
    <div class="wrap row" id="tabsRow">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="botbuilder">BotBuilder</button>
      <button class="tab" data-tab="analysis">Analysis Tool</button>
      <button class="tab" data-tab="signals">Signal Tool</button>
      <button class="tab" data-tab="dtrade">DTrade</button>
      <button class="tab" data-tab="chart">Chart</button>
      <button class="tab" data-tab="strategy">Strategy</button>
      <button class="tab" data-tab="tutorial">Tutorial</button>
    </div>
  </nav>

  <main class="wrap">
    <!-- DASHBOARD -->
    <section id="dashboard" class="active">
      <div class="grid-4">
        <div class="card" onclick="openLocalUpload()">
          <div class="img">LOCAL UPLOAD</div>
          <div class="body">
            <div class="note">Upload a .xml binary bot from your device. The dashboard collapses to show it ready to feed & run.</div>
          </div>
        </div>
        <div class="card" onclick="openDrive()">
          <div class="img">GOOGLE DRIVE</div>
          <div class="body">
            <div class="note">Import a bot from Google Drive.</div>
          </div>
        </div>
        <div class="card" onclick="navigate('botbuilder')">
          <div class="img">BOT BUILDER</div>
          <div class="body">
            <div class="note">Build or edit bots with Deriv’s panel.</div>
          </div>
        </div>
        <div class="card" onclick="quickStrategy()">
          <div class="img">QUICK STRATEGY</div>
          <div class="body">
            <div class="note">Start with popular presets. You can still tweak before running.</div>
          </div>
        </div>
      </div>
      <div id="uploadHost" style="margin-top:16px"></div>
    </section>

    <!-- BOTBUILDER -->
    <section id="botbuilder">
      <div class="note">Attempting to embed Deriv Bot Builder. If you see a blank panel due to browser blocking, use the button below to open it directly.</div>
      <div style="height:520px;border:1px solid #eee;border-radius:12px;overflow:hidden;margin:12px 0">
        <iframe src="https://bot.deriv.com/" title="Deriv Bot" style="border:0;width:100%;height:100%"></iframe>
      </div>
      <a class="btn red" target="_blank" href="https://bot.deriv.com/">Open Bot Builder in new tab</a>
    </section>

    <!-- PLACEHOLDERS -->
    <section id="analysis">
      <div class="note">Analysis Tool will be linked here.</div>
    </section>
    <section id="signals">
      <div class="note">Signal Tool will be linked here.</div>
    </section>

    <!-- DTRADE -->
    <section id="dtrade">
      <div class="note">DTrader embed. If blocked, click “Open DTrader”.</div>
      <div style="height:560px;border:1px solid #eee;border-radius:12px;overflow:hidden;margin:12px 0">
        <iframe src="https://app.deriv.com/deriv" title="DTrader" style="border:0;width:100%;height:100%"></iframe>
      </div>
      <a class="btn red" target="_blank" href="https://app.deriv.com/deriv">Open DTrader in new tab</a>
    </section>

    <!-- CHART -->
    <section id="chart">
      <div class="note">SmartTrader/Chart embed. If blocked, click “Open Chart”.</div>
      <div style="height:560px;border:1px solid #eee;border-radius:12px;overflow:hidden;margin:12px 0">
        <iframe src="https://app.deriv.com/tnc" title="Chart" style="border:0;width:100%;height:100%"></iframe>
      </div>
      <a class="btn red" target="_blank" href="https://app.deriv.com/tnc">Open Chart in new tab</a>
    </section>

    <!-- STRATEGY -->
    <section id="strategy">
      <div class="flex" style="margin-bottom:8px">
        <select id="symbolSel">
          <option value="R_10">Volatility 10 Index</option>
          <option value="R_10_1HZ">Volatility 10 (1s) Index</option>
          <option value="R_25">Volatility 25 Index</option>
          <option value="R_25_1HZ">Volatility 25 (1s) Index</option>
          <option value="R_30">Volatility 30 Index</option>
          <option value="R_30_1HZ">Volatility 30 (1s) Index</option>
          <option value="R_50">Volatility 50 Index</option>
          <option value="R_50_1HZ">Volatility 50 (1s) Index</option>
          <option value="R_75">Volatility 75 Index</option>
          <option value="R_75_1HZ">Volatility 75 (1s) Index</option>
          <option value="R_100">Volatility 100 Index</option>
          <option value="R_100_1HZ">Volatility 100 (1s) Index</option>
        </select>

        <div class="switch" id="modeSwitch">
          <div class="s active" data-mode="matches">Matches</div>
          <div class="s" data-mode="differs">Differs</div>
          <div class="s" data-mode="even">Even</div>
          <div class="s" data-mode="odd">Odd</div>
          <div class="s" data-mode="over">Over</div>
          <div class="s" data-mode="under">Under</div>
        </div>

        <label>Digit: <input id="digitInput" type="number" min="0" max="9" value="9" class="select" style="width:70px"></label>
        <label>Ticks: <input id="tickCount" type="number" min="1" max="10" value="3" class="select" style="width:70px"></label>

        <button class="btn black" onclick="startStrategy()">Start</button>
        <button class="btn ghost" onclick="resetStrategy()">Reset</button>
      </div>

      <div class="digits" id="digitsGrid"></div>

      <div class="trail" id="trail"></div>
      <div class="note" id="strategyNote" style="margin-top:10px">Waiting for ticks…</div>
    </section>

    <!-- TUTORIAL -->
    <section id="tutorial">
      <div class="note">Tutorials and safety tips will appear here.</div>
    </section>
  </main>

  <!-- RUN BOT BAR -->
  <div class="runbar">
    <div class="wrap">
      <div class="badge">
        <button class="runbtn" onclick="toggleTray()">▶ Run Bot</button>
        <div class="stat">Runs: <span class="v" id="runsV">0</span></div>
        <div class="stat">Wins: <span class="v" id="winsV">0</span></div>
        <div class="stat">Losses: <span class="v" id="lossesV">0</span></div>
        <div class="stat">P/L: <span class="v pl" id="plV">$0.00</span></div>
      </div>
    </div>
  </div>

  <div class="tray" id="tray">
    <div class="wrap" style="padding:14px 0">
      <div class="stats">
        <div class="stat">Last stake: <span class="v" id="stakeV">$0.00</span></div>
        <div class="stat">Last result: <span class="v" id="lastRes">—</span></div>
        <div class="stat">Last digit: <span class="v" id="lastDigit">—</span></div>
      </div>
      <div class="note" style="margin-top:10px">
        Bot purchases are disabled by default for safety. After logging in, enable purchases in settings (⋮) if you want the bot to place real orders.
      </div>
    </div>
  </div>

<script>
const APP_ID = 96503;
const OAUTH = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=EN&brand=deriv`;
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>document.querySelectorAll(q);
function fmt(n){return (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2})}
function toggleMenu(){ $('#kebab').classList.toggle('open'); }
function navigate(id){$$('nav .tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));$$('main section').forEach(s=>s.classList.toggle('active', s.id===id));}
$('#tabsRow').addEventListener('click',e=>{ const b=e.target.closest('.tab'); if(!b) return; navigate(b.dataset.tab); });
function toggleTheme(){document.documentElement.classList.toggle('dark');if(document.documentElement.classList.contains('dark')){document.body.style.background='#0a0a0a';document.body.style.color='#f5f5f5';}else{document.body.style.background='#fff';document.body.style.color='#111';}}
function openSettings(){alert('Settings panel coming soon. Enable purchases here later.');}
function openLocalUpload(){alert('Upload flow coming next. For now, use Bot Builder or Quick Strategy.');}
function openDrive(){alert('Google Drive picker to be added.');}
function quickStrategy(){navigate('strategy');}

let ws, token=null, loginid=null, is_demo=true, currency='USD';
let last_pl = 0, runs=0, wins=0, losses=0;
function wsSend(o){ ws && ws.readyState===1 && ws.send(JSON.stringify(o)); }
function connectWS(){
  ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
  ws.onopen = ()=>{ if(token) wsSend({authorize: token}); };
  ws.onmessage = (msg)=>{
    const r = JSON.parse(msg.data);
    if(r.msg_type==='authorize'){
      loginid = r.authorize.loginid;
      currency = r.authorize.currency || 'USD';
      $('#authBtns').style.display='none';
      $('#balanceBox').style.display='flex';
      $('#acctSwitch').value = (loginid||'').startsWith('CR')?'real':'demo';
      $('#acctIcon').className = 'icon '+($('#acctSwitch').value==='demo'?'D':'R');
      is_demo = $('#acctSwitch').value==='demo';
      fetchBalance();
      subscribeTicks(); 
    }
    if(r.msg_type==='balance'){
      const b = r.balance;
      $('#balanceAmt').textContent = fmt(b.balance);
    }
    if(r.msg_type==='error'){ console.warn(r.error); }
  };
  ws.onclose = ()=>setTimeout(connectWS, 1200);
}
function fetchBalance(){ wsSend({balance:1, account:'current'}); }
function logout(){ localStorage.removeItem('deriv_token'); token=null; loginid=null; location.href=location.pathname; }
function startOAuth(){ window.location.href = OAUTH; }
function readTokenFromURL(){
  const u = new URL(location.href);
  const t = u.searchParams.get('token1') || u.searchParams.get('token') || null;
  if(t){ localStorage.setItem('deriv_token', t); token=t; }
}
function initAuthUI(){
  readTokenFromURL();
  token = token || localStorage.getItem('deriv_token');
  if(token){ $('#authBtns').style.display='none'; $('#balanceBox').style.display='flex'; }
  else{ $('#signinBtn').addEventListener('click', (e)=>{e.preventDefault();startOAuth();}); }
}
$('#acctSwitch').addEventListener('change', ()=>{
  const v = $('#acctSwitch').value;
  is_demo = (v==='demo');
  $('#acctIcon').className = 'icon '+(is_demo?'D':'R');
  fetchBalance();
});

const digitsData = Array.from({length:10}, (_,d)=>({d, count:0}));
let tickTrail=[];
let mode='matches', targetDigit=9, needTicks=3, gotTicks=0;
let streamId=null, currentSymbol='R_100';

function buildDigits(){
  const host = $('#digitsGrid'); host.innerHTML='';
  digitsData.forEach(({d})=>{
    const el = document.createElement('div'); el.className='digit'; el.id='digit-'+d;
    el.innerHTML=`<div class="marker"><div class="dot"></div></div>
      <div class="n">${d}</div>
      <div class="pct" id="pct-${d}">0%</div>`;
    host.appendChild(el);
  });
}
function updateDigitStyles(){
  const total = digitsData.reduce((a,b)=>a+b.count,0);
  let most=-1, least=-1, mv=-1, lv=1e9;
  digitsData.forEach(o=>{ if(o.count>mv){mv=o.count;most=o.d} if(o.count<lv){lv=o.count;least=o.d} });
  digitsData.forEach(o=>{
    const el = $('#digit-'+o.d);
    el.classList.remove('most','least');
    if(o.d===most) el.classList.add('most');
    if(o.d===least) el.classList.add('least');
    $('#pct-'+o.d).textContent = total? Math.round((o.count*100)/total)+'%':'0%';
  });
}
function flashDigit(d, hit){
  const el = $('#digit-'+d);
  el.classList.remove('hit','miss'); void el.offsetWidth;
  if(hit){ el.classList.add('hit'); } else { el.classList.add('miss'); }
  setTimeout(()=>{el.classList.remove('hit','miss');}, 350);
}
function pushTrail(d){
  tickTrail.unshift(d);
  if(tickTrail.length>6) tickTrail.pop();
  const tHost = $('#trail'); tHost.innerHTML='';
  tickTrail.forEach((v,i)=>{
    const s = document.createElement('div'); s.className='t '+(i===0?'current':'prev'); s.textContent=String(v);
    tHost.appendChild(s);
  });
}
function startStrategy(){
  mode = $('#modeSwitch .s.active').dataset.mode;
  targetDigit = Math.min(9, Math.max(0, parseInt($('#digitInput').value||'9',10)));
  needTicks = Math.min(10, Math.max(1, parseInt($('#tickCount').value||'3',10)));
  gotTicks = 0;
  $('#strategyNote').textContent = 'Running…';
}
function resetStrategy(){
  digitsData.forEach(o=>o.count=0); updateDigitStyles();
  tickTrail=[]; $('#trail').innerHTML='';
  gotTicks=0; $('#strategyNote').textContent = 'Waiting for ticks…';
  $$('.digit').forEach(el=>el.classList.remove('hit','miss'));
}
$('#modeSwitch').addEventListener('click', (e)=>{
  const s=e.target.closest('.s'); if(!s) return;
  $$('#modeSwitch .s').forEach(x=>x.classList.remove('active'));
  s.classList.add('active'); mode=s.dataset.mode;
});
$('#symbolSel').addEventListener('change', ()=>{
  currentSymbol = $('#symbolSel').value;
  subscribeTicks(true);
});

function subscribeTicks(restart=false){
  if(!ws) return;
  if(streamId){ wsSend({forget: streamId}); streamId=null; }
  wsSend({ticks: currentSymbol, subscribe:1});
}
function handleTick(q){
  const price = Number(q.quote);
  const d = Math.abs(Math.floor(price*10)%10);
  digitsData[d].count++;
  updateDigitStyles();
  flashDigit(d, checkHit(d));
  pushTrail(d);
  $('#lastDigit').textContent = d;

  if(gotTicks<needTicks) gotTicks++;
  if(gotTicks===needTicks){
    runs++; $('#runsV').textContent=runs;
    const hit = checkHit(d);
    if(hit){ wins++; $('#winsV').textContent=wins; last_pl+=1; }
    else{ losses++; $('#lossesV').textContent=losses; last_pl-=1; }
    updatePL();
    gotTicks=0;
  }
}
function checkHit(d){
  if(mode==='matches') return d===targetDigit;
  if(mode==='differs') return d!==targetDigit;
  if(mode==='even') return d%2===0;
  if(mode==='odd') return d%2===1;
  if(mode==='over') return d>targetDigit;
  if(mode==='under') return d<targetDigit;
  return false;
}
function updatePL(){
  const el = $('#plV');
  el.textContent = (last_pl>=0?'+':'')+fmt(last_pl);
  el.className = 'v pl '+(last_pl>=0?'plus':'minus');
}

function toggleTray(){ $('#tray').classList.toggle('open'); }

function boot(){ buildDigits(); initAuthUI(); connectWS(); }
boot();

// Rebind connectWS to also route tick stream
const _connectWS = connectWS;
connectWS = function(){
  ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
  ws.onopen = ()=>{ if(token) wsSend({authorize: token}); };
  ws.onmessage = (msg)=>{
    const r = JSON.parse(msg.data);
    if(r.msg_type==='authorize'){
      loginid = r.authorize.loginid;
      currency = r.authorize.currency || 'USD';
      $('#authBtns').style.display='none';
      $('#balanceBox').style.display='flex';
      $('#acctSwitch').value = (loginid||'').startsWith('CR')?'real':'demo';
      $('#acctIcon').className = 'icon '+($('#acctSwitch').value==='demo'?'D':'R');
      is_demo = $('#acctSwitch').value==='demo';
      fetchBalance();
      subscribeTicks();
    } else if(r.msg_type==='balance'){
      const b = r.balance;
      $('#balanceAmt').textContent = fmt(b.balance);
    } else if(r.msg_type==='tick'){
      handleTick(r.tick);
    } else if(r.msg_type==='error'){
      console.warn(r.error);
    }
  };
  ws.onclose = ()=>setTimeout(connectWS, 1200);
}
</script>
</body>
</html>
