<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deriv Pro Panel — Dashboard</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --brand-red:#e31e24; /* Deriv-like red */
      --brand-red-dark:#bb1a1f;
      --ink:#111;
      --muted:#666;
      --surface:#fff;
      --surface-2:#fafafa;
      --accent:#0b72ff;
      --ok:#0ca80c;
      --bad:#e53935;
      --warn:#f59f00;
      --chip:#eef3ff;
      --shadow:0 8px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    [data-theme="dark"]{
      --surface:#0f1115;
      --surface-2:#151923;
      --ink:#f6f7fb;
      --muted:#c2c6d0;
      --chip:#1b2130;
      --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background:var(--surface-2); color:var(--ink);
    }
    a{color:inherit}
    .wrap{max-width:1240px; margin:0 auto; padding:16px}
    header.topbar{
      position:sticky; top:0; z-index:50; background:var(--surface);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .space{flex:1}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo .dot{width:14px; height:14px; border-radius:50%; background:var(--brand-red)}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px; border:1px solid rgba(0,0,0,.08);
      background:var(--surface); cursor:pointer; transition:.15s transform,.2s background;
      box-shadow:var(--shadow);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--brand-red); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent; border-color:rgba(0,0,0,.12)}
    .btn.ok{background:var(--ok); color:#fff; border:0}
    .btn.bad{background:var(--bad); color:#fff; border:0}
    .btn.small{padding:6px 10px; font-size:.9rem; box-shadow:none}
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:var(--chip); font-weight:600; color:var(--accent); border:1px solid rgba(0,0,0,.06)
    }
    .nav{display:flex; gap:8px; flex-wrap:wrap}
    .nav .tab{
      padding:10px 14px; border-radius:999px; background:var(--surface); border:1px solid rgba(0,0,0,.08); cursor:pointer;
    }
    .nav .tab.active{background:var(--brand-red); color:#fff; border-color:transparent}
    .card{
      background:var(--surface); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }
    .grid{display:grid; gap:16px}
    @media(min-width:960px){ .grid.cols-2{grid-template-columns:1.2fr .8fr} }
    .marquee{
      background:var(--brand-red); color:#fff; padding:10px 0;
      font-weight:700; letter-spacing:.2px
    }
    .marquee .inner{white-space:nowrap; overflow:hidden; display:block}
    .marquee .inner span{display:inline-block; padding-left:100%; animation:slide 18s linear infinite}
    @keyframes slide{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

    /* balances */
    .balances{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .bal{
      display:flex; align-items:center; gap:8px; background:var(--surface); padding:8px 12px;
      border-radius:12px; border:1px solid rgba(0,0,0,.08)
    }
    .badge{display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:50%}
    .badge.d{background:#111; color:#fff; font-size:.8rem; font-weight:800}
    .badge.us{background:linear-gradient(#b22234,#b22234),linear-gradient(#fff,#fff),linear-gradient(#3c3b6e,#3c3b6e);
              background-repeat:repeat,repeat,no-repeat;
              background-size:100% 14%,100% 14%,45% 70%;
              background-position:0 0,0 14%,0 0}
    .switcher{display:flex; gap:6px}
    .switcher .opt{padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.1); cursor:pointer}
    .switcher .opt.active{background:var(--brand-red); color:#fff; border-color:transparent}

    /* floating Run Bot button (shows in Dashboard, BotBuilder, Chart, DTrade) */
    .run-fab{
      position:fixed; right:16px; bottom:16px; z-index:60;
      display:flex; gap:8px; align-items:center;
      background:var(--ok); color:#fff; border-radius:999px; padding:12px 16px; cursor:pointer;
      box-shadow:var(--shadow);
    }
    .run-fab .dot{width:10px; height:10px; border-radius:50%; background:#fff}
    .run-fab.stop{background:var(--bad)}

    /* slide-up run panel */
    .runner{
      position:fixed; left:0; right:0; bottom:-420px; transition:bottom .35s ease;
      background:var(--surface); border-top-left-radius:18px; border-top-right-radius:18px; box-shadow:0 -10px 40px rgba(0,0,0,.2); z-index:70;
      padding:16px;
    }
    .runner.open{bottom:0}
    .rowy{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
    .stats{display:grid; grid-template-columns:repeat(5,minmax(140px,1fr)); gap:12px}
    @media(max-width:900px){ .stats{grid-template-columns:repeat(2,minmax(140px,1fr))} }
    .stat{background:var(--surface-2); padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,.06)}
    .g{color:var(--ok); font-weight:800}
    .r{color:var(--bad); font-weight:800}
    .neutral{color:var(--muted); font-weight:700}
    .sep{height:1px; background:rgba(0,0,0,.08); margin:12px 0}

    /* sections */
    main{padding:16px}
    section[hidden]{display:none !important}
    .thumbs{display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px}
    .thumb{background:var(--surface); border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; cursor:pointer}
    .thumb:hover{outline:2px solid var(--brand-red); outline-offset:2px}
    .title-sm{font-size:.95rem; font-weight:800}
    .muted{color:var(--muted); font-size:.9rem}
    iframe.embed{width:100%; height:70vh; border:0; border-radius:12px; background:#000}

    /* three-dots menu */
    .dots{position:relative}
    .dots-menu{position:absolute; right:0; top:42px; width:220px; background:var(--surface); border:1px solid rgba(0,0,0,.08);
               border-radius:12px; padding:8px; box-shadow:var(--shadow); display:none}
    .dots-menu.show{display:block}
    .dots-menu .item{padding:10px 12px; border-radius:10px; cursor:pointer}
    .dots-menu .item:hover{background:var(--surface-2)}

    /* chart fallback */
    #chart-fallback{height:68vh; background:#0b0e13; border-radius:12px; overflow:hidden; position:relative}
    #chart-canvas{width:100%; height:100%}

    /* tutorial placeholder */
    .placeholder{padding:18px; border-radius:12px; background:var(--surface); border:1px dashed rgba(0,0,0,.2)}

    /* small utilities */
    .hidden{display:none !important}
  </style>
</head>
<body>
  <!-- Running words top -->
  <div class="marquee"><div class="wrap">
    <div class="inner"><span id="marquee-text">Trusted smart trading. Live ticks. Bot runner. Demo & Real balances. Copy Demo → Real (optional). Trade responsibly.</span></div>
  </div></div>

  <!-- Header -->
  <header class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="logo"><span class="dot"></span><span>Deriv Pro Panel</span></div>

        <!-- Nav -->
        <nav class="nav" id="top-tabs">
          <button class="tab active" data-tab="dashboard">Dashboard</button>
          <button class="tab" data-tab="botbuilder">BotBuilder</button>
          <button class="tab" data-tab="analysis">Analysis Tool</button>
          <button class="tab" data-tab="signals">Signals Tool</button>
          <button class="tab" data-tab="freebots">Free Bots</button>
          <button class="tab" data-tab="dtrade">DTrade</button>
          <button class="tab" data-tab="chart">Chart</button>
          <button class="tab" data-tab="tutorial">Tutorial</button>
        </nav>

        <div class="space"></div>

        <!-- Balances & account switch -->
        <div class="balances">
          <div class="bal" title="Demo Balance">
            <span class="badge d">D</span>
            <span class="muted">Demo</span>
            <strong id="demo-balance" style="color:var(--ok)">$10,000.00</strong>
          </div>
          <div class="bal" title="Real Balance">
            <span class="badge us"></span>
            <span class="muted">Real</span>
            <strong id="real-balance" style="color:var(--ok)">$0.00</strong>
          </div>
          <div class="switcher" id="acct-switcher">
            <div class="opt active" data-acct="demo">Use Demo</div>
            <div class="opt" data-acct="real">Use Real</div>
          </div>
        </div>

        <!-- Three dots -->
        <div class="dots">
          <button class="btn small ghost" id="dots-btn" aria-label="menu">⋯</button>
          <div class="dots-menu" id="dots-menu">
            <div class="item" id="open-settings">Account Settings</div>
            <div class="item" id="open-cashier">Cashier (Deposit/Withdraw)</div>
            <div class="item" id="toggle-theme">Toggle Dark Mode</div>
            <div class="item" id="logout-btn">Logout</div>
          </div>
        </div>

        <!-- Auth -->
        <button class="btn primary" id="login-btn">Login</button>
      </div>
    </div>
  </header>

  <!-- Floating Run Bot button (visible in live sections) -->
  <button id="run-fab" class="run-fab hidden" title="Run Bot">
    <div class="dot"></div><strong id="run-fab-text">Run Bot</strong>
  </button>

  <!-- Slide-up runner panel -->
  <div class="runner" id="runner">
    <div class="rowy">
      <strong>Run Panel</strong>
      <span class="chip" id="purchase-guard">Purchases: OFF</span>
      <span class="chip" id="copy-mirror">Copy Demo → Real: OFF</span>
      <div class="space"></div>
      <button class="btn bad small" id="runner-close">Close</button>
    </div>
    <div class="sep"></div>
    <div class="stats">
      <div class="stat"><div class="muted">Status</div><div id="st-status" class="neutral">Idle</div></div>
      <div class="stat"><div class="muted">Runs</div><div id="st-runs" class="neutral">0</div></div>
      <div class="stat"><div class="muted">Wins</div><div id="st-wins" class="g">0</div></div>
      <div class="stat"><div class="muted">Losses</div><div id="st-losses" class="r">0</div></div>
      <div class="stat"><div class="muted">P/L</div><div id="st-pl" class="neutral">$0.00</div></div>
    </div>
    <div class="sep"></div>
    <div class="rowy">
      <button class="btn ok" id="runner-start">Start</button>
      <button class="btn bad" id="runner-stop">Stop</button>
      <button class="btn ghost" id="runner-reset">Reset</button>
      <div class="space"></div>
      <button class="btn" id="enable-purchases">Enable Purchases</button>
      <button class="btn" id="enable-copy">Enable Copy Demo → Real</button>
    </div>
  </div>

  <!-- Main -->
  <main class="wrap">
    <!-- DASHBOARD -->
    <section id="dashboard">
      <div class="grid cols-2">
        <div class="card">
          <h3 style="margin:0 0 8px 0;">Your Bot (ready to feed & run)</h3>
          <div class="muted" style="margin-bottom:8px">Upload a bot or pick one from Free Bots — it will appear here instantly.</div>
          <div id="bot-form">
            <div class="row" style="gap:10px; flex-wrap:wrap">
              <label>Market:
                <select id="f-market">
                  <option value="R_10">Volatility 10 Index</option>
                  <option value="R_10_1S">Volatility 10 (1s) Index</option>
                  <option value="R_25">Volatility 25 Index</option>
                  <option value="R_25_1S">Volatility 25 (1s) Index</option>
                  <option value="R_30">Volatility 30 Index</option>
                  <option value="R_30_1S">Volatility 30 (1s) Index</option>
                  <option value="R_50">Volatility 50 Index</option>
                  <option value="R_50_1S">Volatility 50 (1s) Index</option>
                  <option value="R_75">Volatility 75 Index</option>
                  <option value="R_75_1S">Volatility 75 (1s) Index</option>
                  <option value="R_100">Volatility 100 Index</option>
                  <option value="R_100_1S">Volatility 100 (1s) Index</option>
                </select>
              </label>
              <label>Stake:
                <input id="f-stake" type="number" min="0.35" step="0.01" value="1.00" />
              </label>
              <label>Max Runs:
                <input id="f-max" type="number" min="1" step="1" value="10" />
              </label>
              <label>Strategy:
                <select id="f-strategy">
                  <option value="rise_fall">Rise / Fall</option>
                  <option value="even_odd">Even / Odd</option>
                  <option value="matches_differs">Matches / Differs</option>
                  <option value="over_under">Over / Under</option>
                </select>
              </label>
              <button class="btn ok" id="btn-arm">Arm Run Panel</button>
            </div>
            <div class="sep"></div>
            <div class="row" style="gap:10px; flex-wrap:wrap">
              <input type="file" id="bot-file" accept=".xml" />
              <button class="btn" id="btn-load-file">Load Uploaded Bot</button>
              <button class="btn" id="btn-load-default">Load Default Bot</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0;">Live Ticks</h3>
          <div class="muted" style="margin-bottom:8px">Streaming from Deriv for the selected market.</div>
          <div id="ticks-box" style="font-family:ui-monospace,Menlo,Consolas,monospace; min-height:200px; background:#000; color:#0f0; padding:12px; border-radius:12px; overflow:auto"></div>
        </div>
      </div>
    </section>

    <!-- BOTBUILDER -->
    <section id="botbuilder" hidden>
      <div class="card">
        <h3 style="margin:0 0 8px 0;">BotBuilder</h3>
        <div class="muted" style="margin-bottom:10px">Default bot template is preloaded. Modify inputs on the left (Dashboard) then run with the green button.</div>
        <div class="placeholder">Later, we can add a visual block builder here. For now, your Dashboard form controls the bot parameters.</div>
      </div>
    </section>

    <!-- ANALYSIS TOOL (placeholder) -->
    <section id="analysis" hidden>
      <div class="card">
        <h3>Analysis Tool</h3>
        <div class="placeholder">Coming soon: linked strategy analytics & pattern signals (as agreed).</div>
      </div>
    </section>

    <!-- SIGNALS TOOL (placeholder) -->
    <section id="signals" hidden>
      <div class="card">
        <h3>Signals Tool</h3>
        <div class="placeholder">Coming soon: real-time signals for Matches/Differs, Over/Under, Odd/Even.</div>
      </div>
    </section>

    <!-- FREE BOTS -->
    <section id="freebots" hidden>
      <div class="card">
        <h3>Free Bots</h3>
        <div class="muted" style="margin-bottom:10px">Tap any bot to load it into the Dashboard instantly.</div>
        <div class="thumbs" id="bot-list">
          <!-- Filled by JS -->
        </div>
        <div class="sep"></div>
        <div class="row">
          <input type="file" id="free-file" accept=".xml" />
          <button class="btn" id="btn-free-load">Upload & Load</button>
        </div>
      </div>
    </section>

    <!-- DTRADE -->
    <section id="dtrade" hidden>
      <div class="card">
        <h3>DTrade</h3>
        <div id="dtrade-box">
          <iframe class="embed" id="dtrade-embed" src="https://app.deriv.com/"></iframe>
        </div>
        <div id="dtrade-fallback" class="placeholder hidden">
          If the official page blocks embedding, use the Chart tab (live) or open Deriv in a new tab.
          <div style="margin-top:8px">
            <a class="btn primary" target="_blank" href="https://app.deriv.com/">Open Deriv DTrader</a>
          </div>
        </div>
      </div>
    </section>

    <!-- CHART -->
    <section id="chart" hidden>
      <div class="card">
        <h3>Chart — Accumulators (default) + Strategies</h3>
        <div id="chart-box">
          <iframe class="embed" id="chart-embed" src="https://app.deriv.com/"></iframe>
        </div>
        <div id="chart-fallback" class="hidden">
          <canvas id="chart-canvas"></canvas>
        </div>
        <div class="sep"></div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <span class="chip">Default: Accumulators</span>
          <button class="btn small" data-strat="accumulators">Accumulators</button>
          <button class="btn small" data-strat="even_odd">Even/Odd</button>
          <button class="btn small" data-strat="matches_differs">Matches/Differs</button>
          <button class="btn small" data-strat="over_under">Over/Under</button>
          <button class="btn small" data-strat="rise_fall">Rise/Fall</button>
        </div>
      </div>
    </section>

    <!-- TUTORIAL -->
    <section id="tutorial" hidden>
      <div class="card">
        <h3>Tutorial</h3>
        <div class="placeholder">
          • Login with your Deriv account (top right).<br/>
          • Choose Demo or Real (switcher).<br/>
          • Load a bot (Free Bots or upload XML).<br/>
          • Arm the run panel, then press the green Run button (bottom-right).<br/>
          • Purchases are OFF by default; enable them in the run panel when ready.<br/>
          • Optional: Copy Demo → Real mirrors your demo orders to real (only if you enable it).<br/>
          • Use DTrade / Chart for manual strategies. If Deriv blocks the iframe, the fallback chart still streams live ticks.
        </div>
      </div>
    </section>
  </main>

  <!-- WhatsApp / Telegram icons (top center floating, white) -->
  <div style="position:fixed; left:50%; transform:translateX(-50%); top:64px; display:flex; gap:8px; z-index:45">
    <a class="btn small" style="background:#fff" target="_blank" href="https://chat.whatsapp.com/I9pHdE0sNuTJbKMzgJ84GD?mode=ac_t" title="WhatsApp">🟢</a>
    <a class="btn small" style="background:#fff" target="_blank" href="https://t.me/+BsA8dvAh_lA2YzRk" title="Telegram">🔵</a>
  </div>

  <script>
  ;(() => {
    // ====== Config
    const APP_ID = 96054; // Affiliate App ID
    const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;

    // ====== State
    const state = {
      auth: {
        token: null,
        is_demo: true, // default Demo
        loginid: null,
        accounts: { demo: null, real: null },
      },
      ws: null,
      market: 'R_10',
      stake: 1,
      maxRuns: 10,
      strategy: 'rise_fall',
      running: false,
      allowPurchases: false,
      copyMirror: false,
      stats: { runs: 0, wins: 0, losses: 0, pl: 0 },
      botXML: null
    };

    // ====== El helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const show = (el, doShow) => el.classList.toggle('hidden', !doShow);

    // ====== Tabs
    const sections = ['dashboard','botbuilder','analysis','signals','freebots','dtrade','chart','tutorial'];
    function setTab(id){
      sections.forEach(s=>{
        const btn = document.querySelector(`.tab[data-tab="${s}"]`);
        const sec = document.getElementById(s);
        btn.classList.toggle('active', s===id);
        sec.toggleAttribute('hidden', s!==id);
      });
      // Run button visible only on these:
      const live = ['dashboard','botbuilder','dtrade','chart'];
      $('#run-fab').classList.toggle('hidden', !live.includes(id));
    }
    $$('#top-tabs .tab').forEach(b=>b.addEventListener('click',()=>setTab(b.dataset.tab)));

    // ====== Three-dots menu
    $('#dots-btn').addEventListener('click',()=>{
      $('#dots-menu').classList.toggle('show');
    });
    document.addEventListener('click', (e)=>{
      if (!e.target.closest('.dots')) $('#dots-menu').classList.remove('show');
    });

    // Account settings (placeholder)
    $('#open-settings').addEventListener('click', ()=> {
      alert('Account settings will open here.');
    });

    // Cashier
    $('#open-cashier').addEventListener('click', ()=> {
      window.open('https://app.deriv.com/cashier/deposit', '_blank');
    });

    // Theme toggle
    $('#toggle-theme').addEventListener('click', ()=>{
      const root = document.documentElement;
      root.setAttribute('data-theme', root.getAttribute('data-theme')==='light' ? 'dark' : 'light');
    });

    // ====== Login / Logout
    function isIframeBlocked(iframe){
      try { const x = iframe.contentWindow.length; return false; } catch(e){ return true; }
    }
    function parseQuery(){
      const q = new URLSearchParams(window.location.search);
      const token = q.get('token');
      if (token) {
        state.auth.token = token;
        history.replaceState({}, '', window.location.pathname);
        authorize();
      }
    }
    function login(){
      const brand = 'deriv';
      const lang = 'EN';
      const url = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&brand=${brand}&l=${lang}`;
      window.location.href = url;
    }
    function logout(){
      state.auth.token = null;
      state.auth.loginid = null;
      state.auth.accounts = { demo:null, real:null };
      updateBalancesUI(0,0);
      alert('Logged out.');
    }
    $('#login-btn').addEventListener('click', login);
    $('#logout-btn').addEventListener('click', logout);

    // ====== WebSocket & API
    function wsSend(msg){ if (state.ws && state.ws.readyState===1) state.ws.send(JSON.stringify(msg)); }
    function wsConnect(){
      if (state.ws && state.ws.readyState<=1) return;
      state.ws = new WebSocket(WS_URL);
      state.ws.onopen = () => { if (state.auth.token) authorize(); subscribeTicks(state.market); };
      state.ws.onmessage = onWSMessage;
      state.ws.onclose = () => setTimeout(wsConnect, 2000);
      state.ws.onerror = () => {};
    }
    function authorize(){
      if (!state.auth.token) return;
      wsSend({ authorize: state.auth.token });
    }

    function onWSMessage(ev){
      const data = JSON.parse(ev.data);
      if (data.authorize){
        const auth = data.authorize;
        state.auth.loginid = auth.loginid;
        // Identify demo vs real from loginid
        const isDemo = /^VRTC/.test(auth.loginid);
        state.auth.is_demo = isDemo;
        // Accounts list
        if (auth.account_list){
          const demoAcc = auth.account_list.find(a=>/^VRTC/.test(a.loginid));
          const realAcc = auth.account_list.find(a=>/^(?!VRTC)/.test(a.loginid));
          state.auth.accounts.demo = demoAcc?.loginid || null;
          state.auth.accounts.real = realAcc?.loginid || null;
        }
        // Fetch balances
        wsSend({ balance: 1 });
        $('#login-btn').textContent = `Logged in (${state.auth.loginid})`;
      }
      if (data.balance){
        const bal = data.balance;
        const amt = Number(bal.balance).toFixed(2);
        if (state.auth.is_demo) updateBalancesUI(amt, undefined);
        else updateBalancesUI(undefined, amt);
      }
      if (data.ticks){
        const t = data.ticks;
        pushTick(t.symbol, t.quote, t.epoch);
      }
      if (data.error){
        console.warn('API error:', data.error);
      }
    }

    function switchAccount(useDemo){
      if (!state.auth.accounts.demo && !state.auth.accounts.real){
        alert('Login required first.');
        return;
      }
      state.auth.is_demo = useDemo;
      const target = useDemo ? state.auth.accounts.demo : state.auth.accounts.real;
      if (!target){
        alert(useDemo ? 'No demo account found.' : 'No real account found.');
        return;
      }
      wsSend({ authorize: state.auth.token, account: target });
      $$('#acct-switcher .opt').forEach(o=>o.classList.toggle('active', o.dataset.acct === (useDemo?'demo':'real')));
    }
    $('#acct-switcher').addEventListener('click',(e)=>{
      const o = e.target.closest('.opt'); if(!o) return;
      switchAccount(o.dataset.acct==='demo');
    });

    // ====== Balances UI
    function updateBalancesUI(demo, real){
      if (demo!==undefined) $('#demo-balance').textContent = `$${Number(demo).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
      if (real!==undefined) $('#real-balance').textContent = `$${Number(real).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
    }

    // ====== Ticks
    function subscribeTicks(sym){
      wsSend({ forget_all: 'ticks' });
      wsSend({ ticks: sym, subscribe: 1 });
    }
    function pushTick(sym, quote, epoch){
      const box = $('#ticks-box');
      const line = `[${new Date(epoch*1000).toLocaleTimeString()}] ${sym} → ${quote}`;
      const atBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 8;
      box.textContent += (box.textContent? '\n':'') + line;
      if (atBottom) box.scrollTop = box.scrollHeight;
    }

    // ====== Dashboard form
    $('#f-market').addEventListener('change', e=> {
      state.market = e.target.value;
      subscribeTicks(state.market);
    });
    $('#f-stake').addEventListener('change', e=> state.stake = Number(e.target.value||1));
    $('#f-max').addEventListener('change', e=> state.maxRuns = Number(e.target.value||10));
    $('#f-strategy').addEventListener('change', e=> state.strategy = e.target.value);

    // Arm runner
    $('#btn-arm').addEventListener('click', ()=>{
      $('#runner').classList.add('open');
      $('#st-status').textContent = 'Armed';
    });

    // ====== Floating Run button
    const liveTabs = new Set(['dashboard','botbuilder','dtrade','chart']);
    function currentTab(){ return document.querySelector('.tab.active')?.dataset.tab || 'dashboard'; }
    function updateFab(){
      const showFab = liveTabs.has(currentTab());
      $('#run-fab').classList.toggle('hidden', !showFab);
      $('#run-fab').classList.toggle('stop', state.running);
      $('#run-fab-text').textContent = state.running ? 'Stop Bot' : 'Run Bot';
    }
    $('#run-fab').addEventListener('click', ()=>{
      if (!$('#runner').classList.contains('open')) $('#runner').classList.add('open');
      if (state.running){ stopBot(); } else { startBot(); }
      updateFab();
    });

    // Runner buttons
    $('#runner-close').addEventListener('click', ()=> $('#runner').classList.remove('open'));
    $('#runner-start').addEventListener('click', ()=>{ startBot(); updateFab(); });
    $('#runner-stop').addEventListener('click', ()=>{ stopBot(); updateFab(); });
    $('#runner-reset').addEventListener('click', ()=> resetStats());

    // Purchases & Copy toggles
    $('#enable-purchases').addEventListener('click', ()=>{
      state.allowPurchases = !state.allowPurchases;
      $('#purchase-guard').textContent = `Purchases: ${state.allowPurchases? 'ON':'OFF'}`;
      alert(state.allowPurchases ? 'Purchases ENABLED. Trades may be executed.' : 'Purchases DISABLED.');
    });
    $('#enable-copy').addEventListener('click', ()=>{
      state.copyMirror = !state.copyMirror;
      $('#copy-mirror').textContent = `Copy Demo → Real: ${state.copyMirror? 'ON':'OFF'}`;
    });

    // ====== Simple bot runner (tick-based mock; safe until purchases enabled)
    function startBot(){
      if (state.running) return;
      state.running = true;
      $('#st-status').textContent = 'Running';
      runCycle();
    }
    function stopBot(){
      state.running = false;
      $('#st-status').textContent = 'Stopped';
    }
    function resetStats(){
      state.stats = { runs:0, wins:0, losses:0, pl:0 };
      $('#st-runs').textContent = '0';
      $('#st-wins').textContent = '0';
      $('#st-losses').textContent = '0';
      $('#st-pl').textContent = '$0.00';
      $('#st-pl').className = 'neutral';
      $('#st-status').textContent = 'Idle';
    }
    async function runCycle(){
      while(state.running && state.stats.runs < state.maxRuns){
        // Simulate an outcome while we stream ticks; replace with actual buy/settle later if purchases ON
        await new Promise(r=>setTimeout(r, 1200));
        const win = Math.random() > 0.5;
        state.stats.runs++;
        if (win){ state.stats.wins++; state.stats.pl += state.stake*0.95; } else { state.stats.losses++; state.stats.pl -= state.stake; }
        $('#st-runs').textContent = String(state.stats.runs);
        $('#st-wins').textContent = String(state.stats.wins);
        $('#st-losses').textContent = String(state.stats.losses);
        $('#st-pl').textContent = (state.stats.pl>=0?'+':'') + `$${state.stats.pl.toFixed(2)}`;
        $('#st-pl').className = state.stats.pl>=0 ? 'g' : 'r';

        // If purchases ON: here is where you'd call "buy" via Deriv API with selected contract params
        // If Copy Demo → Real: mirror the same "buy" to real account (requires switching authorize to real)
      }
      if (state.stats.runs >= state.maxRuns) { stopBot(); }
    }

    // ====== Free Bots (inline small default + user uploads)
    const DEFAULT_BOT_XML =
`<bot name="Default Rise/Fall">
  <settings>
    <market symbol="R_10" />
    <strategy type="rise_fall" />
    <stake amount="1.00" />
    <runs max="10" />
  </settings>
  <logic>
    <step action="analyze">use last tick</step>
    <step action="decide">random-rise-fall</step>
    <step action="purchase">when allowed</step>
  </logic>
</bot>`;

    const FREE_BOTS = [
      { id:'default', name:'Default Rise/Fall', desc:'Lightweight built-in template', size:'~2 KB', xml:DEFAULT_BOT_XML },
      // Your big XMLs can be uploaded via file picker below.
    ];

    function renderFreeBots(){
      const box = $('#bot-list'); box.innerHTML = '';
      FREE_BOTS.forEach(b=>{
        const d = document.createElement('div');
        d.className='thumb';
        d.innerHTML = `<div class="title-sm">${b.name}</div>
          <div class="muted">${b.desc}</div>
          <div class="muted">Size: ${b.size}</div>`;
        d.addEventListener('click', ()=>{
          state.botXML = b.xml;
          setTab('dashboard');
          alert(`${b.name} loaded into Dashboard.`);
        });
        box.appendChild(d);
      });
    }
    renderFreeBots();

    $('#btn-free-load').addEventListener('click', ()=>{
      const f = $('#free-file').files?.[0];
      if (!f) return alert('Choose an XML bot file.');
      const rd = new FileReader();
      rd.onload = () => {
        state.botXML = String(rd.result);
        setTab('dashboard');
        alert(`${f.name} loaded into Dashboard.`);
      };
      rd.readAsText(f);
    });

    // Dashboard loaders
    $('#btn-load-default').addEventListener('click', ()=>{
      state.botXML = DEFAULT_BOT_XML;
      alert('Default bot is loaded.');
    });
    $('#btn-load-file').addEventListener('click', ()=>{
      const f = $('#bot-file').files?.[0];
      if (!f) return alert('Pick your XML file first.');
      const rd = new FileReader();
      rd.onload = () => {
        state.botXML = String(rd.result);
        alert(`${f.name} loaded.`);
      };
      rd.readAsText(f);
    });

    // ====== DTrade & Chart embedding fallback detection
    function checkEmbeds(){
      const dtradeBlocked = isIframeBlocked($('#dtrade-embed'));
      const chartBlocked  = isIframeBlocked($('#chart-embed'));
      $('#dtrade-fallback').classList.toggle('hidden', !dtradeBlocked);
      if (chartBlocked){
        $('#chart-embed').classList.add('hidden');
        $('#chart-fallback').classList.remove('hidden');
        // very simple live chart fallback
        setupSimpleChart();
      }
    }
    // Simple line chart using canvas (no external libs)
    function setupSimpleChart(){
      const canvas = $('#chart-canvas');
      const ctx = canvas.getContext('2d');
      let w = canvas.width = canvas.parentElement.clientWidth;
      let h = canvas.height = canvas.parentElement.clientHeight;
      const points = [];
      window.addEventListener('resize', ()=>{
        w = canvas.width = canvas.parentElement.clientWidth;
        h = canvas.height = canvas.parentElement.clientHeight;
        draw();
      });
      function draw(){
        ctx.fillStyle = '#0b0e13'; ctx.fillRect(0,0,w,h);
        if (points.length<2) return;
        const min = Math.min(...points), max = Math.max(...points);
        const pad = 12;
        ctx.beginPath();
        ctx.strokeStyle = '#36d399';
        ctx.lineWidth = 2;
        points.forEach((p,i)=>{
          const x = pad + (w-2*pad) * (i/(points.length-1));
          const y = h - pad - ( (p-min)/(max-min||1) )*(h-2*pad);
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
      }
      // feed from ticks
      const origPush = pushTick;
      pushTick = function(sym, quote, epoch){
        origPush(sym, quote, epoch);
        points.push(Number(quote));
        if (points.length>300) points.shift();
        draw();
      }
    }

    // ====== Marquee dynamic line
    const marquee = $('#marquee-text');
    setInterval(()=>{
      const t = new Date().toLocaleTimeString();
      marquee.textContent = `Live • ${t} • Demo/Real • Bots • Accumulators • Matches/Differs • Over/Under • Odd/Even • Trade responsibly.`;
    }, 4000);

    // ====== Init
    wsConnect();
    parseQuery();
    subscribeTicks(state.market);
    setTab('dashboard');
    updateFab();
    // detect embeds a bit later to allow iframes to resolve
    setTimeout(checkEmbeds, 1800);

    // ====== Accessibility keyboard for tabs
    document.addEventListener('keydown',(e)=>{
      if (e.key==='Escape') $('#runner').classList.remove('open');
    });

  })();
  </script>
</body>
</html>
