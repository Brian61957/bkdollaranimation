<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deriv Smart Suite</title>
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='30' fill='%23e10600'/><text x='32' y='40' font-size='28' text-anchor='middle' fill='white' font-family='Arial'>D</text></svg>">
<style>
  :root{
    --brand:#e10600;         /* Deriv-like red */
    --brand-700:#b20500;
    --bg:#ffffff;            /* light bg */
    --fg:#111111;            /* light text */
    --muted:#6b7280;         /* gray-500 */
    --panel:#f8fafc;         /* slate-50 */
    --border:#e5e7eb;        /* gray-200 */
    --green:#16a34a;
    --red:#dc2626;
    --amber:#f59e0b;
    --blue:#2563eb;
    --chip:#f1f5f9;
  }
  [data-theme="dark"]{
    --bg:#0b0e13;
    --fg:#e5e7eb;
    --muted:#94a3b8;
    --panel:#0f131a;
    --border:#243041;
    --chip:#111827;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";}
  a{color:var(--blue);text-decoration:none}
  header{
    border-bottom:1px solid var(--border);
    background:var(--bg);
    position:sticky;top:0;z-index:40;
  }
  .container{max-width:1200px;margin:0 auto;padding:0 12px}
  .row{display:flex;align-items:center;gap:8px}
  .space{flex:1}
  .site-name{font-weight:800;letter-spacing:.3px;display:flex;align-items:center;gap:8px}
  .dot-menu{position:relative}
  .icon-btn{border:1px solid var(--border);background:var(--panel);padding:8px;border-radius:12px;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
  .icon-only{width:40px;height:40px;display:inline-grid;place-items:center;border-radius:50%;border:1px solid var(--border);background:var(--panel)}
  .topline{padding:10px 0}
  .messenger{gap:10px}
  .marquee{
    background:var(--panel);border-bottom:1px solid var(--border);color:var(--muted);
    white-space:nowrap;overflow:hidden;
  }
  .marquee span{display:inline-block;padding:8px 0;animation:mar 25s linear infinite}
  @keyframes mar{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
  .nav{
    position:sticky;top:86px;background:var(--bg);z-index:30;border-bottom:1px solid var(--border)
  }
  .tabs{display:flex;flex-wrap:wrap;gap:8px;padding:10px 0}
  .tab{
    padding:8px 14px;border-radius:999px;border:1px solid var(--border);background:var(--panel);cursor:pointer;
    font-weight:600
  }
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
  .main{padding:18px 12px}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .card{
    background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px
  }
  .card h3{margin:0 0 8px 0;font-size:16px}
  .muted{color:var(--muted)}
  .balance-bar{
    display:flex;align-items:center;gap:10px;background:var(--panel);
    border-bottom:1px solid var(--border)
  }
  .balance-chip{
    display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border)
  }
  .pill{display:inline-flex;align-items:center;justify-content:center;border-radius:999px;font-size:12px;font-weight:700}
  .pill-demo{background:#111827;color:#fff;width:18px;height:18px}
  .pill-real{background:#fff;border:1px solid var(--border);width:18px;height:18px}
  .bal-amt{color:var(--green);font-weight:800}
  .balance-select{border:1px solid var(--border);background:var(--bg);color:var(--fg);border-radius:10px;padding:6px}
  .hide{display:none !important}
  .row-wrap{display:flex;gap:10px;flex-wrap:wrap}
  .tile{
    display:flex;flex-direction:column;justify-content:center;align-items:center;gap:8px;height:120px;border:1px dashed var(--border);
    border-radius:16px;background:var(--bg);cursor:pointer
  }
  .tile img{width:44px;height:44px;opacity:.85}
  .tile strong{font-size:14px}
  .collapse{max-height:500px;overflow:hidden;transition:max-height .35s ease}
  .collapse.collapsed{max-height:0;padding-top:0;padding-bottom:0;border-width:0;margin:0}
  .bot-pane pre{max-height:240px;overflow:auto;background:#0b1020;color:#d1e8ff;padding:10px;border-radius:12px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;background:var(--chip);border:1px solid var(--border);padding:1px 6px;border-radius:6px}
  .digits{
    display:grid;grid-template-columns:repeat(10,1fr);gap:6px
  }
  .digit{
    text-align:center;padding:10px 6px;border-radius:12px;border:1px solid var(--border);background:var(--bg);font-weight:700
  }
  .digit.most{background:rgba(22,163,74,.08);border-color:rgba(22,163,74,.4);color:var(--green)}
  .digit.least{background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.4);color:var(--red)}
  .digit.hit{box-shadow:0 0 0 2px var(--green) inset}
  .digit.miss{box-shadow:0 0 0 2px var(--red) inset}
  .ticks-list{display:flex;gap:6px;flex-wrap:wrap}
  .tick{padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);font-weight:700}
  .tick.up{color:var(--green)} .tick.down{color:var(--red)}
  .runbar{
    position:fixed;left:0;right:0;bottom:0;background:var(--bg);border-top:2px solid var(--brand);z-index:50
  }
  .runbar .inner{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:10px}
  .run-btn{
    background:var(--brand);color:#fff;border:none;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer
  }
  .stop-btn{background:#0b1020}
  .run-panel{
    position:fixed;left:0;right:0;bottom:-380px;background:var(--panel);border-top:2px solid var(--brand);transition:bottom .25s ease;z-index:55;
  }
  .run-panel.open{bottom:54px}
  .stat{display:flex;flex-direction:column;align-items:center;min-width:70px}
  .stat .num{font-weight:900;font-size:18px}
  .stat .lab{font-size:11px;color:var(--muted)}
  .three-menu{position:absolute;right:0;top:40px;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px;min-width:240px;display:none}
  .three-menu.open{display:block}
  .menu-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;cursor:pointer}
  .menu-item:hover{background:var(--bg)}
  .buy{background:var(--green);color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .sell{background:var(--red);color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  input,select,textarea{border:1px solid var(--border);background:var(--bg);color:var(--fg);border-radius:10px;padding:8px}
  .hint{font-size:12px;color:var(--muted)}
  .footer-space{height:64px}
  @media (max-width:860px){
    .grid-3{grid-template-columns:1fr}
    .grid-2{grid-template-columns:1fr}
    .messenger{order:3;width:100%;justify-content:center}
    .site-name{order:1}
  }
</style>
</head>
<body>

<header>
  <div class="container topline row">
    <div class="row site-name">
      <span style="display:inline-grid;place-items:center;width:28px;height:28px;border-radius:6px;background:var(--brand);color:#fff;font-weight:900">D</span>
      <span>Deriv Smart Suite</span>
      <div id="balanceCluster" class="row hide" style="margin-left:10px;">
        <span class="balance-chip"><span id="acctPill" class="pill pill-demo">D</span><span id="acctKind">Demo</span></span>
        <span class="balance-chip">Balance: <span id="balanceAmt" class="bal-amt">$0.00</span></span>
        <select id="acctSelect" class="balance-select"></select>
      </div>
    </div>

    <div class="space"></div>

    <div class="row messenger">
      <a class="icon-only" title="WhatsApp" href="https://chat.whatsapp.com/I9pHdE0sNuTJbKMzgJ84GD?mode=ac_t" target="_blank" rel="noopener" aria-label="WhatsApp">
        üü¢
      </a>
      <a class="icon-only" title="Telegram" href="https://t.me/+BsA8dvAh_lA2YzRk" target="_blank" rel="noopener" aria-label="Telegram">
        ‚úàÔ∏è
      </a>
    </div>

    <div class="space"></div>

    <div class="row">
      <a id="signup" class="icon-btn" target="_blank" rel="noopener"
         href="https://app.deriv.com/signup/?brand=deriv&platform=mt5&pid=96503">Sign up</a>
      <a id="signin" class="icon-btn" target="_blank" rel="noopener"
         href="https://app.deriv.com/?pid=96503">Sign in</a>

      <div class="dot-menu">
        <button id="threeDots" class="icon-btn" aria-label="Menu">‚ãÆ</button>
        <div id="threeMenu" class="three-menu">
          <div class="menu-item" id="pasteToken">üîë Paste API Token</div>
          <div class="menu-item" id="darkMode">üåì Toggle Dark Mode</div>
          <div class="menu-item" id="acctSettings">üë§ Account settings</div>
          <div class="menu-item" id="cashier">üí≥ Cashier (Deposit/Withdraw)</div>
          <div class="menu-item" id="logout">üö™ Logout</div>
        </div>
      </div>
    </div>
  </div>

  <div class="marquee">
    <div class="container"><span>‚ö†Ô∏è Trade responsibly. Analyze before running any bot. Profits are green, losses are red. Use Demo first. ‚Äî Powered by your App ID 96503 ‚Äî Copy Demo ‚ûú Real is optional and off by default.</span></div>
  </div>
</header>

<nav class="nav">
  <div class="container tabs">
    <button class="tab active" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="botbuilder">Botbuilder</button>
    <button class="tab" data-tab="analysis">Analysis Tool</button>
    <button class="tab" data-tab="signals">Signal Tool</button>
    <button class="tab" data-tab="dtrade">Dtrade</button>
    <button class="tab" data-tab="chart">Chart</button>
    <button class="tab" data-tab="strategies">Strategies</button>
    <button class="tab" data-tab="tutorial">Tutorial</button>
    <button class="tab" data-tab="freebots">Free Bots</button>
  </div>
</nav>

<section class="main container">
  <!-- DASHBOARD -->
  <div id="dashboard" class="grid">
    <div class="grid grid-2" id="dashTiles">
      <div class="card tile" id="tileUpload">
        <img alt="" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><path d='M32 6l10 10h-6v16h-8V16h-6z' fill='%23e10600'/><rect x='10' y='36' width='44' height='18' rx='8' fill='%23aaa'/></svg>">
        <strong>Upload Local Bot (XML)</strong>
        <input id="localBot" type="file" accept=".xml" style="display:none">
      </div>
      <div class="card tile" id="tileDrive">
        <img alt="" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><circle cx='32' cy='32' r='28' fill='%23e10600'/></svg>">
        <strong>Load from URL (GDrive/Direct)</strong>
      </div>
      <div class="card tile" id="tileBuilder">
        <img alt="" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect x='8' y='12' width='48' height='40' rx='8' fill='%23e10600'/></svg>">
        <strong>Open Botbuilder</strong>
      </div>
      <div class="card tile" id="tileQuick">
        <img alt="" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><polygon points='8,32 56,32 44,48 20,48' fill='%23e10600'/></svg>">
        <strong>Quick Strategy</strong>
      </div>
    </div>

    <div id="botPanel" class="card collapse collapsed bot-pane">
      <h3>Bot Ready</h3>
      <div class="row-wrap">
        <label>Symbol
          <select id="botSymbol">
            <option>R_10</option><option>R_10_1S</option>
            <option>R_25</option><option>R_25_1S</option>
            <option>R_30</option><option>R_30_1S</option>
            <option>R_50</option><option>R_50_1S</option>
            <option>R_75</option><option>R_75_1S</option>
            <option>R_100</option><option>R_100_1S</option>
          </select>
        </label>
        <label>Stake <input id="botStake" type="number" min="0.35" step="0.01" value="1.00"></label>
        <label>Ticks <input id="botTicks" type="number" min="1" max="10" value="3"></label>
        <label>TP <input id="botTP" type="number" step="0.01" value="5.00"></label>
        <label>SL <input id="botSL" type="number" step="0.01" value="5.00"></label>
        <label class="row" style="gap:6px;"><input id="mirrorToggle" type="checkbox"> <span>Copy Demo ‚ûú Real</span></label>
      </div>
      <div class="hint">Loaded bot XML:</div>
      <pre id="botXML"></pre>
    </div>
  </div>

  <!-- BOTBUILDER -->
  <div id="botbuilder" class="grid hide">
    <div class="card">
      <h3>Default Bot (ready to feed & run)</h3>
      <div class="row-wrap" style="margin-bottom:8px">
        <button id="btnLoadDefault" class="icon-btn">Load Default</button>
        <button id="btnValidate" class="icon-btn">Validate</button>
        <button id="btnPushToDashboard" class="icon-btn">Send to Dashboard</button>
      </div>
      <textarea id="builderXML" rows="14" style="width:100%"></textarea>
      <div class="hint">You can paste/edit any bot XML here.</div>
    </div>
  </div>

  <!-- ANALYSIS -->
  <div id="analysis" class="grid hide">
    <div class="card">
      <h3>Analysis Tool (Placeholder)</h3>
      <p class="muted">Coming next: deep market analytics.</p>
    </div>
  </div>

  <!-- SIGNALS -->
  <div id="signals" class="grid hide">
    <div class="card">
      <h3>Signal Tool (Placeholder)</h3>
      <p class="muted">Matches/Differs predictor with stats will be added here.</p>
    </div>
  </div>

  <!-- DTRADE (Simplified Live Trading) -->
  <div id="dtrade" class="grid hide">
    <div class="card">
      <h3>Dtrade ‚Äî Rise/Fall & Digits</h3>
      <div class="row-wrap">
        <label>Symbol
          <select id="dtSymbol">
            <option>R_10</option><option>R_10_1S</option>
            <option>R_25</option><option>R_25_1S</option>
            <option>R_30</option><option>R_30_1S</option>
            <option>R_50</option><option>R_50_1S</option>
            <option>R_75</option><option>R_75_1S</option>
            <option>R_100</option><option>R_100_1S</option>
          </select>
        </label>
        <label>Stake <input id="dtStake" type="number" min="0.35" step="0.01" value="1.00"></label>
        <label>Duration Ticks <input id="dtTicks" type="number" min="1" max="10" value="3"></label>
        <label>Digits Target <input id="dtDigit" type="number" min="0" max="9" value="9"></label>
        <select id="dtType">
          <option value="RISE_FALL">Rise/Fall</option>
          <option value="DIGITMATCH">Digit Matches</option>
          <option value="DIGITDIFF">Digit Differs</option>
          <option value="DIGITEVEN">Digit Even</option>
          <option value="DIGITODD">Digit Odd</option>
          <option value="OVER">Over</option>
          <option value="UNDER">Under</option>
        </select>
        <button id="dtBuy" class="buy">Buy</button>
      </div>
      <div id="dtLog" class="hint" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- CHART (Live ticks + last digit stats like your screenshot) -->
  <div id="chart" class="grid hide">
    <div class="card">
      <h3>Live Chart & Last Digit Stats</h3>
      <div class="row-wrap">
        <label>Symbol
          <select id="chSymbol">
            <option>R_10</option><option>R_10_1S</option>
            <option>R_25</option><option>R_25_1S</option>
            <option>R_30</option><option>R_30_1S</option>
            <option>R_50</option><option>R_50_1S</option>
            <option>R_75</option><option>R_75_1S</option>
            <option>R_100</option><option>R_100_1S</option>
          </select>
        </label>
        <label>Track Digit <input id="trackDigit" type="number" min="0" max="9" value="9"></label>
        <label>Window (ticks) <input id="trackWindow" type="number" min="20" max="200" value="100"></label>
      </div>
      <div class="digits" id="digitsGrid"></div>
      <div style="margin-top:10px">
        <div id="ticksRow" class="ticks-list"></div>
      </div>
      <div class="hint">Most frequent digit = green; least frequent = red. Live matching highlights the tracked digit green on hit, red on miss (last tick of run).</div>
    </div>
  </div>

  <!-- STRATEGIES PANEL (Even/Odd, Matches/Differs, Over/Under) -->
  <div id="strategies" class="grid hide">
    <div class="card">
      <h3>Quick Strategies</h3>
      <div class="row-wrap">
        <label>Symbol
          <select id="qsSymbol">
            <option>R_10</option><option>R_10_1S</option>
            <option>R_25</option><option>R_25_1S</option>
            <option>R_30</option><option>R_30_1S</option>
            <option>R_50</option><option>R_50_1S</option>
            <option>R_75</option><option>R_75_1S</option>
            <option>R_100</option><option>R_100_1S</option>
          </select>
        </label>
        <select id="qsType">
          <option value="DIGITMATCH">Matches</option>
          <option value="DIGITDIFF">Differs</option>
          <option value="DIGITEVEN">Even</option>
          <option value="DIGITODD">Odd</option>
          <option value="OVER">Over</option>
          <option value="UNDER">Under</option>
          <option value="RISE_FALL">Rise/Fall</option>
        </select>
        <label>Digit <input id="qsDigit" type="number" min="0" max="9" value="9"></label>
        <label>Stake <input id="qsStake" type="number" min="0.35" step="0.01" value="1.00"></label>
        <label>Ticks <input id="qsTicks" type="number" min="1" max="10" value="3"></label>
        <button id="qsBuy" class="buy">Buy</button>
      </div>
      <div id="qsStatus" class="hint"></div>
    </div>
  </div>

  <!-- TUTORIAL -->
  <div id="tutorial" class="grid hide">
    <div class="card">
      <h3>Tutorial</h3>
      <p>1) Click ‚ãÆ and <span class="kbd">Paste API Token</span> (Demo first).<br>
         2) Choose a section: <b>Dashboard</b> to load a bot, or <b>Strategies/Chart</b> for quick trades.<br>
         3) Use the bottom <b>RUN BOT</b> to execute your loaded bot and monitor in real time.<br>
         4) Use <b>Copy Demo ‚Üí Real</b> only when ready.</p>
    </div>
  </div>

  <!-- FREE BOTS -->
  <div id="freebots" class="grid hide">
    <div class="card">
      <h3>Free Bots</h3>
      <div class="row-wrap" id="freeList"></div>
      <div class="hint">Tap a bot to load it into Dashboard & Botbuilder instantly.</div>
    </div>
  </div>

  <div class="footer-space"></div>
</section>

<!-- RUN BOT sticky bar + slide panel -->
<div class="runbar">
  <div class="inner">
    <button id="runBtn" class="run-btn">‚ñ∂ RUN BOT</button>
    <div class="stat"><div id="stRuns" class="num">0</div><div class="lab">Runs</div></div>
    <div class="stat"><div id="stWins" class="num" style="color:var(--green)">0</div><div class="lab">Wins</div></div>
    <div class="stat"><div id="stLoss" class="num" style="color:var(--red)">0</div><div class="lab">Losses</div></div>
    <div class="stat"><div id="stPnL" class="num">$0.00</div><div class="lab">PnL</div></div>
    <div class="space"></div>
    <label class="row" style="gap:6px;"><input id="copyMirror" type="checkbox"> <span>Copy Demo ‚ûú Real</span></label>
  </div>
</div>
<div id="runPanel" class="run-panel">
  <div class="container" style="padding:10px 12px">
    <div class="row" style="gap:10px;align-items:center">
      <strong>Run Log</strong>
      <div class="space"></div>
      <button id="stopBtn" class="run-btn stop-btn">‚ñ† STOP</button>
      <button id="resetBtn" class="icon-btn">Reset</button>
      <button id="collapseBtn" class="icon-btn">Collapse</button>
    </div>
    <pre id="runLog" style="max-height:300px;overflow:auto;margin:10px 0 12px 0;background:#0b1020;color:#cde7ff;padding:10px;border-radius:12px"></pre>
  </div>
</div>

<script>
(function(){
  // ====== CONFIG ======
  const APP_ID = 96503; // your new app id
  const WS_URL = `wss://derivws.com/websockets/v3?app_id=${APP_ID}`;
  const AFF_PID = 96503;

  // ====== STATE ======
  let ws = null;
  let authToken = localStorage.getItem('deriv_token')||'';
  let authorized = false;
  let accounts = [];
  let activeLoginId = '';
  let isDemo = true;
  let balanceSubId = null;
  let tickSubId = null;
  let lastTicks = []; // for chart/strategies stats
  let counts = Array(10).fill(0);
  let running = false;
  let wins=0, losses=0, pnl=0, runs=0;

  // ====== UI HELPERS ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt = n => (n>=0?'+':'') + (Math.round(n*100)/100).toFixed(2);
  const money = n => (n<0?'-':'')+'$'+Math.abs(n).toFixed(2);

  function toast(msg){
    const div = document.createElement('div');
    div.textContent = msg;
    div.style.position='fixed';div.style.right='12px';div.style.bottom='70px';
    div.style.background='var(--panel)';div.style.color='var(--fg)';
    div.style.border='1px solid var(--border)';div.style.borderRadius='10px';
    div.style.padding='10px 12px';div.style.zIndex='60';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),2600);
  }

  function setTheme(dark){
    document.documentElement.setAttribute('data-theme', dark?'dark':'light');
    localStorage.setItem('theme', dark?'dark':'light');
  }
  setTheme(localStorage.getItem('theme')==='dark');

  // ====== TABS ======
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const key = btn.getAttribute('data-tab');
      // show
      $$('#dashboard,#botbuilder,#analysis,#signals,#dtrade,#chart,#strategies,#tutorial,#freebots')
        .forEach(s=>s.classList.add('hide'));
      $('#'+key).classList.remove('hide');
      // Running bar available on these:
      const showRun = ['dashboard','botbuilder','chart','dtrade','strategies'].includes(key);
      document.querySelector('.runbar').style.display = showRun?'block':'none';
    });
  });

  // ====== 3 DOTS MENU ======
  $('#threeDots').addEventListener('click', ()=>{
    $('#threeMenu').classList.toggle('open');
  });
  document.addEventListener('click', (e)=>{
    if (!$('#threeMenu').contains(e.target) && e.target!==$('#threeDots')){
      $('#threeMenu').classList.remove('open');
    }
  });
  $('#darkMode').addEventListener('click', ()=>{
    setTheme(localStorage.getItem('theme')!=='dark');
  });
  $('#acctSettings').addEventListener('click', ()=>{
    window.open('https://app.deriv.com/account/personal-details','_blank');
  });
  $('#cashier').addEventListener('click', ()=>{
    window.open('https://app.deriv.com/cashier/deposit','_blank');
  });
  $('#logout').addEventListener('click', ()=>{
    localStorage.removeItem('deriv_token');location.reload();
  });
  $('#pasteToken').addEventListener('click', ()=>{
    const t = prompt('Paste your Deriv API token (Demo first). This enables live balance & trading.');
    if (t){ authToken=t; localStorage.setItem('deriv_token',t); connect(); }
  });

  // ====== DERIV WS ======
  function connect(){
    if (ws){ try{ws.close()}catch{} }
    ws = new WebSocket(WS_URL);
    ws.onopen = ()=>{
      logRun('WS connected.');
      if (authToken){ send({authorize: authToken}); }
      send({website_status:1});
    };
    ws.onmessage = (evt)=>{
      const msg = JSON.parse(evt.data);
      // console.log(msg);
      if (msg.error){ toast('Error: '+msg.error.message); logRun('Error: '+msg.error.message); return; }
      if (msg.msg_type==='website_status'){ /* ok */ }
      if (msg.msg_type==='authorize'){
        authorized = true;
        accounts = msg.authorize.account_list||[];
        activeLoginId = msg.authorize.loginid;
        isDemo = activeLoginId.includes('VRTC');
        $('#signin').classList.add('hide');
        $('#signup').classList.add('hide');
        $('#balanceCluster').classList.remove('hide');
        updateAcctSelect();
        subBalance();
      }
      if (msg.msg_type==='balance'){
        const bal = msg.balance;
        $('#balanceAmt').textContent = (bal.currency? (bal.currency==='USD'?'$':''):'$') + Number(bal.balance).toFixed(2);
        // live change already handled by Deriv; color stays green
      }
      if (msg.msg_type==='ticks'){
        handleTick(msg.tick);
      }
      if (msg.msg_type==='proposal'){
        const p = msg.proposal;
        $('#qsStatus').textContent = `Quote: ${money(p.ask_price)} Payout ${money(p.payout)} ID ${p.id}`;
        if (queuedBuy){ buyNow(p.id); queuedBuy=null; }
        if (dtradeQueued){ buyNow(p.id); dtradeQueued=null; }
      }
      if (msg.msg_type==='buy'){
        const bc = msg.buy;
        logRun(`BOUGHT: ${bc.longcode} - buy_price ${money(bc.buy_price)}`);
      }
      if (msg.msg_type==='proposal_open_contract'){
        const poc = msg.proposal_open_contract;
        if (poc.is_sold){
          const profit = (poc.profit||0);
          runs++;
          if (profit>0){ wins++; } else { losses++; }
          pnl += Number(profit);
          updateStats();
          logRun(`CLOSED: ${poc.contract_id} result ${money(profit)}`);
        }else{
          // live stream updates
        }
      }
      if (msg.msg_type==='subscribe'){
        // capture subscription ids if needed
      }
    };
    ws.onclose = ()=>{ logRun('WS closed. Reconnecting in 1.2s...'); setTimeout(connect,1200); };
    ws.onerror = (e)=>{ logRun('WS error'); };
  }
  function send(obj){ ws && ws.readyState===1 && ws.send(JSON.stringify(obj)); }

  function subBalance(){
    if (!authorized) return;
    if (balanceSubId){ send({forget: balanceSubId}); balanceSubId=null; }
    send({balance:1, subscribe:1});
  }

  function handleTick(t){
    // build last digit stats like screenshot
    const price = Number(t.quote);
    const d = Math.abs(Math.floor(price*100)%10); // last digit
    lastTicks.unshift({d, p:price, epoch:t.epoch});
    if (lastTicks.length>Number($('#trackWindow').value||100)) lastTicks.pop();

    counts = Array(10).fill(0);
    lastTicks.forEach(x=>counts[x.d]++);
    const max = Math.max(...counts), min=Math.min(...counts);

    // update grid
    const grid = $('#digitsGrid');
    if (!grid.dataset.ready){
      grid.dataset.ready='1';
      for (let i=0;i<10;i++){
        const div = document.createElement('div');
        div.className='digit'; div.id='dg'+i;
        div.innerHTML = `<div style="font-size:20px">${i}</div><div><span id="pct${i}">0%</span><span class="muted"> ‚Ä¢ </span><span id="cnt${i}">0</span></div>`;
        grid.appendChild(div);
      }
    }
    for (let i=0;i<10;i++){
      const pct = counts[i] && lastTicks.length ? Math.round(counts[i]*100/lastTicks.length) : 0;
      $('#pct'+i).textContent = pct+'%';
      $('#cnt'+i).textContent = counts[i];
      const box = $('#dg'+i);
      box.classList.remove('most','least','hit','miss');
      if (counts[i]===max && max>0) box.classList.add('most');
      if (counts[i]===min) box.classList.add('least');
    }

    // mark last tick vs tracked digit
    const track = Number($('#trackDigit').value||9);
    if (lastTicks.length>0){
      const last = lastTicks[0].d;
      const box = $('#dg'+track);
      if (box){
        if (last===track){ box.classList.add('hit'); box.classList.remove('miss'); }
        else { box.classList.add('miss'); box.classList.remove('hit'); }
      }
    }

    // ticks row
    const row = $('#ticksRow');
    row.innerHTML='';
    lastTicks.slice(0,20).forEach((x,i)=>{
      const el = document.createElement('span');
      el.className='tick '+(i===0?'up':'');
      el.textContent = x.d;
      row.appendChild(el);
    });
  }

  // ====== SYMBOL STREAM SWITCHING ======
  function resubTicks(symbol){
    if (tickSubId){ send({forget: tickSubId}); tickSubId=null; }
    lastTicks=[]; counts=Array(10).fill(0);
    send({ticks: symbol, subscribe:1});
  }
  $('#chSymbol').addEventListener('change', e=> resubTicks(e.target.value));
  $('#qsSymbol').addEventListener('change', e=> resubTicks(e.target.value));
  $('#dtSymbol').addEventListener('change', e=> resubTicks(e.target.value));

  // ====== PROPOSAL + BUY (QUICK + DTRADE) ======
  let queuedBuy = null, dtradeQueued=null;

  function mapType(type){
    // maps UI selections to contract_type
    switch(type){
      case 'DIGITMATCH': return 'DIGITMATCH';
      case 'DIGITDIFF': return 'DIGITDIFF';
      case 'DIGITEVEN': return 'DIGITEVEN';
      case 'DIGITODD': return 'DIGITODD';
      case 'OVER': return 'DIGITOVER';
      case 'UNDER': return 'DIGITUNDER';
      case 'RISE_FALL': return 'CALLPUT';
      default: return 'CALLPUT';
    }
  }

  function requestProposal({symbol, stake, ticks, type, digit}){
    if (!authorized){ toast('Authorize first (‚ãÆ ‚ûú Paste API Token).'); return; }
    const ctype = mapType(type);
    const p = {
      proposal:1,
      amount: Number(stake),
      basis:'stake',
      contract_type: ctype,
      currency:'USD',
      duration: Number(ticks),
      duration_unit:'t',
      symbol
    };
    if (ctype.startsWith('DIGIT')){ p.barrier = ['DIGITOVER','DIGITUNDER','DIGITMATCH','DIGITDIFF'].includes(ctype) ? String(digit) : undefined; }
    send(p);
  }

  function buyNow(proposalId){
    send({buy:1, price:10000, proposal_id:proposalId});
    // subscribe to open contract updates
    send({proposal_open_contract:1, subscribe:1});
  }

  $('#qsBuy').addEventListener('click', ()=>{
    const symbol=$('#qsSymbol').value, stake=$('#qsStake').value, ticks=$('#qsTicks').value, digit=$('#qsDigit').value, type=$('#qsType').value;
    queuedBuy = true;
    requestProposal({symbol, stake, ticks, type, digit});
    $('#qsStatus').textContent='Requesting quote...';
  });

  $('#dtBuy').addEventListener('click', ()=>{
    const symbol=$('#dtSymbol').value, stake=$('#dtStake').value, ticks=$('#dtTicks').value, digit=$('#dtDigit').value, type=$('#dtType').value;
    dtradeQueued = true;
    requestProposal({symbol, stake, ticks, type, digit});
    $('#dtLog').textContent='Requesting quote...';
  });

  // ====== ACCOUNT SELECT ======
  function updateAcctSelect(){
    const sel = $('#acctSelect');
    sel.innerHTML='';
    accounts.forEach(a=>{
      const opt = document.createElement('option');
      opt.value = a.loginid;
      opt.textContent = a.loginid.includes('VRTC')?'Demo '+a.loginid:'Real '+a.loginid;
      sel.appendChild(opt);
    });
    sel.value = activeLoginId;
    const demo = activeLoginId.includes('VRTC');
    isDemo = demo;
    $('#acctKind').textContent = demo?'Demo':'Real';
    $('#acctPill').textContent = demo?'D':'üá∫üá∏';
    $('#acctPill').className = 'pill '+(demo?'pill-demo':'pill-real');
  }
  $('#acctSelect').addEventListener('change', (e)=>{
    const loginid = e.target.value;
    if (!authorized) return;
    send({set_active_loginid: loginid});
    activeLoginId=loginid;
    updateAcctSelect();
    subBalance();
  });

  // ====== DASHBOARD tiles ======
  $('#tileUpload').addEventListener('click', ()=> $('#localBot').click());
  $('#localBot').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();
    showBot(text);
  });

  $('#tileDrive').addEventListener('click', async ()=>{
    const url = prompt('Paste direct URL to XML (e.g., Google Drive raw link)');
    if (!url) return;
    try{
      const res = await fetch(url); const text = await res.text(); showBot(text);
    }catch(err){ toast('Failed to fetch bot URL');}
  });

  $('#tileBuilder').addEventListener('click', ()=>{
    switchTab('botbuilder');
  });
  $('#tileQuick').addEventListener('click', ()=>{
    switchTab('strategies');
  });

  function switchTab(key){
    $(`.tab.active`).classList.remove('active');
    $(`.tab[data-tab="${key}"]`).classList.add('active');
    $$('#dashboard,#botbuilder,#analysis,#signals,#dtrade,#chart,#strategies,#tutorial,#freebots').forEach(s=>s.classList.add('hide'));
    $('#'+key).classList.remove('hide');
    const showRun = ['dashboard','botbuilder','chart','dtrade','strategies'].includes(key);
    document.querySelector('.runbar').style.display = showRun?'block':'none';
  }

  function showBot(xml){
    $('#botXML').textContent = xml.trim();
    $('#builderXML').value = xml.trim();
    $('#dashTiles').classList.add('collapsed');
    $('#botPanel').classList.remove('collapsed');
    toast('Bot loaded.');
  }

  // ====== DEFAULT BOT + FREE BOTS ======
  const DefaultBotXML = `<!-- Entry Touch BBot (sample header) -->
<xml xmlns="https://developers.google.com/blockly/xml">
  <variables>
    <variable id="stake">stake</variable>
  </variables>
  <block type="trade_definition_market" id="mkt" x="20" y="20">
    <field name="SYMBOL_LIST">R_10</field>
  </block>
  <!-- ... your blocks ... -->
</xml>`.trim();

  const FreeBots = [
    {name:'Entry Touch B-Bot', key:'entry_touch', xml: DefaultBotXML},
    {name:'Digit Ranger Auto Bot', key:'digit_ranger', xml:`<xml>...digit ranger...</xml>`},
    {name:'Premium Rise/Fall', key:'premium_rf', xml:`<xml>...rise fall...</xml>`},
    {name:'RF-MARBLE B-BOT', key:'rf_marble', xml:`<xml>...rf marble...</xml>`},
    {name:'Vol Spike Hunter', key:'spike', xml:`<xml>...spike...</xml>`},
    {name:'Accumulator Helper', key:'accum', xml:`<xml>...accum...</xml>`},
    {name:'Touch/No Touch Pro', key:'touch_pro', xml:`<xml>...touch...</xml>`},
  ];

  function buildFreeBots(){
    const wrap = $('#freeList');
    wrap.innerHTML='';
    FreeBots.forEach(b=>{
      const btn = document.createElement('button');
      btn.className='icon-btn';
      btn.textContent=b.name;
      btn.addEventListener('click', ()=>{
        $('#builderXML').value = b.xml;
        showBot(b.xml);
        switchTab('dashboard');
      });
      wrap.appendChild(btn);
    });
  }
  buildFreeBots();

  $('#btnLoadDefault').addEventListener('click', ()=> $('#builderXML').value = DefaultBotXML);
  $('#btnValidate').addEventListener('click', ()=>{
    const ok = $('#builderXML').value.includes('<xml');
    toast(ok?'Looks like valid XML.':'XML does not look valid.');
  });
  $('#btnPushToDashboard').addEventListener('click', ()=>{
    showBot($('#builderXML').value);
    switchTab('dashboard');
  });

  // ====== RUN BOT BAR ======
  function updateStats(){
    $('#stRuns').textContent = runs;
    $('#stWins').textContent = wins;
    $('#stLoss').textContent = losses;
    const c = document.documentElement;
    $('#stPnL').textContent = money(pnl);
    $('#stPnL').style.color = pnl>=0?'var(--green)':'var(--red)';
  }
  function logRun(s){
    const area = $('#runLog');
    area.textContent += (s+'\n');
    area.scrollTop = area.scrollHeight;
  }

  $('#runBtn').addEventListener('click', ()=>{
    $('#runPanel').classList.add('open');
    if (running) return;
    running = true;
    $('#runBtn').textContent='‚ñ∂ RUNNING';
    logRun('Starting bot...');
    // Here you could parse #botXML and orchestrate proposals/buys based on its logic.
    // For now we simulate entry/exit tied to quick strategy selection:
    // (You can replace with your actual block execution if you wire a blockly runner)
  });

  $('#stopBtn').addEventListener('click', ()=>{
    running=false; $('#runBtn').textContent='‚ñ∂ RUN BOT'; logRun('Stopped.');
  });
  $('#resetBtn').addEventListener('click', ()=>{
    wins=losses=pnl=runs=0; updateStats(); $('#runLog').textContent='';
  });
  $('#collapseBtn').addEventListener('click', ()=>{
    $('#runPanel').classList.remove('open');
  });
  $('#copyMirror').addEventListener('change', e=>{
    $('#mirrorToggle').checked = e.target.checked;
    toast('Copy Demo ‚ûú Real '+(e.target.checked?'ENABLED':'disabled'));
  });

  // ====== INIT DIGITS GRID ======
  (function initDigits(){
    const grid = $('#digitsGrid');
    for (let i=0;i<10;i++){
      const div = document.createElement('div');
      div.className='digit'; div.id='dg'+i;
      div.innerHTML = `<div style="font-size:20px">${i}</div><div><span id="pct${i}">0%</span><span class="muted"> ‚Ä¢ </span><span id="cnt${i}">0</span></div>`;
      grid.appendChild(div);
    }
  })();

  // ====== STARTUP ======
  connect();
  // default subscriptions for chart/strategies/dtrade start on R_10
  resubTicks('R_10');

  // ====== ACCESS CONTROL for Default Bot (inside ‚ãÆ menu) ======
  // If you want to lock default bot with a passcode "deriv@2025", uncomment below:
  /*
  let unlocked = sessionStorage.getItem('unlocked')==='1';
  if (!unlocked){
    const code = prompt('Enter access code to unlock default bot:');
    if (code==='deriv@2025'){ sessionStorage.setItem('unlocked','1'); unlocked=true; }
  }
  if (!unlocked){
    // hide default content
    $('#btnLoadDefault').disabled = true;
    toast('Botbuilder locked. Use Free Bots or Upload Local.');
  }
  */

  // ====== BALANCE VISIBILITY ======
  if (!authToken){
    $('#balanceCluster').classList.add('hide');
  }
})();
</script>

</body>
</html>
