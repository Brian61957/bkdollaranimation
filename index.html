<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deriv Pro Hub</title>
<meta name="theme-color" content="#ffffff" />
<!-- Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --brand-red:#e61e25; /* close to Deriv red */
    --brand-red-dark:#c9191f;
    --brand-green:#13a113;
    --brand-green-soft:#e6f7e6;
    --brand-gray-900:#0f172a;
    --brand-gray-700:#334155;
    --brand-gray-500:#64748b;
    --brand-gray-300:#cbd5e1;
    --brand-gray-200:#e2e8f0;
    --brand-gray-100:#f1f5f9;
    --brand-white:#ffffff;
    --banner-bg:#fff5f5;
    --ok:#16a34a;
    --bad:#dc2626;
    --amber:#f59e0b;
    --panel:#ffffff;
    --shadow: 0 10px 25px rgba(0,0,0,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';background:#fff;color:var(--brand-gray-900)}
  a{color:inherit;text-decoration:none}
  button{font:inherit;cursor:pointer}
  .container{max-width:1200px;margin:0 auto;padding:0 16px}

  /* Top header */
  .topbar{background:#fff;border-bottom:1px solid var(--brand-gray-200);position:sticky;top:0;z-index:50}
  .topbar-inner{display:flex;align-items:center;justify-content:space-between;height:64px;gap:16px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:20px}
  .brand-dot{width:10px;height:10px;border-radius:9999px;background:var(--brand-red)}
  .socials{display:flex;align-items:center;gap:10px}
  .icon-btn{width:36px;height:36px;border-radius:9999px;border:1px solid var(--brand-gray-200);display:flex;align-items:center;justify-content:center;background:#fff}
  .icon-btn img{width:18px;height:18px;display:block}
  .auth-actions{display:flex;align-items:center;gap:10px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--brand-gray-200);background:#fff;font-weight:600}
  .btn.primary{background:var(--brand-red);color:#fff;border-color:var(--brand-red)}
  .btn.primary:hover{background:var(--brand-red-dark)}
  .kebab{position:relative}
  .kebab-menu{width:36px;height:36px;border-radius:10px;border:1px solid var(--brand-gray-200);display:flex;align-items:center;justify-content:center;background:#fff}
  .kebab-dots{width:4px;height:4px;background:#111;border-radius:9999px;box-shadow:0 -7px 0 #111,0 7px 0 #111}
  .menu{position:absolute;top:46px;right:0;background:#fff;border:1px solid var(--brand-gray-200);border-radius:12px;box-shadow:var(--shadow);width:220px;padding:8px;display:none}
  .menu.open{display:block}
  .menu a,.menu button{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border-radius:10px;background:#fff;border:none;text-align:left}
  .menu a:hover,.menu button:hover{background:var(--brand-gray-100)}
  .balance{display:none;align-items:center;gap:10px;background:var(--brand-green-soft);border:1px solid #b7e4b7;color:var(--brand-green);padding:8px 12px;border-radius:9999px;font-weight:700}
  .balance .pill{display:flex;align-items:center;gap:6px}
  .pill .flag{width:16px;height:16px;border-radius:3px;background:#0a0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:800}
  .balance select{border:none;background:transparent;font-weight:700;color:inherit}
  .balance .val{min-width:110px;text-align:right}

  /* Running words banner */
  .banner{background:var(--banner-bg);border-bottom:1px solid var(--brand-gray-200)}
  .marquee{white-space:nowrap;overflow:hidden;padding:8px 0;color:#b42318}
  .marquee span{display:inline-block;padding-left:100%;animation:marquee 18s linear infinite}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  /* Nav */
  .nav{background:#fff;border-bottom:1px solid var(--brand-gray-200)}
  .nav-inner{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
  .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--brand-gray-200);background:#fff;font-weight:600}
  .tab.active,.tab:hover{border-color:var(--brand-red);color:var(--brand-red)}

  /* Sections */
  section{display:none;padding:18px 0}
  section.active{display:block}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
  .card{background:#fff;border:1px solid var(--brand-gray-200);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .card h3{margin:0 0 10px 0;font-size:16px}
  .tile{height:120px;border-radius:14px;background:#f8fafc;border:1px dashed var(--brand-gray-300);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--brand-gray-500)}
  .hidden{display:none !important}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1}
  .row .half{flex:0 0 48%}
  .input, select, textarea{width:100%;padding:10px 12px;border:1px solid var(--brand-gray-300);border-radius:10px;background:#fff}
  textarea{min-height:160px}

  /* Strategy panel (digits) */
  .digits{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:12px}
  .digit{background:#fff;border:1px solid var(--brand-gray-200);border-radius:10px;padding:8px;text-align:center}
  .digit .n{font-weight:800}
  .digit .pct{font-size:12px}
  .digit.max{border-color:var(--ok);background:#eefbf0;color:var(--ok)}
  .digit.min{border-color:var(--bad);background:#fff1f1;color:var(--bad)}
  .last-ticks{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .tick{padding:6px 8px;border-radius:8px;border:1px solid var(--brand-gray-200);background:#fff;font-weight:700}
  .tick.good{background:#eaffea;color:var(--ok);border-color:#c9ebc9}
  .tick.bad{background:#ffecec;color:var(--bad);border-color:#f5c2c2}

  /* Bottom RUN BOT (slides up) */
  .runner{position:fixed;left:0;right:0;bottom:0;z-index:60}
  .runner-toggle{display:flex;justify-content:center}
  .run-btn{margin:8px auto 0 auto;display:flex;align-items:center;gap:10px;background:var(--brand-red);color:#fff;border:none;border-radius:9999px;padding:14px 20px;font-weight:800;box-shadow:0 8px 20px rgba(230,30,37,.35)}
  .run-btn svg{width:18px;height:18px}
  .run-panel{max-width:1200px;margin:8px auto;background:#fff;border:1px solid var(--brand-gray-200);border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -12px 30px rgba(0,0,0,.12);transform:translateY(100%);transition:transform .35s ease}
  .run-panel.open{transform:translateY(0)}
  .run-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--brand-gray-200)}
  .run-body{padding:12px 14px}
  .stats{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .stat{background:#f8fafc;border:1px solid var(--brand-gray-200);border-radius:12px;padding:10px;text-align:center}
  .stat .label{font-size:12px;color:var(--brand-gray-700)}
  .stat .value{font-size:18px;font-weight:800}
  .profit{color:var(--ok)}
  .loss{color:var(--bad)}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn.secondary{background:#fff;border:1px solid var(--brand-gray-300)}
  .btn.warn{background:#fff;border:1px solid #fca5a5;color:#b91c1c}
  .note{font-size:12px;color:var(--brand-gray-700)}

  /* Responsive */
  @media (max-width:1024px){ .grid4{grid-template-columns:repeat(2,1fr)} .stats{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:640px){
    .topbar-inner{gap:8px}
    .brand{font-size:16px}
    .nav-inner{justify-content:flex-start;overflow:auto;white-space:nowrap;padding-bottom:8px}
    .grid4{grid-template-columns:1fr}
    .stats{grid-template-columns:repeat(2,1fr)}
    .auth-actions .btn{padding:8px 10px}
    .icon-btn{width:32px;height:32px}
  }
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="container topbar-inner">
    <div class="brand">
      <span class="brand-dot"></span>
      <span id="siteName">Deriv Pro Hub</span>
      <!-- three dots near name -->
      <div class="kebab">
        <button class="kebab-menu" id="kebabBtn" aria-label="Menu"><span class="kebab-dots"></span></button>
        <div class="menu" id="kebabMenu">
          <button id="accountSettingsBtn">Account settings</button>
          <a id="cashierBtn" href="#" target="_blank" rel="noopener">Open Deriv Cashier</a>
          <button id="logoutBtn">Logout</button>
          <hr style="border:none;border-top:1px solid var(--brand-gray-200);margin:6px 0" />
          <button id="darkModeToggle">🌙 Toggle dark mode</button>
          <button id="devAccessBtn">🔒 Enter private code</button>
        </div>
      </div>
    </div>

    <div class="socials">
      <a class="icon-btn" href="https://chat.whatsapp.com/I9pHdE0sNuTJbKMzgJ84GD?mode=ac_t" target="_blank" rel="noopener" title="WhatsApp group">
        <img alt="WhatsApp" src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg">
      </a>
      <a class="icon-btn" href="https://t.me/+BsA8dvAh_lA2YzRk" target="_blank" rel="noopener" title="Telegram group">
        <img alt="Telegram" src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/telegram.svg">
      </a>
    </div>

    <!-- balance (hidden until login) -->
    <div class="balance" id="balancePill" title="Switch account">
      <div class="pill"><span id="acctFlag" class="flag">D</span><select id="accountSwitcher"></select></div>
      <div class="val" id="balanceVal">$0.00</div>
    </div>

    <!-- auth -->
    <div class="auth-actions" id="authActions">
      <button class="btn" id="signinBtn">Sign in</button>
      <a class="btn primary" id="signupBtn" href="https://oauth.deriv.com/oauth2/authorize?app_id=96503&scope=read,trade&response_type=token&redirect_uri=${location.origin+location.pathname}" target="_self">Sign up</a>
    </div>
  </div>
</div>

<!-- ===== MOVING WORDS ===== -->
<div class="banner">
  <div class="container">
    <div class="marquee">
      <span>Trade responsibly. Analyze before you run bots. Profits and losses are reflected in real-time. — Accumulators, Even/Odd, Matches/Differs, Over/Under now available — Use Demo first, then switch to Real when ready. — Copy Demo ➜ Real toggle available. —</span>
    </div>
  </div>
</div>

<!-- ===== NAV ===== -->
<div class="nav">
  <div class="container nav-inner" id="tabs">
    <button class="tab active" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="botbuilder">Botbuilder</button>
    <button class="tab" data-tab="analysis">Analysis Tool</button>
    <button class="tab" data-tab="signals">Signal Tool</button>
    <button class="tab" data-tab="dtrade">DTrade</button>
    <button class="tab" data-tab="chart">Chart</button>
    <button class="tab" data-tab="strategy">Strategy</button>
    <button class="tab" data-tab="tutorial">Tutorial</button>
  </div>
</div>

<!-- ===== CONTENT ===== -->
<div class="container">

  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <div class="card">
      <h3>Quick start</h3>
      <div id="dashboardTiles" class="grid4">
        <div class="tile" data-load="upload-local">Upload Local Bot</div>
        <div class="tile" data-load="upload-drive">Google Drive Bot</div>
        <div class="tile" data-load="open-botbuilder">Open Botbuilder</div>
        <div class="tile" data-load="quick-strategy">Quick Strategy</div>
      </div>
      <div id="dashboardBotArea" class="hidden">
        <div class="row">
          <div class="half">
            <label>Selected Bot (XML)</label>
            <textarea id="dashBotXml" class="input" placeholder="Bot XML will appear here…"></textarea>
          </div>
          <div class="half">
            <label>Parameters</label>
            <div class="row">
              <div class="half"><label>Market</label><select id="dashMarket" class="input"></select></div>
              <div class="half"><label>Contract</label>
                <select id="dashContract" class="input">
                  <option value="MATCHESDIFFERS">Matches/Differs</option>
                  <option value="EVENODD">Even/Odd</option>
                  <option value="RISEFALL">Rise/Fall</option>
                  <option value="OVERUNDER">Over/Under</option>
                </select>
              </div>
              <div class="half"><label>Stake</label><input id="dashStake" type="number" class="input" value="1" min="0.35" step="0.01"></div>
              <div class="half"><label>Duration (ticks)</label><input id="dashTicks" type="number" class="input" value="3" min="1" max="10"></div>
              <div class="half"><label>Copy Demo → Real</label>
                <button id="copyDemoBtn" class="btn secondary" title="Toggle copy demo to real">OFF</button>
              </div>
              <div class="half"><label>&nbsp;</label>
                <button id="dashLoadBotBtn" class="btn">Load Bot to Runner</button>
              </div>
            </div>
          </div>
        </div>
        <div class="note" style="margin-top:8px">Tip: uploading any bot here will auto-collapse the four tiles above.</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3>Free Bots</h3>
      <div class="row">
        <select id="freeBots" class="input">
          <option value="">— Select a free bot —</option>
          <option value="default">Default Starter Bot</option>
          <option value="entry_touch_bbot">Entry Touch BBot</option>
          <option value="digit_ranger">Digit Ranger Auto Bot</option>
          <option value="rf_premium">Premium Rise/Fall Bot</option>
          <option value="rf_marble">RF Marble B-Bot</option>
          <option value="free_even_odd">Even/Odd Sniper</option>
          <option value="free_matches">Matches/Differs Scout</option>
          <option value="free_accu">Accumulators Helper</option>
        </select>
        <button id="loadFreeBot" class="btn">Load selected bot to Dashboard</button>
      </div>
    </div>
  </section>

  <!-- BOTBUILDER -->
  <section id="botbuilder">
    <div class="card">
      <h3>Default Bot (ready to feed & run)</h3>
      <textarea id="builderBotXml" class="input" placeholder="Default bot XML…"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="builderToDashboard" class="btn">Send to Dashboard</button>
      </div>
    </div>
  </section>

  <!-- ANALYSIS -->
  <section id="analysis">
    <div class="card">
      <h3>Analysis Tool (coming soon)</h3>
      <p>We’ll link this to the advanced analytics module next. For now, plan entries and risk before running bots.</p>
    </div>
  </section>

  <!-- SIGNALS -->
  <section id="signals">
    <div class="card">
      <h3>Signal Tool (coming soon)</h3>
      <p>Reserved for Matches/Differs signal engine. Stay tuned.</p>
    </div>
  </section>

  <!-- DTRADE -->
  <section id="dtrade">
    <div class="card">
      <h3>DTrade</h3>
      <div id="dtradeEmbedWrap" class="hidden">
        <iframe id="dtradeFrame" style="width:100%;height:650px;border:0;border-radius:12px;"></iframe>
      </div>
      <div id="dtradeBlocked" class="hidden">
        <p>Embed blocked by browser. Open in new tab:</p>
        <a id="dtradeOpen" class="btn primary" target="_blank" rel="noopener">Open DTrade</a>
      </div>
    </div>
  </section>

  <!-- CHART -->
  <section id="chart">
    <div class="card">
      <h3>Chart</h3>
      <div id="chartEmbedWrap" class="hidden">
        <iframe id="chartFrame" style="width:100%;height:650px;border:0;border-radius:12px;"></iframe>
      </div>
      <div id="chartBlocked" class="hidden">
        <p>Embed blocked by browser. Open in new tab:</p>
        <a id="chartOpen" class="btn primary" target="_blank" rel="noopener">Open Chart</a>
      </div>
    </div>
  </section>

  <!-- STRATEGY (Digits board like screenshot) -->
  <section id="strategy">
    <div class="card">
      <h3>Strategy — Digits (Matches/Differs • Even/Odd • Over/Under • Rise/Fall)</h3>
      <div class="row">
        <div class="half">
          <label>Volatility Index</label>
          <select id="strMarket" class="input"></select>
        </div>
        <div class="half">
          <label>Duration (ticks)</label>
          <input id="strTicks" class="input" type="number" value="3" min="1" max="10" />
        </div>
      </div>
      <div class="digits" id="digitsGrid"></div>
      <div class="last-ticks" id="lastTicks"></div>
      <div class="row" style="margin-top:10px">
        <div class="half">
          <label>Contract</label>
          <select id="strContract" class="input">
            <option value="MATCHES">Matches</option>
            <option value="DIFFERS">Differs</option>
            <option value="EVEN">Even</option>
            <option value="ODD">Odd</option>
            <option value="RISE">Rise</option>
            <option value="FALL">Fall</option>
            <option value="OVER">Over</option>
            <option value="UNDER">Under</option>
          </select>
        </div>
        <div class="half">
          <label>Target Digit (for Matches/Over/Under)</label>
          <input id="strTargetDigit" class="input" type="number" min="0" max="9" value="9">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="half">
          <button id="strStart" class="btn primary">Start watching</button>
        </div>
        <div class="half">
          <button id="strStop" class="btn secondary">Stop</button>
        </div>
      </div>
      <div class="note" style="margin-top:8px">The board highlights **green** for the most-appearing digit and **red** for the least-appearing digit. Last-tick strip turns green if it matches your target/condition, otherwise red — exactly like your screenshot behavior.</div>
    </div>
  </section>

  <!-- TUTORIAL -->
  <section id="tutorial">
    <div class="card">
      <h3>Tutorial</h3>
      <ul>
        <li>1) Sign in (top-right). Balance pill appears on success.</li>
        <li>2) Choose Demo or Real from the balance pill.</li>
        <li>3) Load a bot from Dashboard tiles or Free Bots dropdown.</li>
        <li>4) Press <strong>RUN BOT</strong> (bottom). Panel slides up, shows live ticks, P/L, runs, wins/losses.</li>
        <li>5) Use Strategy panel to watch digits and confirm entries.</li>
      </ul>
    </div>
  </section>
</div>

<!-- ===== RUN BOT (bottom slide-up) ===== -->
<div class="runner">
  <div class="runner-toggle">
    <button id="runToggleBtn" class="run-btn" aria-expanded="false" title="Run bot">
      <!-- play icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-5.197-3.027A1 1 0 008 9.028v5.944a1 1 0 001.555.832l5.197-3.027a1 1 0 000-1.664z"/></svg>
      RUN BOT
    </button>
  </div>
  <div id="runPanel" class="run-panel" aria-hidden="true">
    <div class="run-head">
      <strong>Bot Runner</strong>
      <div class="actions">
        <button id="runnerStart" class="btn primary">Start</button>
        <button id="runnerStop" class="btn warn">Stop</button>
        <button id="runnerReset" class="btn secondary">Reset</button>
      </div>
    </div>
    <div class="run-body">
      <div class="stats">
        <div class="stat"><div class="label">Runs</div><div id="stRuns" class="value">0</div></div>
        <div class="stat"><div class="label">Wins</div><div id="stWins" class="value profit">0</div></div>
        <div class="stat"><div class="label">Losses</div><div id="stLosses" class="value loss">0</div></div>
        <div class="stat"><div class="label">P/L</div><div id="stPL" class="value">0.00</div></div>
        <div class="stat"><div class="label">Last tick</div><div id="stTick" class="value">—</div></div>
        <div class="stat"><div class="label">Balance</div><div id="stBal" class="value">—</div></div>
      </div>
      <div class="note" style="margin-top:8px">This panel slides up while running and collapses when stopped, exactly like your screenshot behavior. Balance and P/L reflect live trades.</div>
    </div>
  </div>
</div>

<script>
/** =========================
 *  App constants & helpers
 *  ========================= */
const APP_ID = 96503; // your latest App ID
const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&scope=read,trade&response_type=token&redirect_uri=${encodeURIComponent(location.origin + location.pathname)}`;

let WS = null;            // WebSocket connection
let active_loginid = null;// current loginid
let accounts = [];        // list of available accounts
let is_demo = true;       // true demo / false real
let balance_amount = 0;
let last_ticks = [];
const MAX_TICKS = 30;

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const byId = id => document.getElementById(id);
const fmt = n => (Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}));

function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function setTab(name){
  $$('#tabs .tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  $$('section').forEach(s=>s.classList.toggle('active', s.id===name));
}

/** =========================
 *  Header / Menus / Auth
 *  ========================= */
const kebabBtn = byId('kebabBtn');
const kebabMenu = byId('kebabMenu');
kebabBtn.addEventListener('click', ()=>kebabMenu.classList.toggle('open'));
document.addEventListener('click', (e)=>{
  if(!kebabMenu.contains(e.target) && !kebabBtn.contains(e.target)) kebabMenu.classList.remove('open');
});

byId('darkModeToggle').addEventListener('click', ()=>{
  document.documentElement.style.background = '#0b0d12';
  document.body.style.background = '#0b0d12';
  document.body.style.color = '#e5e7eb';
});

byId('devAccessBtn').addEventListener('click', ()=>{
  const code = prompt('Enter private access code:');
  if(code && code.trim() === 'deriv@2025'){
    alert('Access granted.');
  }else{
    alert('Access denied.');
  }
});

byId('accountSettingsBtn').addEventListener('click', ()=> window.open('https://app.deriv.com/account/personal-details', '_blank','noopener'));
byId('cashierBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  window.open('https://app.deriv.com/cashier/deposit', '_blank', 'noopener');
});
byId('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('deriv_tokens');
  location.href = location.origin + location.pathname;
});

/** OAuth sign-in/up */
const signinBtn = byId('signinBtn');
const signupBtn = byId('signupBtn');
signinBtn.addEventListener('click', ()=> { location.href = OAUTH_URL; });

/** Parse tokens returned by OAuth */
(function captureTokensFromUrl(){
  const hash = location.hash || '';
  if(hash.includes('token')){
    const params = new URLSearchParams(hash.replace(/^#/, ''));
    // support token1, token2...
    const tokens = [];
    for(const [k,v] of params.entries()){
      if(/^token\d*$/.test(k)) tokens.push(v);
    }
    if(tokens.length){
      localStorage.setItem('deriv_tokens', JSON.stringify(tokens));
      history.replaceState(null,'',location.origin+location.pathname); // clean hash
    }
  }
})();

/** =========================
 *  WebSocket to Deriv API
 *  ========================= */
function wsConnect(){
  if(WS && WS.readyState===1) return;
  WS = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`);
  WS.onopen = () => {
    const stored = JSON.parse(localStorage.getItem('deriv_tokens')||'[]');
    if(stored.length){
      // authorize the first token by default
      WS.send(JSON.stringify({authorize: stored[0]}));
    }
  };
  WS.onmessage = (msg)=> handleWS(JSON.parse(msg.data));
  WS.onclose = ()=> setTimeout(wsConnect, 1500);
}
wsConnect();

function handleWS(data){
  if(data.msg_type==='authorize'){
    // accounts list
    const details = data.authorize;
    const tokens = JSON.parse(localStorage.getItem('deriv_tokens')||'[]');
    // fetch landing company / accounts
    active_loginid = details.loginid;
    accounts = (details.account_list||[]).map(a=>({loginid:a.loginid,is_virtual:a.is_virtual}));
    // UI update
    afterLoginUI(accounts);
    // subscribe to active balance
    refreshBalance();
    // load markets list
    loadMarkets();
    initStrategyDefaults();
    setupEmbeds();
  }
  if(data.msg_type==='balance'){
    balance_amount = data.balance.balance;
    byId('balanceVal').textContent = '$'+fmt(balance_amount);
    byId('stBal').textContent = '$'+fmt(balance_amount);
  }
  if(data.msg_type==='tick'){
    const t = data.tick;
    updateTickBoard(t.quote);
  }
  if(data.msg_type==='ticks'){
    // history
    const arr = (data.history?.prices||[]);
    arr.forEach(q=>updateTickBoard(q));
  }
  if(data.msg_type==='proposal'){
    // could show quote if desired
  }
  if(data.msg_type==='buy'){
    // wait for sell settlement via profit_table or statement; for tick contracts, balance will soon update
  }
}

function afterLoginUI(list){
  // hide auth, show balance
  byId('authActions').style.display='none';
  const sw = byId('accountSwitcher');
  sw.innerHTML = '';
  list.forEach(acc=>{
    const opt = document.createElement('option');
    opt.value = acc.loginid;
    opt.textContent = `${acc.is_virtual?'Demo':'Real'} — ${acc.loginid}`;
    sw.appendChild(opt);
  });
  byId('balancePill').style.display='flex';
  // set badge
  const current = list.find(a=>a.loginid===active_loginid) || list[0];
  is_demo = !!current.is_virtual;
  byId('acctFlag').textContent = is_demo ? 'D' : '$';
  sw.value = current.loginid;
  sw.addEventListener('change', (e)=>{
    const target = e.target.value;
    switchAccount(target);
  });
}

function switchAccount(loginid){
  active_loginid = loginid;
  // Deriv WS: we need to refresh authorize with a token bound to this loginid.
  // If multiple tokens were returned, try to find matching loginid by re-authorizing each token until account matches.
  const tokens = JSON.parse(localStorage.getItem('deriv_tokens')||'[]');
  (async ()=>{
    for(const tok of tokens){
      WS.send(JSON.stringify({authorize: tok}));
      await new Promise(r=>setTimeout(r,400));
      // handleWS will update active_loginid + account list; we stop when it matches.
      if(active_loginid===loginid) break;
    }
    const acc = accounts.find(a=>a.loginid===loginid);
    is_demo = acc ? !!acc.is_virtual : true;
    byId('acctFlag').textContent = is_demo ? 'D' : '$';
    refreshBalance();
  })();
}

function refreshBalance(){
  WS.send(JSON.stringify({balance:1, subscribe:1}));
}

/** =========================
 *  Tabs
 *  ========================= */
$('#tabs').addEventListener('click',(e)=>{
  if(e.target.classList.contains('tab')){
    setTab(e.target.dataset.tab);
  }
});

/** =========================
 *  Dashboard behavior
 *  ========================= */
const dashboardTiles = byId('dashboardTiles');
const dashBotArea = byId('dashboardBotArea');
const dashBotXml = byId('dashBotXml');
const dashLoadBotBtn = byId('dashLoadBotBtn');

dashboardTiles.addEventListener('click', (e)=>{
  const t = e.target.closest('.tile'); if(!t) return;
  const action = t.getAttribute('data-load');
  if(action==='open-botbuilder'){
    setTab('botbuilder');
    return;
  }
  if(action==='upload-local'){
    const inp = document.createElement('input');
    inp.type='file'; inp.accept='.xml';
    inp.onchange = async () =>{
      const file = inp.files[0];
      const text = await file.text();
      showBotOnDashboard(text);
    };
    inp.click();
    return;
  }
  if(action==='upload-drive'){
    alert('Google Drive picker can be added later. For now, use Upload Local Bot.');
    return;
  }
  if(action==='quick-strategy'){
    setTab('strategy');
    return;
  }
});

function showBotOnDashboard(xml){
  dashBotXml.value = xml;
  hide(dashboardTiles);
  show(dashBotArea);
}

dashLoadBotBtn.addEventListener('click', ()=>{
  // Moves the bot content into the runner context (we just keep it here; runner uses params below)
  alert('Bot is ready in Runner. Open the RUN BOT panel at the bottom and press Start.');
});

/** Free bots selector -> load into dashboard */
byId('loadFreeBot').addEventListener('click', ()=>{
  const id = byId('freeBots').value;
  if(!id){ alert('Choose a bot first.'); return; }
  const xml = getFreeBotXML(id);
  showBotOnDashboard(xml);
});

/** Botbuilder default content -> send to dashboard */
byId('builderToDashboard').addEventListener('click', ()=>{
  const xml = byId('builderBotXml').value.trim();
  if(!xml){ alert('Default bot is empty.'); return; }
  showBotOnDashboard(xml);
});

/** Copy Demo -> Real toggle */
let copyDemo = false;
byId('copyDemoBtn').addEventListener('click', ()=>{
  copyDemo = !copyDemo;
  byId('copyDemoBtn').textContent = copyDemo ? 'ON' : 'OFF';
  byId('copyDemoBtn').classList.toggle('primary', copyDemo);
});

/** Markets loader for selects (volatility indices) */
const VOL_LIST = [
  // As requested, include full list, 1s + standard
  {symbol:'R_10', name:'Volatility 10 Index'},
  {symbol:'R_10_1S', name:'Volatility 10 (1s) Index'},
  {symbol:'R_25', name:'Volatility 25 Index'},
  {symbol:'R_25_1S', name:'Volatility 25 (1s) Index'},
  {symbol:'R_30', name:'Volatility 30 Index'},
  {symbol:'R_30_1S', name:'Volatility 30 (1s) Index'},
  {symbol:'R_50', name:'Volatility 50 Index'},
  {symbol:'R_50_1S', name:'Volatility 50 (1s) Index'},
  {symbol:'R_75', name:'Volatility 75 Index'},
  {symbol:'R_75_1S', name:'Volatility 75 (1s) Index'},
  {symbol:'R_100', name:'Volatility 100 Index'},
  {symbol:'R_100_1S', name:'Volatility 100 (1s) Index'}
];

function loadMarkets(){
  const els = [byId('dashMarket'), byId('strMarket')];
  els.forEach(sel=>{
    sel.innerHTML = '';
    VOL_LIST.forEach(v=>{
      const o = document.createElement('option');
      o.value = v.symbol; o.textContent = v.name;
      sel.appendChild(o);
    });
    sel.value = 'R_10_1S';
  });
}

/** =========================
 *  Strategy Digits board
 *  ========================= */
const digitsGrid = byId('digitsGrid');
const lastTicksEl = byId('lastTicks');
let digitFreq = Array(10).fill(0);
let tickSubId = null;
let currentSymbol = 'R_10_1S';

function initStrategyDefaults(){
  // Build digits boxes
  digitsGrid.innerHTML = '';
  for(let i=0;i<10;i++){
    const d = document.createElement('div');
    d.className='digit'; d.dataset.d=i;
    d.innerHTML = `<div class="n">${i}</div><div class="pct" id="pct-${i}">0%</div>`;
    digitsGrid.appendChild(d);
  }
}

function highlightMinMax(){
  let max = Math.max(...digitFreq);
  let min = Math.min(...digitFreq);
  $$('.digit').forEach(el=>{
    el.classList.remove('max','min');
    const d = parseInt(el.dataset.d,10);
    if(digitFreq[d]===max) el.classList.add('max'); // green
    if(digitFreq[d]===min) el.classList.add('min'); // red
  });
}

function updateTickBoard(quote){
  const str = String(quote);
  const lastDigit = parseInt(str[str.length-1],10);
  last_ticks.push(lastDigit);
  if(last_ticks.length>MAX_TICKS) last_ticks.shift();
  digitFreq[lastDigit]++;

  // Update percentages
  const total = digitFreq.reduce((a,b)=>a+b,0) || 1;
  for(let i=0;i<10;i++){
    byId(`pct-${i}`).textContent = Math.round(digitFreq[i]*100/total) + '%';
  }
  highlightMinMax();

  // Last ticks strip
  lastTicksEl.innerHTML='';
  const target = parseInt(byId('strTargetDigit').value||'9',10);
  const contract = byId('strContract').value;
  last_ticks.slice().reverse().forEach((d,idx)=>{
    const span = document.createElement('span');
    span.className = 'tick';
    let good = false;
    if(contract==='MATCHES') good = (d===target);
    else if(contract==='DIFFERS') good = (d!==target);
    else if(contract==='EVEN') good = (d%2===0);
    else if(contract==='ODD') good = (d%2===1);
    else if(contract==='OVER') good = (d>target);
    else if(contract==='UNDER') good = (d<target);
    else if(contract==='RISE' || contract==='FALL'){
      // For simplicity mark last digit green if higher/lower than previous digit
      const next = last_ticks[last_ticks.length-1-idx-1];
      if(next!==undefined){
        if(contract==='RISE') good = d>next;
        if(contract==='FALL') good = d<next;
      }
    }
    span.textContent = d;
    span.classList.add(good?'good':'bad');
    lastTicksEl.appendChild(span);
  });

  // Mirror “last tick” into runner mini stat
  byId('stTick').textContent = lastDigit;
}

function subscribeTicks(symbol){
  currentSymbol = symbol;
  // unsubscribe previous
  if(tickSubId){
    WS.send(JSON.stringify({forget: tickSubId}));
    tickSubId = null;
  }
  digitFreq = Array(10).fill(0);
  last_ticks = [];
  lastTicksEl.innerHTML='';
  $$('.digit .pct').forEach(e=>e.textContent='0%');
  highlightMinMax();

  WS.send(JSON.stringify({ticks: symbol, subscribe:1}));
  WS.addEventListener('message', function once(e){
    const data = JSON.parse(e.data);
    if(data.msg_type==='tick' && data.subscription && data.subscription.id){
      tickSubId = data.subscription.id;
      WS.removeEventListener('message', once);
    }
  });
}

/** strategy controls */
byId('strStart').addEventListener('click', ()=>{
  const sym = byId('strMarket').value;
  subscribeTicks(sym);
  // also fetch recent
  WS.send(JSON.stringify({ticks_history: sym, count:30, end:'latest', style:'ticks'}));
});
byId('strStop').addEventListener('click', ()=>{
  if(tickSubId){ WS.send(JSON.stringify({forget: tickSubId})); tickSubId=null; }
});

/** =========================
 *  Runner (slide up) & Trading
 *  ========================= */
const runToggleBtn = byId('runToggleBtn');
const runPanel = byId('runPanel');
runToggleBtn.addEventListener('click', ()=>{
  const open = runPanel.classList.toggle('open');
  runToggleBtn.setAttribute('aria-expanded', String(open));
});

let stRuns=0, stWins=0, stLosses=0, stPL=0, runnerOn=false;

byId('runnerReset').addEventListener('click', ()=>{
  stRuns=0; stWins=0; stLosses=0; stPL=0;
  updateRunnerStats();
});

function updateRunnerStats(){
  byId('stRuns').textContent = stRuns;
  byId('stWins').textContent = stWins;
  byId('stLosses').textContent = stLosses;
  const el = byId('stPL');
  el.textContent = fmt(stPL);
  el.classList.toggle('profit', stPL>=0);
  el.classList.toggle('loss', stPL<0);
}

byId('runnerStart').addEventListener('click', ()=>{
  if(!active_loginid){ alert('Sign in first.'); return; }
  runnerOn = true;
  runPanel.classList.add('open');
  autoTradeLoop();
});

byId('runnerStop').addEventListener('click', ()=>{
  runnerOn = false;
});

/** A minimal live trade loop: buys 1-tick Rise/Fall based on last two digits trend (demo-friendly). */
async function autoTradeLoop(){
  const symbol = byId('dashMarket').value || 'R_10_1S';
  const stake = parseFloat(byId('dashStake').value || '1');
  const ticks = parseInt(byId('dashTicks').value || '1',10);

  while(runnerOn){
    // wait until we have at least 2 ticks to decide
    if(last_ticks.length<2){ await sleep(600); continue; }
    const a = last_ticks[last_ticks.length-2], b = last_ticks[last_ticks.length-1];
    const isRise = b > a;

    // get a proposal
    const duration = Math.max(1, Math.min(10, ticks));
    await wsSend({proposal:1, amount:stake, basis:"stake", contract_type: isRise? "CALL":"PUT", currency:"USD", duration: duration, duration_unit:"t", symbol});
    const quote = await waitMsg('proposal');
    if(!quote || quote.error){ await sleep(800); continue; }

    // buy
    await wsSend({buy: quote.proposal.id, price: quote.proposal.ask_price});
    const buyRes = await waitMsg('buy');
    if(!buyRes || buyRes.error){ await sleep(800); continue; }

    stRuns++; updateRunnerStats();

    // wait ~duration * 1s for settlement (1-tick ≈ 1s on 1s indices)
    await sleep(duration*1200+600);

    // refresh balance (server sends on change but we pull too)
    refreshBalance();

    // naive outcome inference: compare current balance change vs stake (approx)
    // Proper way: subscribe to transaction / statement; for simplicity we check balance delta after a short delay
    const before = balance_amount;
    await sleep(800);
    const after = balance_amount;
    const delta = after - before;
    if(delta > 0){ stWins++; stPL += delta; }
    else if(delta < 0){ stLosses++; stPL += delta; }
    updateRunnerStats();

    if(copyDemo && is_demo){
      // If user enabled copy demo->real and has a real account token, we could repeat the trade on real.
      // (Kept simple here to avoid unexpected risk; implement guarded logic if needed.)
      console.log('Copy Demo->Real is ON — implement guarded mirroring when real token available.');
    }
  }
}

function wsSend(obj){ return new Promise(res=>{ WS.send(JSON.stringify(obj)); res(); }); }
function waitMsg(type, timeout=8000){
  return new Promise((resolve)=>{
    const timer = setTimeout(()=>{ cleanup(); resolve(null); }, timeout);
    function handler(ev){
      const d = JSON.parse(ev.data);
      if(d.msg_type===type){
        cleanup(); resolve(d);
      }
    }
    function cleanup(){ clearTimeout(timer); WS.removeEventListener('message', handler); }
    WS.addEventListener('message', handler);
  });
}
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/** =========================
 *  Embeds (DTrade / Chart)
 *  ========================= */
function setupEmbeds(){
  // DTrade
  const dURL = `https://app.deriv.com/`;// their main app (safer than direct bot embed)
  const dFrame = byId('dtradeFrame');
  dFrame.src = dURL;
  try {
    show(byId('dtradeEmbedWrap'));
    hide(byId('dtradeBlocked'));
  } catch(e){
    hide(byId('dtradeEmbedWrap')); show(byId('dtradeBlocked'));
    byId('dtradeOpen').href = dURL;
  }

  // Chart (we’ll point to app chart; if blocked, offer new tab)
  const cURL = `https://app.deriv.com/charts`;
  const cFrame = byId('chartFrame');
  cFrame.src = cURL;
  try {
    show(byId('chartEmbedWrap'));
    hide(byId('chartBlocked'));
  } catch(e){
    hide(byId('chartEmbedWrap')); show(byId('chartBlocked'));
    byId('chartOpen').href = cURL;
  }
}

/** =========================
 *  Default / Free Bots XML
 *  ========================= */
function getDefaultBotXML(){
  return `<!-- DEFAULT_BOT_XML -->
<bot>
  <info>Default Demo Bot — simple Rise/Fall 1-tick trend-follow</info>
  <param name="stake" value="1"/>
  <param name="duration" value="1"/>
  <param name="symbol" value="R_10_1S"/>
  <logic>Use last 2 ticks; if rising -> CALL else PUT</logic>
</bot>`;
}

function getFreeBotXML(id){
  const map = {
    default: getDefaultBotXML(),
    entry_touch_bbot: `<!-- ENTRY_TOUCH_BBOT (from your upload) -->
<bot><name>Entry Touch BBot</name><desc>Touch/No-Touch logic</desc></bot>`,
    digit_ranger: `<!-- Digit Ranger Auto Bot -->
<bot><name>Digit Ranger</name><desc>Digit frequency mapping</desc></bot>`,
    rf_premium: `<!-- Premium Rise/Fall Bot -->
<bot><name>Premium R/F</name><desc>Premium logic</desc></bot>`,
    rf_marble: `<!-- RF MARBLE B-BOT -->
<bot><name>RF Marble</name><desc>Risk-managed R/F</desc></bot>`,
    free_even_odd: `<!-- Even/Odd Sniper -->
<bot><name>Even/Odd Sniper</name><desc>Parity-filtered entries</desc></bot>`,
    free_matches: `<!-- Matches/Differs Scout -->
<bot><name>Matches/Differs Scout</name><desc>Target digit matching</desc></bot>`,
    free_accu: `<!-- Accumulators Helper -->
<bot><name>Accumulators Helper</name><desc>Progressive accumulator assists</desc></bot>`
  };
  return map[id] || getDefaultBotXML();
}

/** Put default bot into Botbuilder on load */
byId('builderBotXml').value = getDefaultBotXML();

/** =========================
 *  Balance visibility rules
 *  ========================= */
(function initUIVisibility(){
  const hasTokens = !!JSON.parse(localStorage.getItem('deriv_tokens')||'[]').length;
  if(hasTokens){
    // trigger authorization (wsConnect already did)
    // Hide auth; show pill after authorize arrives
  }else{
    // show auth only, balance hidden by default
  }
})();

/** =========================
 *  Strategy: change market live
 *  ========================= */
byId('strMarket').addEventListener('change', (e)=>{
  if(tickSubId){ WS.send(JSON.stringify({forget: tickSubId})); tickSubId=null; }
  last_ticks = []; digitFreq = Array(10).fill(0);
  lastTicksEl.innerHTML=''; $$('.digit .pct').forEach(el=>el.textContent='0%');
});

/** =========================
 *  Demos: prefill Dashboard market
 *  ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  // populate dashboard market
  loadMarkets();
});
</script>

</body>
</html>
