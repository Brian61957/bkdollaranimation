<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DBrain Trader</title>
<style>
  :root{
    --brand-red:#ff444f;
    --dark:#111111;
    --ink:#0f172a;
    --text:#0b1220;
    --muted:#6b7280;
    --ok:#16a34a;
    --bad:#ef4444;
    --card:#ffffff;
    --bar:#000000; /* sessions line */
  }
  html,body{margin:0;padding:0;background:#fff;color:var(--text);font:500 14px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
  a{text-decoration:none;color:inherit}
  .wrap{max-width:1200px;margin:0 auto;padding:0 12px}

  /* Top bar */
  .topbar{border-bottom:1px solid #eee;background:#fff;position:sticky;top:0;z-index:50}
  .toprow{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:10px 0}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
  .brand .dotmenu{margin-left:8px;cursor:pointer}
  .auth{display:flex;align-items:center;gap:10px}
  .auth .btn{padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb}
  .auth .btn.primary{background:var(--brand-red);color:#fff;border-color:var(--brand-red)}
  /* balance (hidden before login) */
  .balanceWrap{display:none;align-items:center;gap:8px}
  .balDropdown{appearance:none;border:1px solid #e5e7eb;padding:4px 8px;border-radius:8px;background:#fff}
  .balValue{font-weight:800;color:var(--ok)}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px}

  /* Running words marquee */
  .marquee{background:#fff;border-bottom:1px solid #eee}
  .marquee .line{white-space:nowrap;overflow:hidden}
  .marquee span{display:inline-block;padding:6px 0;animation:scroll 35s linear infinite}
  @keyframes scroll{from{transform:translateX(0)}to{transform:translateX(-50%)}}

  /* Sessions strip (one black line) */
  .tabs{background:var(--bar);color:#fff;position:sticky;top:56px;z-index:40;border-bottom:2px solid var(--brand-red)}
  .tabs .wrap{display:flex;gap:10px;overflow:auto;white-space:nowrap}
  .tab{padding:10px 12px;border-radius:10px}
  .tab.active{background:#1e293b}
  .tab:hover{background:#111827}

  /* Sections */
  section{display:none;padding:18px 0}
  section.active{display:block}

  /* Dashboard cards */
  .grid{display:grid;gap:12px}
  @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:960px){.grid{grid-template-columns:repeat(4,1fr)}}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
  .card h4{margin:4px 0 6px 0;font-size:14px}
  .card .imgFake{height:120px;border-radius:12px;background:#f3f4f6;display:grid;place-items:center;color:#64748b;border:1px dashed #cbd5e1}

  /* Free bots list */
  .botsList{display:grid;gap:10px}
  @media(min-width:720px){.botsList{grid-template-columns:repeat(3,1fr)}}
  .botItem{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff}
  .botItem h5{margin:0 0 6px 0}
  .botItem button{width:100%;padding:8px;border:0;border-radius:10px;background:var(--brand-red);color:#fff}

  /* Strategy panel */
  .strategyTop{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  .strategyTop select,.strategyTop input,.strategyTop button{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff}
  .digits{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:10px}
  .digitCell{border:1px solid #e5e7eb;border-radius:10px;padding:8px;text-align:center}
  .digitCell .d{font-weight:800}
  .digitCell .p{font-size:12px}
  .digitCell.win{background:#ecfdf5;border-color:#86efac}
  .digitCell.lose{background:#fef2f2;border-color:#fecaca}
  .legend{display:flex;gap:8px;align-items:center;color:#64748b;font-size:12px}
  .legend .dot{width:10px;height:10px;border-radius:50%}
  .dot.green{background:var(--ok)}
  .dot.red{background:var(--bad)}
  .lastTicks{margin-top:12px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;max-height:160px;overflow:auto}
  .lastTicks code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace}

  /* Slide-up Run Bar */
  .runbar{position:fixed;bottom:0;left:0;right:0;background:#0b1220;color:#fff;border-top:4px solid var(--brand-red);transform:translateY(calc(100% - 44px));transition:transform .35s ease;z-index:60}
  .runbar.open{transform:translateY(0)}
  .runHandle{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer}
  .runHandle .btn{background:var(--brand-red);border:0;border-radius:10px;padding:8px 12px;color:#fff}
  .runBody{padding:12px;border-top:1px solid #1f2937;display:grid;gap:10px}
  .stats{display:flex;gap:10px;flex-wrap:wrap}
  .stat{background:#111827;border-radius:10px;padding:8px 10px}
  .stat .label{font-size:11px;color:#9ca3af}
  .stat .val{font-weight:800}
  .log{background:#0f172a;border-radius:10px;padding:8px;max-height:160px;overflow:auto;font-family:ui-monospace,monospace}
  .toggles{display:flex;gap:10px;align-items:center}
  .switch{appearance:none;width:44px;height:24px;border-radius:999px;background:#374151;position:relative;outline:none;cursor:pointer}
  .switch:checked{background:var(--ok)}
  .switch:before{content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s}
  .switch:checked:before{left:23px}

  /* 3-dots menu */
  .menu{position:absolute;top:42px;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;display:none;min-width:180px}
  .menu a{display:block;padding:8px;border-radius:8px}
  .menu a:hover{background:#f3f4f6}
  .rel{position:relative}

  /* helper */
  .hide{display:none !important}
</style>
</head>
<body>
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="wrap toprow">
      <div class="brand">
        <span style="font-size:18px">DBrain Trader</span>
        <!-- balance (hidden before auth) -->
        <div id="balanceWrap" class="balanceWrap">
          <span class="pill">
            <select id="acctSwitch" class="balDropdown" title="Switch account">
              <!-- options injected after login -->
            </select>
            <span id="balIcon" title="Account icon">ðŸ’ </span>
          </span>
          <span id="balValue" class="balValue">â€”</span>
        </div>
      </div>

      <div class="auth">
        <a class="btn" id="whatsapp" href="https://chat.whatsapp.com/I9pHdE0sNuTJbKMzgJ84GD?mode=ac_t" target="_blank" rel="noopener">WhatsApp</a>
        <a class="btn" id="telegram" href="https://t.me/+BsA8dvAh_lA2YzRk" target="_blank" rel="noopener">Telegram</a>

        <div class="rel">
          <button class="btn" id="dotsBtn">â‹®</button>
          <div class="menu" id="dotsMenu">
            <a href="#" id="settingsBtn">Account settings</a>
            <a href="https://cashier.deriv.com" target="_blank" rel="noopener">Cashier (Deposit/Withdraw)</a>
            <a href="#" id="darkModeBtn">Toggle Dark mode</a>
            <a href="#" id="logoutBtn">Sign out</a>
          </div>
        </div>

        <a id="signinBtn" class="btn">Sign in</a>
        <a id="signupBtn" class="btn primary">Sign up</a>
      </div>
    </div>

    <!-- RUNNING WORDS -->
    <div class="marquee">
      <div class="wrap line">
        <span>
          Trade responsibly â€¢ Analyze before you run bots â€¢ Demo first, then Real â€¢ Stay disciplined â€¢ Protect capital â€¢
          Trade responsibly â€¢ Analyze before you run bots â€¢ Demo first, then Real â€¢ Stay disciplined â€¢ Protect capital â€¢
        </span>
      </div>
    </div>

    <!-- SESSION TABS -->
    <div class="tabs">
      <div class="wrap" id="tabs">
        <a class="tab active" data-tab="dashboard">Dashboard</a>
        <a class="tab" data-tab="botbuilder">Botbuilder</a>
        <a class="tab" data-tab="analysis">Analysis Tool</a>
        <a class="tab" data-tab="signals">Signal Tool</a>
        <a class="tab" data-tab="freebots">Free Bots</a>
        <a class="tab" data-tab="dtrade">DTrade</a>
        <a class="tab" data-tab="chart">Chart</a>
        <a class="tab" data-tab="strategies">Strategies</a>
        <a class="tab" data-tab="tutorial">Tutorial</a>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <main class="wrap">

    <!-- DASHBOARD -->
    <section id="dashboard" class="active">
      <div class="grid">
        <div class="card">
          <div class="imgFake">Upload Local Bot</div>
          <h4>Upload local XML</h4>
          <input id="localBot" type="file" accept=".xml" />
        </div>
        <div class="card">
          <div class="imgFake">Google Drive Bot</div>
          <h4>Load from Drive (URL)</h4>
          <input id="driveUrl" type="url" placeholder="https://drive.google.com/..." />
          <button id="loadDrive" class="btn primary" style="width:max-content">Load</button>
        </div>
        <div class="card">
          <div class="imgFake">Botbuilder</div>
          <h4>Open Botbuilder</h4>
          <button class="btn" onclick="openTab('botbuilder')">Open</button>
        </div>
        <div class="card">
          <div class="imgFake">Quick Strategy</div>
          <h4>Open Strategies</h4>
          <button class="btn" onclick="openTab('strategies')">Open</button>
        </div>
      </div>

      <div id="botStage" class="card" style="margin-top:12px">
        <h4>Loaded Bot (ready to be fed & run)</h4>
        <textarea id="botXml" style="width:100%;height:180px;border:1px solid #e5e7eb;border-radius:10px;padding:8px" placeholder="Your bot XML will appear here..."></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <input id="stake" type="number" min="0.35" step="0.01" placeholder="Stake" />
          <input id="duration" type="number" min="1" step="1" placeholder="Duration (ticks)" />
          <select id="symbolSel">
            <option value="R_10">Volatility 10 Index</option>
            <option value="R_10_1HZ">Volatility 10 (1s) Index</option>
            <option value="R_25">Volatility 25 Index</option>
            <option value="R_25_1HZ">Volatility 25 (1s) Index</option>
            <option value="R_30">Volatility 30 Index</option>
            <option value="R_30_1HZ">Volatility 30 (1s) Index</option>
            <option value="R_50">Volatility 50 Index</option>
            <option value="R_50_1HZ">Volatility 50 (1s) Index</option>
            <option value="R_75">Volatility 75 Index</option>
            <option value="R_75_1HZ">Volatility 75 (1s) Index</option>
            <option value="R_100">Volatility 100 Index</option>
            <option value="R_100_1HZ">Volatility 100 (1s) Index</option>
          </select>
        </div>
      </div>
    </section>

    <!-- BOTBUILDER (default bot appears here ready to edit) -->
    <section id="botbuilder">
      <div class="card">
        <h4>Default Bot (editable)</h4>
        <textarea id="defaultBot" style="width:100%;height:240px;border:1px solid #e5e7eb;border-radius:10px;padding:8px">&lt;!-- Your default bot XML here (editable) --&gt;</textarea>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="loadDefaultBot()">Load to Dashboard</button>
          <button class="btn primary" onclick="openTab('strategies')">Open Strategies</button>
        </div>
      </div>
    </section>

    <!-- ANALYSIS PLACEHOLDER -->
    <section id="analysis">
      <div class="card"><h4>Analysis Tool</h4><p>Coming next. This will connect to your Google Sheet / in-house models.</p></div>
    </section>

    <!-- SIGNALS PLACEHOLDER -->
    <section id="signals">
      <div class="card"><h4>Signal Tool</h4><p>Coming next. Matches/Differs model here.</p></div>
    </section>

    <!-- FREE BOTS (7 bots) -->
    <section id="freebots">
      <div class="botsList" id="botsList"></div>
    </section>

    <!-- DTRADE (note: many official pages block iframe; we show helpful link if blocked) -->
    <section id="dtrade">
      <div class="card">
        <h4>DTrader</h4>
        <p>If the live platform blocks embedding, use the button below (opens in new tab) to trade while your session stays here.</p>
        <a class="btn primary" target="_blank" rel="noopener" href="https://smarttrader.deriv.com">Open DTrader</a>
      </div>
    </section>

    <!-- CHART (lightweight live tick viewer) -->
    <section id="chart">
      <div class="card">
        <h4>Live Chart (lightweight)</h4>
        <div class="strategyTop">
          <select id="chartSymbol">
            <option value="R_100">Volatility 100 Index</option>
            <option value="R_100_1HZ">Volatility 100 (1s) Index</option>
            <option value="R_75">Volatility 75 Index</option>
            <option value="R_75_1HZ">Volatility 75 (1s) Index</option>
          </select>
          <button id="chartStart">Start</button>
          <button id="chartStop">Stop</button>
        </div>
        <div id="chartLog" class="lastTicks" style="height:220px"></div>
      </div>
    </section>

    <!-- STRATEGIES (live last-digit analyzer, matches/differs/odd/even/over-under) -->
    <section id="strategies">
      <div class="card">
        <h4>Quick Strategy â€” Live Last-Digit Monitor</h4>
        <div class="strategyTop">
          <select id="strSymbol">
            <option value="R_10">Volatility 10</option>
            <option value="R_10_1HZ">Volatility 10 (1s)</option>
            <option value="R_25">Volatility 25</option>
            <option value="R_25_1HZ">Volatility 25 (1s)</option>
            <option value="R_30">Volatility 30</option>
            <option value="R_30_1HZ">Volatility 30 (1s)</option>
            <option value="R_50">Volatility 50</option>
            <option value="R_50_1HZ">Volatility 50 (1s)</option>
            <option value="R_75">Volatility 75</option>
            <option value="R_75_1HZ">Volatility 75 (1s)</option>
            <option value="R_100">Volatility 100</option>
            <option value="R_100_1HZ">Volatility 100 (1s)</option>
          </select>
          <select id="strMode" title="Contract type">
            <option value="match">Matches</option>
            <option value="differs">Differs</option>
            <option value="odd">Odd</option>
            <option value="even">Even</option>
            <option value="over">Over</option>
            <option value="under">Under</option>
          </select>
          <input id="strPredict" type="number" min="0" max="9" step="1" placeholder="Predict digit (0-9)" style="width:150px" />
          <input id="strTicks" type="number" min="1" step="1" value="25" style="width:120px" />
          <button id="strStart">Start</button>
          <button id="strStop">Stop</button>
        </div>

        <div class="legend"><span class="dot green"></span>Most frequent &nbsp; <span class="dot red"></span>Least frequent</div>
        <div id="digitGrid" class="digits"></div>
        <div class="lastTicks">
          <div><strong>Last Ticks</strong></div>
          <code id="ticksArea"></code>
        </div>
      </div>
    </section>

    <!-- TUTORIAL -->
    <section id="tutorial">
      <div class="card">
        <h4>Tutorial</h4>
        <p>1) Sign in (top-right) â†’ 2) Pick Demo in the dropdown â†’ 3) Go to <em>Strategies</em> and watch the live last-digit stats â†’ 4) Use <em>Run Bot</em> when ready.</p>
      </div>
    </section>

  </main>

  <!-- SLIDE-UP RUN BAR -->
  <div id="runbar" class="runbar">
    <div class="runHandle" onclick="toggleRunbar()">
      <div><strong>Run Bot</strong> â€” tap to expand</div>
      <button id="runBtn" class="btn">Run</button>
    </div>
    <div class="runBody">
      <div class="stats">
        <div class="stat"><div class="label">Runs</div><div id="stRuns" class="val">0</div></div>
        <div class="stat"><div class="label">Wins</div><div id="stWins" class="val">0</div></div>
        <div class="stat"><div class="label">Losses</div><div id="stLosses" class="val">0</div></div>
        <div class="stat"><div class="label">Profit</div><div id="stProfit" class="val">0.00</div></div>
      </div>
      <div class="toggles">
        <label><input id="simToggle" class="switch" type="checkbox" /> <span style="margin-left:6px">Demo Trading</span></label>
        <label><input id="liveToggle" class="switch" type="checkbox" disabled /> <span style="margin-left:6px">Real Trading</span></label>
      </div>
      <div id="runLog" class="log"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="resetStats()">Reset</button>
        <button class="btn" onclick="toggleRunbar()">Collapse</button>
      </div>
    </div>
  </div>

<script>
/* ===============================
   CONFIG
================================ */
const APP_ID = 96503;
const BRAND = 'deriv';
const LANG = 'EN';
const REDIRECT_URI = location.origin + location.pathname; // change if your app requires fixed redirect

/* ===============================
   HELPERS
================================ */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const formatMoney = (n) => (Number(n).toFixed(2));
const log = (s) => { const el = $('#runLog'); el.innerHTML = (new Date()).toLocaleTimeString() + " â€” " + s + "<br>" + el.innerHTML; }
function openTab(id){
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===id));
  $$('section').forEach(s=>s.classList.toggle('active', s.id===id));
  if(id==='strategies'){ ensureDigitGrid(); }
}
function toggleRunbar(){
  $('#runbar').classList.toggle('open');
}

/* ===============================
   MENU (3 dots)
================================ */
$('#dotsBtn').addEventListener('click', ()=>{
  $('#dotsMenu').style.display = ($('#dotsMenu').style.display==='block')?'none':'block';
});
document.addEventListener('click', (e)=>{
  if(!e.target.closest('#dotsBtn') && !e.target.closest('#dotsMenu')){
    $('#dotsMenu').style.display='none';
  }
});
$('#darkModeBtn').addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
});
$('#logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('dbrain_tokens');
  localStorage.removeItem('dbrain_selected');
  location.reload();
});

/* ===============================
   AUTH / OAUTH & WEBSOCKET
================================ */
let WS=null;
let TOKENS = {};   // { demo: '...', real: '...' }
let SELECTED = null; // 'demo'|'real'
let currency = 'USD';

function oauthUrl(){
  const url = new URL('https://oauth.deriv.com/oauth2/authorize');
  url.searchParams.set('app_id', APP_ID);
  url.searchParams.set('brand', BRAND);
  url.searchParams.set('l', LANG);
  url.searchParams.set('redirect_uri', REDIRECT_URI);
  // request both demo + real
  url.searchParams.set('scope', 'read,trade');
  return url.toString();
}

// parse tokens from URL hash: token1, token2, acct1, landing_company_short1, ...
(function captureTokensFromUrl(){
  if(location.hash && /token1=/.test(location.hash)){
    const h = new URLSearchParams(location.hash.replace(/^#/, ''));
    // Often token1 == real, token2 == demo (but we detect by landing company short)
    const map = {};
    for(const [k,v] of h.entries()){ map[k]=v; }
    const out = {};
    // Try to detect by landing_company_short
    // Fallback: token2 -> demo, token1 -> real
    if(map.landing_company_short1==='virtual' || map.is_virtual1==='1'){ out.demo = map.token1; }
    if(map.landing_company_short2==='virtual' || map.is_virtual2==='1'){ out.demo = map.token2; }
    if(!out.demo && map.token2) out.demo = map.token2;
    if(map.token1) out.real = map.token1;
    // store
    TOKENS = {...TOKENS, ...out};
    localStorage.setItem('dbrain_tokens', JSON.stringify(TOKENS));
    // Clean hash to avoid re-capture
    history.replaceState(null, '', REDIRECT_URI);
  }
})();

(function loadStoredTokens(){
  try{
    const t = JSON.parse(localStorage.getItem('dbrain_tokens')||'{}');
    TOKENS = t;
    SELECTED = localStorage.getItem('dbrain_selected');
  }catch(e){}
})();

function ensureWS(){
  if(WS && WS.readyState===1) return;
  WS = new WebSocket(wss://ws.derivws.com/websockets/v3?app_id=${APP_ID});
  WS.onopen = ()=>{ /* noop until authorize */ };
  WS.onclose = ()=>{ /* try to reconnect lazily */ };
  WS.onmessage = (msg)=>{
    const data = JSON.parse(msg.data);
    if(data.msg_type==='authorize'){
      currency = data.authorize.currency || 'USD';
      showBalanceUI();
      requestBalance();
    }
    if(data.msg_type==='balance'){
      const bal = data.balance?.balance;
      if(typeof bal!=='undefined'){
        $('#balValue').textContent = formatMoney(bal) + ' ' + currency;
      }
    }
    if(data.msg_type==='tick'){
      handleTick(data.tick);
    }
    if(data.msg_type==='proposal'){
      log(Proposal: ${data.proposal.ask_price} payout ${data.proposal.payout});
    }
    if(data.msg_type==='buy'){
      log(Bought: ${data.buy.contract_id} | price ${data.buy.buy_price});
    }
    if(data.error){
      log("Error: " + (data.error.message||'unknown'));
    }
  };
}
function wsSend(o){ ensureWS(); WS.send(JSON.stringify(o)); }

function doAuthorize(kind){ // kind: 'demo'|'real'
  const token = TOKENS[kind];
  if(!token){ log(No ${kind} token available.); return; }
  wsSend({authorize: token});
}

function requestBalance(){
  wsSend({balance:1, subscribe:1});
}

function showBalanceUI(){
  const hasAny = TOKENS.demo || TOKENS.real;
  $('#balanceWrap').style.display = hasAny ? 'inline-flex' : 'none';
  // build dropdown
  const sel = $('#acctSwitch');
  sel.innerHTML = '';
  if(TOKENS.demo) sel.innerHTML += <option value="demo">D â€¢ Demo</option>;
  if(TOKENS.real) sel.innerHTML += <option value="real">R â€¢ Real</option>;
  // selection
  if(SELECTED && TOKENS[SELECTED]){
    sel.value = SELECTED;
  }else{
    sel.value = TOKENS.demo ? 'demo' : (TOKENS.real ? 'real':'');
  }
  SELECTED = sel.value || null;
  localStorage.setItem('dbrain_selected', SELECTED || '');
  // icon
  $('#balIcon').textContent = (SELECTED==='demo') ? 'ðŸ…“' : 'ðŸ‡ºðŸ‡¸';
  // authorize now
  if(SELECTED) doAuthorize(SELECTED);
}

/* Buttons */
$('#signinBtn').addEventListener('click', ()=>{ location.href = oauthUrl(); });
$('#signupBtn').addEventListener('click', ()=>{ location.href = oauthUrl(); });

/* If tokens exist from earlier session, reveal balance instantly (no auto-redirect) */
if(TOKENS.demo || TOKENS.real){
  showBalanceUI();
}

/* Switcher */
$('#acctSwitch').addEventListener('change', (e)=>{
  SELECTED = e.target.value;
  localStorage.setItem('dbrain_selected', SELECTED);
  $('#balIcon').textContent = (SELECTED==='demo') ? 'ðŸ…“' : 'ðŸ‡ºðŸ‡¸';
  doAuthorize(SELECTED);
});

/* ===============================
   FREE BOTS (7)
================================ */
const FREE_BOTS = [
  {name:'Entry Touch B-Bot', key:'entry_touch', xml:<!-- paste your Entry_Touch_BBot XML here if desired -->},
  {name:'Digit Ranger Auto Bot', key:'digit_ranger', xml:<!-- Digit-Ranger-Auto-Bot.xml -->},
  {name:'Premium Rise/Fall', key:'premium_rf', xml:<!-- binary-bot Premium Rise_Fall .xml -->},
  {name:'RF MARBLE B-BOT', key:'rf_marble', xml:<!-- RF-MARBLE B-BOT.xml -->},
  {name:'Even/Odd Sniper', key:'eo_sniper', xml:<!-- sample even/odd strategy -->},
  {name:'Matches/Differs Pro', key:'md_pro', xml:<!-- sample matches/differs strategy -->},
  {name:'Over/Under Scout', key:'ou_scout', xml:<!-- sample over/under strategy -->},
];
function paintFreeBots(){
  const box = $('#botsList');
  box.innerHTML = '';
  FREE_BOTS.forEach(b=>{
    const div = document.createElement('div');
    div.className='botItem';
    div.innerHTML = <h5>${b.name}</h5><div style="font-size:12px;color:#6b7280;margin-bottom:8px">Click to load into Dashboard</div><button data-k="${b.key}">Load</button>;
    box.appendChild(div);
  });
  box.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.dataset.k;
      const bot = FREE_BOTS.find(x=>x.key===key);
      $('#botXml').value = bot.xml || '<!-- Bot XML here -->';
      openTab('dashboard');
      log(Loaded free bot: ${bot.name});
    });
  });
}
paintFreeBots();

/* Dashboard: load from Drive URL (simple fetch if CORS allows) */
$('#loadDrive').addEventListener('click', async ()=>{
  const url = $('#driveUrl').value.trim();
  if(!url) return;
  try{
    const res = await fetch(url);
    const txt = await res.text();
    $('#botXml').value = txt;
    openTab('dashboard');
    log('Bot loaded from Drive URL.');
  }catch(e){
    log('Failed to load from Drive URL (CORS).');
  }
});
$('#localBot').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  $('#botXml').value = txt;
  log('Local bot loaded.');
});
function loadDefaultBot(){
  $('#botXml').value = $('#defaultBot').value;
  openTab('dashboard');
  log('Default bot moved to Dashboard.');
}

/* ===============================
   STRATEGY: Live Last-Digit Analyzer
================================ */
let tickSub = null;
let tickSymbol = null;
let ticks = [];
let freq = Array(10).fill(0);
function ensureDigitGrid(){
  const g = $('#digitGrid');
  if(g.children.length) return;
  for(let d=0; d<10; d++){
    const cell = document.createElement('div');
    cell.className='digitCell';
    cell.id='dg'+d;
    cell.innerHTML = <div class="d">${d}</div><div class="p">0%</div>;
    g.appendChild(cell);
  }
}
function resetDigits(){
  ticks = [];
  freq = Array(10).fill(0);
  for(let d=0; d<10; d++){
    const c = $('#dg'+d);
    c.querySelector('.p').textContent = '0%';
    c.classList.remove('win','lose');
  }
  $('#ticksArea').textContent = '';
}
function subscribeTicks(symbol){
  ensureWS();
  if(tickSub){ wsSend({forget: tickSub}); tickSub=null; }
  resetDigits();
  tickSymbol = symbol;
  wsSend({ticks: symbol, subscribe:1});
}
function handleTick(t){
  if(!t) return;
  const quote = Number(t.quote);
  const last = String(quote.toFixed(2)).replace(/\D/g,'').slice(-1); // last digit
  const d = Number(last);
  ticks.unshift({epoch:t.epoch, quote, d});
  if(ticks.length>200) ticks.pop();
  // update freq
  const count = ticks.length;
  freq[d] += 1;
  // compute percentages
  const pct = freq.map(x=> Math.round((x/count)*100) || 0);
  // color min/max
  const maxv = Math.max(...pct);
  const minv = Math.min(...pct);
  for(let i=0;i<10;i++){
    const cell = $('#dg'+i);
    cell.querySelector('.p').textContent = pct[i] + '%';
    cell.classList.remove('win','lose');
    if(pct[i]===maxv) cell.classList.add('win');
    if(pct[i]===minv) cell.classList.add('lose');
  }
  // highlight the current last digit (green if match, red if not) relative to prediction
  const pred = Number($('#strPredict').value);
  const mode = $('#strMode').value;
  if(!Number.isNaN(pred)){
    for(let i=0;i<10;i++){ $('#dg'+i).style.outline='none'; }
    // apply rule
    let greenDigits = [];
    if(mode==='match') greenDigits=[pred];
    else if(mode==='differs') greenDigits=[0,1,2,3,4,5,6,7,8,9].filter(x=>x!==pred);
    else if(mode==='odd') greenDigits=[1,3,5,7,9];
    else if(mode==='even') greenDigits=[0,2,4,6,8];
    else if(mode==='over') greenDigits=[5,6,7,8,9];
    else if(mode==='under') greenDigits=[0,1,2,3,4];

    greenDigits.forEach(i=>{ $('#dg'+i).style.outline='2px solid var(--ok)'; });
    const redDigits = [0,1,2,3,4,5,6,7,8,9].filter(i=>!greenDigits.includes(i));
    redDigits.forEach(i=>{ $('#dg'+i).style.outline='2px solid var(--bad)'; });

    // for the very latest tick, mark correctness
    const latest = d;
    // If the latest is in greenDigits â†’ correct (green), else red
    const latestCell = $('#dg'+latest);
    latestCell.style.boxShadow = '0 0 0 3px rgba(0,0,0,0.0)';
    latestCell.animate([{transform:'scale(1.0)'},{transform:'scale(1.05)'},{transform:'scale(1.0)'}],{duration:350});
  }

  // last ticks list
  $('#ticksArea').textContent = ticks.slice(0,40).map(x=>${x.quote.toFixed(2)} (d:${x.d})).join('\n');
}
$('#strStart').addEventListener('click', ()=>{
  const sym = $('#strSymbol').value;
  subscribeTicks(sym);
});
$('#strStop').addEventListener('click', ()=>{
  if(tickSub){ wsSend({forget: tickSub}); tickSub=null; }
});
/* Remember subscription id */
ensureWS();
WS && (WS.onmessage = (m=>{
  const data = JSON.parse(m.data);
  if(data.msg_type==='authorize'){
    currency = data.authorize.currency || 'USD';
    showBalanceUI();
    requestBalance();
  }
  if(data.msg_type==='balance'){
    const bal = data.balance?.balance;
    if(typeof bal!=='undefined'){
      $('#balValue').textContent = formatMoney(bal) + ' ' + currency;
    }
  }
  if(data.msg_type==='tick'){
    // capture subscription id for forget
    if(data.subscription && data.subscription.id) tickSub = data.subscription.id;
    handleTick(data.tick);
  }
  if(data.msg_type==='proposal'){
    log(Proposal: ${data.proposal.ask_price} payout ${data.proposal.payout});
  }
  if(data.msg_type==='buy'){
    log(Bought: ${data.buy.contract_id} | price ${data.buy.buy_price});
  }
  if(data.error){
    log("Error: " + (data.error.message||'unknown'));
  }
}));

/* ===============================
   RUN BOT (simulation / demo trading)
================================ */
let running=false, runs=0, wins=0, losses=0, profit=0;

function resetStats(){
  runs=wins=losses=0; profit=0;
  $('#stRuns').textContent=runs;
  $('#stWins').textContent=wins;
  $('#stLosses').textContent=losses;
  $('#stProfit').textContent=profit.toFixed(2);
  $('#runLog').innerHTML='';
}

$('#runBtn').addEventListener('click', async (e)=>{
  if(!running){
    running=true; e.target.textContent='Stop';
    log('Bot started.');
    startLoop();
  }else{
    running=false; e.target.textContent='Run';
    log('Bot stopped.');
  }
});

async function startLoop(){
  const symbol = $('#symbolSel').value || 'R_100';
  const stake = Number($('#stake').value||1);
  const ticksDur = Number($('#duration').value||3);
  const doDemoTrade = $('#simToggle').checked; // demo trading if authorized with demo
  while(running){
    runs++; $('#stRuns').textContent=runs;
    const outcome = Math.random()<0.55 ? 'WIN':'LOSS'; // simulation outcome
    if(doDemoTrade && SELECTED==='demo'){
      // Minimal legit flow: get proposal and buy a RISE/FALL contract for ticksDur
      try{
        doAuthorize('demo');
        // proposal (simple example: RISE over next ticksDur)
        wsSend({
          proposal:1,
          amount: stake,
          basis: 'stake',
          contract_type: 'RISE',
          currency,
          duration: ticksDur,
          duration_unit: 't',
          symbol: symbol
        });
        log(Proposal requested ${symbol} ticks:${ticksDur} stake:${stake});
      }catch(err){
        log('Demo trade error: '+(err.message||err));
      }
    }
    if(outcome==='WIN'){ wins++; profit += stake; }
    else { losses++; profit -= stake; }
    $('#stWins').textContent=wins;
    $('#stLosses').textContent=losses;
    const pEl = $('#stProfit'); pEl.textContent=profit.toFixed(2); pEl.style.color = profit>=0 ? '#86efac' : '#fecaca';
    log(Result: ${outcome} | P/L: ${profit.toFixed(2)});
    // wait a little
    await new Promise(r=>setTimeout(r, 1200));
  }
}

/* ===============================
   NAV TABS
================================ */
$('#tabs').addEventListener('click',(e)=>{
  const t = e.target.closest('.tab'); if(!t) return;
  openTab(t.dataset.tab);
});

/* ===============================
   SMALL UX TOUCHES
================================ */
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){ $('#runbar').classList.remove('open'); }
});

/* Initial state: hide auth buttons if tokens present */
(function initAuthButtons(){
  const hasAny = TOKENS.demo || TOKENS.real;
  $('#signinBtn').style.display = hasAny ? 'none' : 'inline-block';
  $('#signupBtn').style.display = hasAny ? 'none' : 'inline-block';
})();
</script>
</body>
</html>