<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deriv Pro Tools</title>
<meta name="theme-color" content="#ffffff" />
<!-- App Config -->
<script>
  // ====== IMPORTANT: YOUR APP ID (OAuth + WebSocket) ======
  const APP_ID = 96503; // <-- per your request
  // Your group links
  const WHATSAPP_LINK = "https://chat.whatsapp.com/I9pHdE0sNuTJbKMzgJ84GD?mode=ac_t";
  const TELEGRAM_LINK = "https://t.me/+BsA8dvAh_lA2YzRk";
  // Private admin code to unlock dev tools (paste bots, etc.)
  const OWNER_UNLOCK_CODE = "deriv@2025";
</script>

<style>
  :root{
    --accent:#d32f2f; /* Deriv-like red */
    --accent-2:#b71c1c;
    --bg:#ffffff;
    --fg:#0e0e0f;
    --muted:#6b7280;
    --ok:#16a34a; /* green */
    --bad:#dc2626; /* red */
    --panel:#f7f7f8;
    --chip:#111827;
  }
  .dark {
    --bg:#0b0c0f;
    --fg:#f5f5f7;
    --muted:#a3a3a3;
    --panel:#151821;
    --chip:#e5e7eb;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  a{color:inherit;text-decoration:none}
  button{cursor:pointer;border:0;background:transparent}
  .wrap{max-width:1200px;margin:0 auto;padding:0 12px}
  /* HEADER (Row 1) */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 0;gap:10px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
  .brand .dotmenu{margin-left:8px}
  .right-actions{display:flex;align-items:center;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;background:#fff;color:#111827;border-radius:999px;padding:6px 10px}
  .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  .iconbtn svg{width:18px;height:18px}
  .signin-links{display:flex;align-items:center;gap:8px}
  .hide{display:none !important}

  /* MARQUEE (Row 2) */
  .marquee{background:var(--accent);color:#fff;overflow:hidden;white-space:nowrap}
  .marquee .inner{display:inline-block;padding:8px 0;animation:slide 18s linear infinite}
  @keyframes slide{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

  /* NAV (Row 3) */
  .nav{display:flex;gap:10px;flex-wrap:wrap;padding:10px 0}
  .tab{padding:10px 14px;border-radius:10px;background:var(--panel);color:var(--fg)}
  .tab.active{background:var(--accent);color:#fff}

  /* BALANCE STRIP */
  .balancebar{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:12px;background:var(--panel)}
  .balancebar .bal{font-weight:800}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:8px;padding:4px 8px;font-weight:700}
  .badge.demo{background:#eef2ff;color:#3730a3}
  .badge.real{background:#ecfdf5;color:#065f46}
  .usdflag{display:inline-block;width:16px;height:10px;background:linear-gradient(#b22234 0 30%, #fff 30% 60%, #3c3b6e 60%);border-radius:2px}
  .Ddot{display:inline-flex;width:14px;height:14px;border-radius:50%;background:#111827;color:#fff;align-items:center;justify-content:center;font-size:10px}

  /* GRID sections */
  .section{margin:14px 0;padding:14px;border:1px solid #e5e7eb;border-radius:12px;background:var(--panel)}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1 1 320px}

  /* DASHBOARD cards */
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .card h3{margin:0 0 8px 0}
  .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  @media (max-width:900px){.grid4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:520px){.grid4{grid-template-columns:repeat(1,minmax(0,1fr))}}

  .thumb{height:120px;border-radius:10px;background:#f1f5f9;border:1px dashed #cbd5e1;display:flex;align-items:center;justify-content:center;font-weight:700;color:#64748b}
  .collapse{max-height:0;overflow:hidden;transition:max-height .35s ease}

  /* RUN PANEL (slides up) */
  .runbar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:3px solid var(--accent);box-shadow:0 -8px 32px rgba(0,0,0,.15);transform:translateY(100%);transition:transform .35s ease;z-index:40}
  .runbar.open{transform:translateY(0)}
  .runbar .wrap{display:flex;gap:12px;align-items:center;padding:10px}
  .runstats{display:flex;gap:14px;flex-wrap:wrap}
  .stat{background:var(--panel);border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
  .stat .v{font-weight:800}
  .runbtn-fab{position:fixed;right:14px;top:86px;z-index:50}
  .runbtn{background:var(--accent);color:#fff;border-radius:999px;padding:10px 18px;font-weight:800;box-shadow:0 8px 24px rgba(211,47,47,.35)}
  .runbtn:active{transform:translateY(1px)}

  /* STRATEGIES block (screenshot-accurate) */
  .strat-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .strat-top select,.strat-top input{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff;color:#111827}
  .tick-big{font-size:28px;font-weight:900;letter-spacing:1px}
  .digits{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;margin:10px 0}
  .digit{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:6px 4px;text-align:center}
  .digit.sel{outline:3px solid #fff;box-shadow:0 0 0 2px var(--accent) inset}
  .pc{font-size:11px;margin-top:2px}
  .pc.up{color:var(--ok);font-weight:700}
  .pc.down{color:var(--bad);font-weight:700}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border-radius:10px;padding:10px 14px;font-weight:800;border:1px solid #e5e7eb;background:#fff}
  .btn.buy{background:var(--ok);color:#fff;border-color:transparent}
  .btn.sell{background:var(--bad);color:#fff;border-color:transparent}
  .subtabs{display:flex;gap:8px;margin-top:10px}
  .subtabs .st{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid #e5e7eb}
  .subtabs .st.active{background:var(--accent);color:#fff;border-color:transparent}

  /* Kebab menu */
  .menu{position:relative}
  .menu-panel{position:absolute;top:32px;left:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;min-width:220px;box-shadow:0 12px 32px rgba(0,0,0,.12);display:none;z-index:100}
  .menu.open .menu-panel{display:block}
  .menu-panel a,.menu-panel button{display:flex;gap:8px;align-items:center;padding:10px 12px;width:100%}
  .divider{height:1px;background:#e5e7eb;margin:4px 0}

  /* Footer info */
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <!-- Row 1: Brand + Sign-in & Socials + Menu -->
  <div class="topbar">
    <div class="brand">
      <span style="font-size:22px">Deriv Pro Tools</span>
      <div class="menu dotmenu">
        <button id="kebabBtn" title="Menu">â‹®</button>
        <div class="menu-panel" id="menuPanel">
          <a href="https://app.deriv.com/account/personal-details" target="_blank">Account settings</a>
          <a href="https://app.deriv.com/cashier/deposit" target="_blank">Cashier (Deposit/Withdraw)</a>
          <div class="divider"></div>
          <button id="darkToggle">Toggle dark mode</button>
          <div class="divider"></div>
          <button id="logoutBtn">Logout</button>
          <div class="divider"></div>
          <button id="unlockBtn">Owner unlock</button>
        </div>
      </div>
    </div>
    <div class="right-actions">
      <a class="iconbtn" href="#" id="waBtn" title="WhatsApp" aria-label="WhatsApp">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 2a9.9 9.9 0 0 0-8.1 15.6L3 22l4.6-1.2A10 10 0 1 0 12 2Z" stroke="currentColor"/><path d="M8.5 9.3c0 3.3 4.2 6.2 6.7 6.2.7 0 1.5-.3 2-.8l.6-.6c.3-.3.3-.8 0-1.1l-1.3-1.3c-.3-.3-.8-.3-1.1 0l-.8.8a.8.8 0 0 1-.9.2c-1.3-.5-2.8-1.9-3.3-3.3a.8.8 0 0 1 .2-.9l.8-.8c.3-.3.3-.8 0-1.1L9.9 5.8a.8.8 0 0 0-1.1 0l-.6.6c-.5.5-.7 1.2-.7 2.1Z" fill="currentColor"/></svg>
      </a>
      <a class="iconbtn" href="#" id="tgBtn" title="Telegram" aria-label="Telegram">
        <svg viewBox="0 0 24 24" fill="none"><path d="M21.9 3.2 2.6 10.4c-1.3.5-1.2 2.4.2 2.8l4.8 1.5 1.9 5.7c.4 1.2 2 1.4 2.8.4l2.7-3.3 5 3.7c1 .7 2.4.2 2.6-1.1L24 4.7c.2-1.2-1-2.1-2.1-1.5Z" fill="currentColor"/></svg>
      </a>

      <div id="authArea" class="signin-links">
        <a class="pill" id="loginBtn" href="#">Sign in</a>
        <a class="pill" id="signupBtn" href="#">Sign up</a>
      </div>
      <div id="balancePill" class="pill hide" title="Switch account">
        <span id="accBadge" class="badge"><span class="usdflag"></span></span>
        <span id="balText" class="bal">$0.00</span>
      </div>
    </div>
  </div>

  <!-- Row 2: Marquee -->
  <div class="marquee"><div class="inner">
    ðŸš€ Pro-grade Deriv tools Â· Live ticks Â· Matches/Differs Â· Odd/Even Â· Over/Under Â· Upload or run bots Â· Copy Demo to Real Â· Mobile friendly Â· Affiliate-ready Â· OAuth via App ID 96503
  </div></div>

  <!-- Row 3: Navigation -->
  <div class="nav" id="tabs">
    <a class="tab active" data-tab="dashboard">Dashboard</a>
    <a class="tab" data-tab="botbuilder">Botbuilder</a>
    <a class="tab" data-tab="analysis">Analysis Tool</a>
    <a class="tab" data-tab="signals">Signals Tool</a>
    <a class="tab" data-tab="dtrade">DTrader</a>
    <a class="tab" data-tab="charts">Chart</a>
    <a class="tab" data-tab="strategies">Strategies</a>
    <a class="tab" data-tab="tutorial">Tutorial</a>
  </div>

  <!-- Balance strip (only after login) -->
  <div id="balStrip" class="balancebar hide">
    <span id="acctTypeBadge" class="badge demo"><span class="Ddot">D</span> Demo</span>
    <span id="loginidText" class="muted">â€”</span>
    <span class="muted">â€¢</span>
    <span>Balance:</span>
    <span id="balanceText" class="bal" style="color:var(--ok)">$0.00</span>
    <span class="muted">â€¢</span>
    <label>Account:
      <select id="accountSelect"></select>
    </label>
    <button id="copyMirror" class="btn" title="Copy Demo trades to Real (toggle)">Copy Demo â†’ Real</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="section">
    <div class="row">
      <div class="col">
        <div id="dashCards" class="grid4">
          <div class="card dashcard">
            <h3>Upload bot</h3>
            <div class="thumb">Tap to upload XML</div>
            <input id="uploadInput" type="file" accept=".xml" class="hide" />
            <div class="muted">Upload a Binary Bot XML to load into the Dashboard.</div>
          </div>
          <div class="card dashcard"><h3>Free bot #1</h3><div class="thumb">Select to load</div></div>
          <div class="card dashcard"><h3>Free bot #2</h3><div class="thumb">Select to load</div></div>
          <div class="card dashcard"><h3>Free bot #3</h3><div class="thumb">Select to load</div></div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3>Loaded Bot</h3>
          <div id="botLoadedNote" class="muted">No bot loaded yet.</div>
          <div id="botControls" class="hide">
            <div class="row">
              <div class="col">
                <label>Stake <input id="botStake" type="number" min="0.35" step="0.01" value="1.00" /></label>
              </div>
              <div class="col">
                <label>Ticks <input id="botTicks" type="number" min="1" max="10" value="1" /></label>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <button id="runBot" class="btn buy">RUN BOT</button>
                <button id="stopBot" class="btn sell">STOP</button>
              </div>
              <div class="col runstats">
                <div class="stat">Runs: <span id="stRuns" class="v">0</span></div>
                <div class="stat">Wins: <span id="stWins" class="v">0</span></div>
                <div class="stat">Losses: <span id="stLoss" class="v">0</span></div>
                <div class="stat">P/L: <span id="stPL" class="v">$0.00</span></div>
              </div>
            </div>
          </div>
          <div id="panelCollapse" class="collapse"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTBUILDER -->
  <div id="botbuilder" class="section hide">
    <h3>Default bot</h3>
    <div class="muted">Paste XML below to set the default bot (no base64 needed).</div>
    <textarea id="defaultBotXML" style="width:100%;height:160px;border:1px solid #e5e7eb;border-radius:10px;padding:10px" placeholder="Paste Entry_Touch_BBot.xml content here..."></textarea>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="saveDefaultBot" class="btn">Save as default</button>
      <button id="loadDefaultBot" class="btn buy">Load into Dashboard</button>
    </div>
  </div>

  <!-- ANALYSIS -->
  <div id="analysis" class="section hide">
    <h3>Analysis Tool</h3>
    <div class="muted">Placeholder â€” will connect to our custom analysis engine next.</div>
  </div>

  <!-- SIGNALS -->
  <div id="signals" class="section hide">
    <h3>Signals Tool</h3>
    <div class="muted">Placeholder â€” Matches/Differs signal generator coming next.</div>
  </div>

  <!-- DTRADER -->
  <div id="dtrade" class="section hide">
    <h3>DTrader</h3>
    <div class="muted">Placeholder â€” weâ€™ll embed or mirror DTrader here after your tests.</div>
  </div>

  <!-- CHARTS -->
  <div id="charts" class="section hide">
    <h3>Chart</h3>
    <div class="muted">Live ticks with Accumulators and more â€” coming right after Strategies sign-off.</div>
  </div>

  <!-- STRATEGIES (Matches / Differs / Over-Under / Odd-Even) -->
  <div id="strategies" class="section hide">
    <div class="strat-top">
      <div>
        <label>Volatility:
          <select id="symSelect"></select>
        </label>
      </div>
      <div class="tick-big">Tick: <span id="tickVal">â€”</span></div>
      <div class="controls">
        <label>Duration (ticks)
          <input id="durTicks" type="number" min="1" max="10" value="1" />
        </label>
        <label>Stake ($)
          <input id="stakeAmt" type="number" min="0.35" step="0.01" value="1.00" />
        </label>
      </div>
    </div>

    <div class="digits" id="digitGrid"></div>

    <div class="subtabs">
      <button class="st active" data-strat="matches">Matches</button>
      <button class="st" data-strat="differs">Differs</button>
      <button class="st" data-strat="overunder">Over / Under</button>
      <button class="st" data-strat="oddeven">Odd / Even</button>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap" id="stratControls">
      <!-- Filled dynamically per strategy -->
    </div>
  </div>

  <!-- TUTORIAL -->
  <div id="tutorial" class="section hide">
    <h3>Tutorial</h3>
    <ol>
      <li>Click <b>Sign in</b> (top right). Approve with your Deriv account (App ID 96503).</li>
      <li>Select <b>Strategies</b> to trade Matches / Differs / Over-Under / Odd-Even live.</li>
      <li>Use <b>Dashboard</b> to upload a bot XML and run it (demo/real after login).</li>
      <li>Use the three-dots menu for <b>Account settings</b>, <b>Cashier</b>, <b>Dark mode</b>, <b>Logout</b>.</li>
    </ol>
  </div>
</div>

<!-- Always-visible RUN BOT button -->
<div class="runbtn-fab">
  <button id="openRunPanel" class="runbtn">RUN BOT â–´</button>
</div>

<!-- Slide-up RUN panel -->
<div id="runPanel" class="runbar">
  <div class="wrap">
    <strong>Running bot</strong>
    <div class="runstats">
      <div class="stat">Runs <span id="pRuns" class="v">0</span></div>
      <div class="stat">Wins <span id="pWins" class="v">0</span></div>
      <div class="stat">Losses <span id="pLosses" class="v">0</span></div>
      <div class="stat">P/L <span id="pPL" class="v">$0.00</span></div>
      <div class="stat">Last contract <span id="pLast" class="v">â€”</span></div>
    </div>
    <div style="margin-left:auto">
      <button id="closeRunPanel" class="btn">Collapse â–¾</button>
    </div>
  </div>
</div>

<!-- Deriv API (no external libs needed; raw WS used below) -->
<script>
(function(){
  // ===== UTIL =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = n => (Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const store = {
    get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
    set(k,v){ localStorage.setItem(k,JSON.stringify(v)) },
    del(k){ localStorage.removeItem(k) }
  };
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  // ===== OAUTH LINKS =====
  const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=EN`;
  const SIGNUP_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=EN&signup=1`;

  // ===== STATE =====
  let ws = null;
  let token = null;
  let active_loginid = null;
  let accounts = []; // [{loginid,is_virtual,currency}]
  let mirror_demo_to_real = false;

  let strat = "matches";
  let current_symbol = "R_25";
  let last_ticks = []; // keep last 120 ticks
  let tick_timer = null;

  // ===== UI HOOKS =====
  $("#waBtn").href = WHATSAPP_LINK;
  $("#tgBtn").href = TELEGRAM_LINK;

  $("#loginBtn").addEventListener("click", e=>{
    e.preventDefault(); location.href = OAUTH_URL;
  });
  $("#signupBtn").addEventListener("click", e=>{
    e.preventDefault(); location.href = SIGNUP_URL;
  });

  // Menu
  $("#kebabBtn").addEventListener("click", ()=>{
    $("#menuPanel").parentElement.classList.toggle("open");
  });
  document.addEventListener("click", e=>{
    if (!e.target.closest(".menu")) $$(".menu").forEach(m=>m.classList.remove("open"));
  });
  $("#darkToggle").addEventListener("click", ()=>{
    document.documentElement.classList.toggle("dark");
  });
  $("#logoutBtn").addEventListener("click", ()=>{
    store.del("deriv_token"); store.del("deriv_loginid"); location.href=location.pathname;
  });
  $("#unlockBtn").addEventListener("click", async ()=>{
    const code = prompt("Enter owner code:");
    if (code===OWNER_UNLOCK_CODE) {
      alert("Owner tools unlocked. You can now paste bots in Botbuilder/Free Bots.");
    } else if (code!==null) {
      alert("Wrong code.");
    }
  });

  // Tabs
  $$("#tabs .tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      $$("#tabs .tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const id = t.dataset.tab;
      ["dashboard","botbuilder","analysis","signals","dtrade","charts","strategies","tutorial"].forEach(s=>{
        const el = $("#"+s); if (el) el.classList.add("hide");
      });
      $("#"+id).classList.remove("hide");
      if (id==="strategies") ensureTickLoop();
    });
  });

  // Balance pill click -> switch account
  $("#balancePill").addEventListener("click", ()=>{
    $("#balStrip").classList.toggle("hide");
  });
  $("#accountSelect").addEventListener("change", async ()=>{
    const loginid = $("#accountSelect").value;
    if (!loginid) return;
    // NOTE: Full switch requires token for that account.
    // If token includes both real & demo, Deriv auto-selects; we trigger balance subscribe.
    active_loginid = loginid;
    store.set("deriv_loginid", active_loginid);
    subscribeBalance();
  });

  // Mirror toggle
  $("#copyMirror").addEventListener("click", ()=>{
    mirror_demo_to_real = !mirror_demo_to_real;
    $("#copyMirror").style.background = mirror_demo_to_real ? "linear-gradient(90deg,#10b981,#059669)" : "";
    $("#copyMirror").style.color = mirror_demo_to_real ? "#fff" : "";
  });

  // RUN panel controls
  $("#openRunPanel").addEventListener("click", ()=>$("#runPanel").classList.add("open"));
  $("#closeRunPanel").addEventListener("click", ()=>$("#runPanel").classList.remove("open"));

  // DASHBOARD: upload and free bots
  $("#dashCards .dashcard:first-child .thumb").addEventListener("click", ()=>$("#uploadInput").click());
  $("#uploadInput").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const txt = await f.text();
    loadBotXML(txt, f.name || "Uploaded Bot");
  });
  // free bots thumbnails click -> prompt paste
  $$("#dashCards .dashcard").forEach((c,i)=>{
    if (i===0) return; // first is upload
    c.addEventListener("click", async ()=>{
      const ok = confirm("Paste this bot XML now? (Owner code required)");
      if (!ok) return;
      const code = prompt("Owner code:");
      if (code!==OWNER_UNLOCK_CODE) { alert("Wrong code."); return; }
      const xml = prompt("Paste bot XML content (no base64):","");
      if (!xml) return;
      loadBotXML(xml, `Free Bot #${i}`);
    });
  });

  $("#saveDefaultBot").addEventListener("click", ()=>{
    const x = $("#defaultBotXML").value.trim();
    if (!x) return alert("Paste XML first.");
    store.set("default_bot_xml", x);
    alert("Default bot saved.");
  });
  $("#loadDefaultBot").addEventListener("click", ()=>{
    const x = store.get("default_bot_xml","");
    if (!x) return alert("No default bot saved yet.");
    loadBotXML(x, "Default Bot");
  });

  // STRATEGIES setup
  const symbols = [
    ["R_10","Volatility 10"],["R_10_1S","Volatility 10 (1s)"],
    ["R_25","Volatility 25"],["R_25_1S","Volatility 25 (1s)"],
    ["R_30","Volatility 30"],["R_30_1S","Volatility 30 (1s)"],
    ["R_50","Volatility 50"],["R_50_1S","Volatility 50 (1s)"],
    ["R_75","Volatility 75"],["R_75_1S","Volatility 75 (1s)"],
    ["R_100","Volatility 100"],["R_100_1S","Volatility 100 (1s)"]
  ];
  const symSel = $("#symSelect");
  symbols.forEach(([v,l])=>{
    const o = document.createElement("option"); o.value=v; o.textContent=l;
    if (v===current_symbol) o.selected=true;
    symSel.appendChild(o);
  });
  symSel.addEventListener("change", ()=>{
    current_symbol = symSel.value;
    resubscribeTicks();
  });

  // Strategy subtabs
  $$("#strategies .subtabs .st").forEach(b=>{
    b.addEventListener("click", ()=>{
      $$("#strategies .subtabs .st").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      strat = b.dataset.strat;
      renderStratControls();
    });
  });

  // Build digit grid
  const grid = $("#digitGrid");
  let selectedDigit = 0;
  for(let d=0; d<=9; d++){
    const cell = document.createElement("div");
    cell.className = "digit"+(d===selectedDigit?" sel":"");
    cell.innerHTML = `<div style="font-weight:900;font-size:18px">${d}</div><div id="pc${d}" class="pc">â€”</div>`;
    cell.addEventListener("click", ()=>{
      selectedDigit = d;
      $$("#digitGrid .digit").forEach(el=>el.classList.remove("sel"));
      cell.classList.add("sel");
      renderStratControls();
    });
    grid.appendChild(cell);
  }

  function renderStratControls(){
    const box = $("#stratControls");
    box.innerHTML = "";
    if (strat==="matches"||strat==="differs"){
      const info = document.createElement("div");
      info.className="muted";
      info.textContent = strat==="matches" ? "Buy if last digit equals selected." : "Buy if last digit differs from selected.";
      const buy = document.createElement("button");
      buy.className = "btn buy";
      buy.textContent = strat==="matches"?"BUY Matches":"BUY Differs";
      buy.onclick = ()=>placeDigitTrade(strat, selectedDigit);
      box.append(info, buy);
    } else if (strat==="overunder"){
      const lab = document.createElement("label");
      lab.innerHTML = `Threshold <input id="ovth" type="number" min="0" max="9" value="${Math.max(1,selectedDigit)}" />`;
      const bOver = document.createElement("button");
      bOver.className="btn buy"; bOver.textContent = "BUY Over";
      bOver.onclick = ()=>placeOverUnder("over", Number($("#ovth").value||5));
      const bUnder = document.createElement("button");
      bUnder.className="btn sell"; bUnder.textContent = "BUY Under";
      bUnder.onclick = ()=>placeOverUnder("under", Number($("#ovth").value||5));
      box.append(lab,bOver,bUnder);
    } else if (strat==="oddeven"){
      const bOdd = document.createElement("button");
      bOdd.className="btn buy"; bOdd.textContent="BUY Odd";
      bOdd.onclick = ()=>placeOddEven("odd");
      const bEven = document.createElement("button");
      bEven.className="btn sell"; bEven.textContent="BUY Even";
      bEven.onclick = ()=>placeOddEven("even");
      box.append(bOdd,bEven);
    }
  }
  renderStratControls();

  // ===== WS & AUTH =====
  function wsUrl(){ return `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}` }
  function connect(){
    if (ws) ws.close();
    ws = new WebSocket(wsUrl());
    ws.onopen = ()=> {
      if (token) send({authorize: token});
      subscribeActiveSymbols();
      if ($$(".tab.active")[0]?.dataset.tab==="strategies") ensureTickLoop();
    };
    ws.onmessage = (msg)=> handle(JSON.parse(msg.data));
    ws.onclose = ()=>{};
    ws.onerror = ()=>{};
  }
  function send(obj){ ws?.readyState===1 && ws.send(JSON.stringify(obj)); }
  function handle(d){
    if (d.msg_type==="authorize"){
      const a = d.authorize;
      active_loginid = a.loginid;
      store.set("deriv_loginid", active_loginid);
      accounts = a?.account_list || [];
      setupAccountUI();
      subscribeBalance();
    }
    if (d.msg_type==="balance"){
      const b = d.balance;
      $("#balanceText").textContent = `$${fmt(b.balance)}`;
      $("#balText").textContent = `$${fmt(b.balance)}`;
      $("#loginidText").textContent = b.loginid || active_loginid || "";
      const is_demo = (b.loginid||"").startsWith("VRTC");
      $("#acctTypeBadge").className = "badge "+(is_demo?"demo":"real");
      $("#acctTypeBadge").innerHTML = is_demo? `<span class="Ddot">D</span> Demo` : `<span class="usdflag"></span> Real`;
    }
    if (d.msg_type==="active_symbols"){
      // Nothing to render here; we use static list for V indices.
    }
    if (d.msg_type==="tick"){
      const t = d.tick;
      $("#tickVal").textContent = t.quote?.toFixed(2) ?? "â€”";
      // Track last digits
      const last = Number(String(t.quote).slice(-1));
      if (!isNaN(last)){
        last_ticks.push(last);
        if (last_ticks.length>120) last_ticks.shift();
        updateDigitPercents();
      }
    }
    if (d.msg_type==="proposal"){
      // Could show quote if needed
    }
    if (d.msg_type==="buy"){
      $("#pLast").textContent = d.buy?.contract_id || "bought";
    }
    if (d.msg_type==="proposal_open_contract"){
      const poc = d.proposal_open_contract;
      // track pnl
      const pnl = Number(poc.profit) || 0;
      $("#pPL").textContent = `$${fmt(pnl)}`;
      if (poc.status==="sold"){
        // finalize counters
      }
    }
  }

  function setupAccountUI(){
    // hide signin, show balance
    $("#authArea").classList.add("hide");
    $("#balancePill").classList.remove("hide");
    $("#balStrip").classList.remove("hide");
    // fill accounts
    const sel = $("#accountSelect"); sel.innerHTML="";
    accounts.forEach(a=>{
      const o = document.createElement("option");
      o.value = a.loginid; o.textContent = `${a.loginid}${a.is_virtual?" (Demo)":""}`;
      if (a.loginid===active_loginid) o.selected=true;
      sel.appendChild(o);
    });
  }
  function subscribeBalance(){
    send({balance:1, account: active_loginid||undefined, subscribe:1});
  }
  function subscribeActiveSymbols(){
    send({active_symbols:"brief", product_type:"basic"});
  }

  // Process OAuth token from URL
  (function parseOAuth(){
    const url = new URL(location.href);
    const t = url.searchParams.get("token1") || url.searchParams.get("token");
    if (t){ store.set("deriv_token", t); url.searchParams.delete("token"); url.searchParams.delete("token1"); history.replaceState({}, "", url.toString()); }
    token = store.get("deriv_token", null);
    if (token) connect();
  })();

  // Balance pill opens account strip only after login
  if (!token){
    $("#authArea").classList.remove("hide");
    $("#balancePill").classList.add("hide");
    $("#balStrip").classList.add("hide");
  }

  // ===== TICKS =====
  let tick_sub_id = null;
  function resubscribeTicks(){
    if (tick_sub_id) send({forget: tick_sub_id});
    last_ticks = [];
    $("#tickVal").textContent = "â€”";
    send({ticks: current_symbol, subscribe:1});
  }
  function ensureTickLoop(){
    if (!ws || ws.readyState!==1){ connect(); return; }
    resubscribeTicks();
    if (tick_timer) clearInterval(tick_timer);
    tick_timer = setInterval(updateDigitPercents, 1000);
  }
  function updateDigitPercents(){
    const N = Math.max(1,last_ticks.length);
    const counts = Array(10).fill(0);
    last_ticks.forEach(d=>counts[d]++);
    for(let d=0; d<=9; d++){
      const pc = 100*counts[d]/N;
      const el = $("#pc"+d);
      if (!el) continue;
      el.textContent = isFinite(pc) ? pc.toFixed(1)+"%" : "â€”";
      el.className = "pc "+(pc>=10?"up":"down"); // baseline ~10%
    }
  }

  // ===== TRADING (DIGITS) =====
  function symbolForAPI(code){ return code } // already R_25 etc.

  function placeDigitTrade(kind, barrierDigit){
    if (!token) return alert("Sign in first.");
    const symbol = symbolForAPI(current_symbol);
    const duration = Number($("#durTicks").value||1);
    const amount = Number($("#stakeAmt").value||1);
    const is_match = (kind==="matches");
    const contract_type = is_match ? "DIGITMATCH" : "DIGITDIFF";
    const proposal = {
      proposal:1, amount, basis:"stake",
      contract_type, currency:"USD", duration, duration_unit:"t",
      barrier: String(barrierDigit), symbol
    };
    send(proposal);
    // Auto-buy when we get back quote:
    const onMsg = (ev)=>{
      const d = JSON.parse(ev.data);
      if (d.msg_type==="proposal" && d.proposal?.contract_type===contract_type){
        ws.removeEventListener("message", onMsg);
        send({buy: d.proposal.id, price: amount});
        bumpRunCounters("BUY "+contract_type);
      }
    };
    ws.addEventListener("message", onMsg);
  }

  function placeOverUnder(which, threshold){
    if (!token) return alert("Sign in first.");
    const symbol = symbolForAPI(current_symbol);
    const duration = Number($("#durTicks").value||1);
    const amount = Number($("#stakeAmt").value||1);
    const ct = which==="over" ? "DIGITOVER" : "DIGITUNDER";
    const proposal = {
      proposal:1, amount, basis:"stake",
      contract_type: ct, currency:"USD", duration, duration_unit:"t",
      barrier: String(Math.max(0, Math.min(9, threshold))), symbol
    };
    send(proposal);
    const onMsg = (ev)=>{
      const d = JSON.parse(ev.data);
      if (d.msg_type==="proposal" && d.proposal?.contract_type===ct){
        ws.removeEventListener("message", onMsg);
        send({buy: d.proposal.id, price: amount});
        bumpRunCounters("BUY "+ct);
      }
    };
    ws.addEventListener("message", onMsg);
  }

  function placeOddEven(which){
    if (!token) return alert("Sign in first.");
    const symbol = symbolForAPI(current_symbol);
    const duration = Number($("#durTicks").value||1);
    const amount = Number($("#stakeAmt").value||1);
    const ct = which==="odd" ? "DIGITODD" : "DIGITEVEN";
    const proposal = {
      proposal:1, amount, basis:"stake",
      contract_type: ct, currency:"USD", duration, duration_unit:"t",
      symbol
    };
    send(proposal);
    const onMsg = (ev)=>{
      const d = JSON.parse(ev.data);
      if (d.msg_type==="proposal" && d.proposal?.contract_type===ct){
        ws.removeEventListener("message", onMsg);
        send({buy: d.proposal.id, price: amount});
        bumpRunCounters("BUY "+ct);
      }
    };
    ws.addEventListener("message", onMsg);
  }

  // ===== RUN STATS (for slide-up panel and dashboard panel) =====
  let runs=0,wins=0,losses=0,pl=0;
  function bumpRunCounters(last){
    runs++; $("#pRuns").textContent=runs; $("#stRuns").textContent=runs;
    $("#pLast").textContent = last;
    // P/L live updates come via Poc; but we reflect stake for UX
  }

  // ===== BOT XML LOADING (visual) =====
  function loadBotXML(xml, name="Bot"){
    $("#botLoadedNote").classList.add("hide");
    $("#botControls").classList.remove("hide");
    $("#panelCollapse").style.maxHeight = "0px";
    // Collapse dashboard thumbnails
    $("#dashCards").style.maxHeight = "0px"; $("#dashCards").style.overflow="hidden";
    setTimeout(()=>{ $("#panelCollapse").style.maxHeight="160px"; $("#panelCollapse").innerHTML =
      `<div class="muted">Loaded: <b>${name}</b> (XML ${xml.length.toLocaleString()} chars)</div>
       <div class="muted">Configure stake & ticks then click <b>RUN BOT</b>. Results appear in the slide-up panel.</div>`; }, 200);
  }
  $("#runBot").addEventListener("click", ()=>{
    $("#runPanel").classList.add("open");
    // Here weâ€™ll just trigger a Matches purchase using current grid selection
    placeDigitTrade("matches",  selectedDigit);
  });
  $("#stopBot").addEventListener("click", ()=>{
    alert("Bot stopped (no open subscriptions kept).");
  });

  // ===== INIT Strategy default =====
  ensureTickLoop();
})();
</script>
</body>
</html>
