<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BK Dollar Trader — Deriv Connected</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<style>
  :root{
    --deriv-red:#e10600; --deriv-red-2:#c20500;
    --nav:#081a2b; --ink:#0f1720; --muted:#6b7280;
    --panel:#f7f9ff; --line:#e5e7eb; --tile:#0b223f; --tile-ink:#d8e6ff;
    --green:#16a34a; --blue:#2563eb;
    --marqH:32px; --headH:64px; --tabsH:52px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:#fff;color:#111;font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:inherit;text-decoration:none}

  /* Top running words */
  .topmarq{position:sticky;top:0;z-index:90;background:var(--deriv-red);color:#fff;height:var(--marqH);display:flex;align-items:center}
  .wrap{max-width:1240px;margin:0 auto;padding:0 16px}
  .ticker{overflow:hidden;white-space:nowrap}
  .ticker span{display:inline-block;padding-left:100%;animation:marq 16s linear infinite;font-weight:900}
  @keyframes marq{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  /* Header (sticky) */
  .top{position:sticky;top:var(--marqH);z-index:80;background:#fff;border-bottom:4px solid var(--deriv-red);height:var(--headH)}
  .row{height:var(--headH);display:flex;align-items:center;gap:12px}
  .brand{font-weight:900;letter-spacing:.2px}
  .social{display:flex;gap:8px;margin-left:8px}
  .iconbtn{width:36px;height:36px;border-radius:9px;display:grid;place-items:center;background:#0b223f;color:#fff}
  .iconbtn:hover{filter:brightness(1.12)}
  .btn{padding:8px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
  .btn.primary{background:var(--deriv-red);color:#fff}
  .btn.dark{background:#0b223f;color:#fff}

  .login{margin-left:auto;display:flex;gap:10px;align-items:center}
  .balance{display:flex;align-items:center;gap:10px;background:#f3f6fc;border:1px solid #dbe3f0;border-radius:12px;padding:6px 10px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.demo{background:#64748b}
  .dot.real{background:#16a34a}
  .dropdown{position:relative}
  .menu{position:absolute;top:120%;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);min-width:220px;display:none;overflow:hidden}
  .menu.open{display:block}
  .menu button{display:block;width:100%;padding:10px 14px;text-align:left;background:#fff;border:0;cursor:pointer}
  .menu button:hover{background:#f4f6fa}
  .toggle{border-radius:20px;padding:7px 12px;background:#9aa3ad;color:#fff;font-weight:900;cursor:pointer;border:0}
  .toggle.on{background:var(--green)}
  .hidden{display:none}

  /* Tabs (sticky) */
  .tabs{position:sticky;top:calc(var(--marqH) + var(--headH));z-index:70;background:var(--nav);color:#deecff;height:var(--tabsH)}
  .tabs .wrap{height:var(--tabsH);display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .tab{padding:10px 14px;border-radius:10px;opacity:.92;cursor:pointer;user-select:none}
  .tab:hover,.tab.active{background:#102a4a;opacity:1}

  /* Content */
  main.wrap{padding:16px}
  .view{display:none}
  .view.active{display:block}
  .muted{color:var(--muted)}

  /* Tiles like screenshot */
  .tiles{display:grid;grid-template-columns:repeat(4,1fr);gap:22px;margin:12px 0 18px}
  .tile{background:var(--tile);color:var(--tile-ink);border-radius:16px;padding:22px 16px;display:grid;gap:8px;justify-items:center;min-height:160px;outline:2px solid rgba(255,255,255,.06)}
  .tile .big{font-size:44px;line-height:1}
  .tile .title{font-size:15px;font-weight:900}
  .tile .sub{font-size:12.5px;opacity:.9}
  .tile:hover{outline-color:rgba(255,255,255,.18);cursor:pointer}
  @media (max-width:1100px){ .tiles{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:800px){ .tiles{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:520px){ .tiles{grid-template-columns:1fr} }

  .panel{background:var(--panel);border:1px solid #e1e6f3;border-radius:14px;padding:14px}
  .section{background:#0f315f;color:#fff;border-radius:12px;padding:10px 12px;margin:10px 0}
  .grid2{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
  @media (max-width:980px){ .grid2{grid-template-columns:1fr} }

  .field{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  select,input[type="number"],input[type="text"],input[type="file"]{padding:8px 10px;border:1px solid #ccd6ea;border-radius:10px;background:#fff}

  /* Records */
  .records{overflow:auto;border:1px solid var(--line);border-radius:10px;max-height:380px;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid #edf2f7;text-align:left;font-size:14px}
  .pl-green{color:#16a34a;font-weight:800}
  .pl-red{color:#dc2626;font-weight:800}

  /* Run bar + slide-up tray */
  .runbar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);z-index:60}
  .runwrap{max-width:980px;margin:0 auto;padding:12px 10px;display:flex;gap:10px;align-items:center}
  .runbtn{display:flex;align-items:center;gap:10px;background:var(--green);color:#fff;padding:12px 18px;border-radius:12px;font-weight:900;border:0;cursor:pointer}
  .runbtn .tri{width:0;height:0;border-left:12px solid #fff;border-top:8px solid transparent;border-bottom:8px solid transparent}
  .status{flex:1;height:10px;border-radius:8px;background:#e8f0ff;overflow:hidden}
  .status>i{display:block;height:100%;width:0;background:var(--blue)}
  .risk{margin-left:auto;background:#ef4444;color:#fff;padding:10px 12px;border-radius:10px}

  .tray{position:fixed;left:0;right:0;bottom:-62vh;background:#fff;border-top:2px solid var(--line);box-shadow:0 -12px 36px rgba(0,0,0,.16);height:62vh;transition:bottom .35s ease;z-index:65}
  .tray.open{bottom:56px}
  .tray .wrap{height:100%;display:grid;grid-template-rows:auto 1fr}
  .tray h3{margin:12px 0 6px}

  /* Frame areas fill available viewport */
  .framewrap{height:calc(100vh - (var(--marqH) + var(--headH) + var(--tabsH) + 32px));border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .framewrap iframe{width:100%;height:100%;border:0}

  /* Login gate */
  .gate{position:fixed;inset:0;background:rgba(255,255,255,.96);display:none;align-items:center;justify-content:center;z-index:95}
  .gate.show{display:flex}
  .gate .box{border:1px solid var(--line);border-radius:16px;padding:22px;background:#fff;max-width:560px;text-align:center}
  .gate .box h2{margin:0 0 6px}
  .gate .box p{color:var(--muted);margin:0 0 16px}

  .note{font-size:12.5px;color:var(--muted)}
</style>
</head>
<body>

<!-- Running words -->
<div class="topmarq">
  <div class="wrap">
    <div class="ticker"><span>Trade smarter • Control risk • Let the bot work • Watch live ticks and balances update in real time • Consistency wins •</span></div>
  </div>
</div>

<!-- Header -->
<header class="top">
  <div class="wrap row">
    <div class="brand">BK Dollar Trader</div>

    <div class="social">
      <a class="iconbtn" title="WhatsApp" href="https://chat.whatsapp.com/I9pHdE0sNuTJbKMzgJ84GD?mode=ac_t" target="_blank" rel="noopener" aria-label="WhatsApp">🟢</a>
      <a class="iconbtn" title="Telegram" href="https://t.me/+BsA8dvAh_lA2YzRk" target="_blank" rel="noopener" aria-label="Telegram">📨</a>
    </div>

    <div class="login">
      <div id="acctBox" class="balance dropdown hidden" role="button" aria-haspopup="true">
        <div id="acctDot" class="dot demo"></div>
        <div>
          <div id="acctType" style="font-weight:900">Demo</div>
          <div id="acctBal" class="muted">USD 10,000.00</div>
        </div>
        <svg id="acctBtn" width="18" height="18" viewBox="0 0 24 24"><path fill="#555" d="M7 10l5 5 5-5"/></svg>
        <div id="acctMenu" class="menu">
          <div style="padding:10px 14px" class="muted">Switch account</div>
          <button id="useDemo">Demo (Virtual)</button>
          <button id="useReal">Real (CR)</button>
          <hr/>
          <button id="addToken">Add another token…</button>
        </div>
      </div>

      <button id="copyToggle" class="toggle hidden" title="Copy Demo → Real">Copy Demo → Real: OFF</button>

      <button id="loginBtn" class="btn primary">Log in</button>
      <button id="logoutBtn" class="btn dark hidden">Log out</button>
    </div>
  </div>
</header>

<!-- Tabs -->
<nav class="tabs">
  <div class="wrap">
    <span class="tab active" data-tab="dashboard">Dashboard</span>
    <span class="tab" data-tab="builder">Botbuilder</span>
    <span class="tab" data-tab="analysis">Analysis Tool</span>
    <span class="tab" data-tab="signals">Signal Tool</span>
    <span class="tab" data-tab="freebots">Free Bots</span>
    <span class="tab" data-tab="dtrade">DTrade</span>
    <span class="tab" data-tab="chart">Chart</span>
    <span class="tab" data-tab="tutorials">Tutorial</span>
  </div>
</nav>

<main class="wrap">

  <!-- Dashboard -->
  <section id="dashboard" class="view active">
    <h2>Load or build your bot</h2>
    <div class="note">Tiles like your screenshot: upload, builder, quick strategy, Drive.</div>

    <div class="tiles">
      <div class="tile" id="tLocal" tabindex="0" role="button">
        <div class="big">📱</div>
        <div class="title">Local</div><div class="sub">Upload XML bot</div>
        <input id="fileLocal" type="file" accept=".xml" class="hidden"/>
      </div>
      <div class="tile" id="tBuilder" tabindex="0" role="button">
        <div class="big">🧩</div>
        <div class="title">Bot builder</div><div class="sub">Create from blocks</div>
      </div>
      <div class="tile" id="tQuick" tabindex="0" role="button">
        <div class="big">🧠</div>
        <div class="title">Quick strategy</div><div class="sub">Rise on Vol 10 (1s)</div>
      </div>
      <div class="tile" id="tDrive" tabindex="0" role="button">
        <div class="big">🟨</div>
        <div class="title">Google Drive</div><div class="sub">Load from Drive (next)</div>
      </div>
    </div>

    <div id="chosenBot" class="panel hidden" aria-live="polite">
      <strong>Loaded bot:</strong> <span id="botName">—</span>
      <div class="muted">Ready. Configure below or press <b>Run</b>.</div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div class="panel">
        <div class="section">Trade parameters</div>
        <div class="field">
          <label>Market</label>
          <select id="marketSel"><option value="synthetic_index">Derived</option></select>
          <select id="symbolSel"></select>
        </div>
        <div class="field">
          <label>Type</label>
          <select id="sideSel"><option value="CALL">Rise</option><option value="PUT">Fall</option></select>
          <label>Duration</label>
          <input id="dur" type="number" value="1" min="1" style="width:92px" />
          <select id="unit"><option value="t">Ticks</option></select>
          <label>Stake (USD)</label>
          <input id="stake" type="number" value="1" step="0.35" min="0.35" style="width:112px"/>
        </div>
        <div class="field"><span class="muted">Live ticks:</span></div>
        <div id="ticksBox" class="panel" style="height:210px;overflow:auto;background:#0b223f;color:#c6d4ff"></div>
      </div>

      <div class="panel">
        <div class="section">Results</div>
        <div class="records" style="max-height:410px">
          <table id="resTbl"><thead><tr><th>Time</th><th>Symbol</th><th>Side</th><th>Buy</th><th>Payout</th><th>P/L</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="note" style="margin-top:6px">Balances reflect your Deriv account. Demo is typically around USD 10,000 on official Deriv.</div>
      </div>
    </div>
  </section>

  <!-- Bot Builder (official) -->
  <section id="builder" class="view">
    <div class="field" style="justify-content:space-between">
      <div><button id="copyBtn_builder" class="toggle hidden">Copy Demo → Real: OFF</button></div>
      <div class="muted">Official Deriv Bot embedded — built-in Run & result tray.</div>
    </div>
    <div class="framewrap"><iframe id="iframeBot" src="" allow="clipboard-read; clipboard-write"></iframe></div>
    <div class="note" style="margin-top:6px">If your browser blocks iframes, open the Bot from your Deriv account.</div>
  </section>

  <!-- Analysis (on hold) -->
  <section id="analysis" class="view">
    <div class="panel">
      <h2>Analysis Tool — Coming Soon</h2>
      <p class="muted">We’ll connect our analytics engine here.</p>
      <button id="copyBtn_analysis" class="toggle hidden">Copy Demo → Real: OFF</button>
    </div>
  </section>

  <!-- Signals (on hold) -->
  <section id="signals" class="view">
    <div class="panel">
      <h2>Signal Tool — Coming Soon</h2>
      <p class="muted">Realtime alerts will appear here.</p>
      <button id="copyBtn_signals" class="toggle hidden">Copy Demo → Real: OFF</button>
    </div>
  </section>

  <!-- Free bots -->
  <section id="freebots" class="view">
    <h2>Free Bots</h2>
    <div class="tiles">
      <div class="tile fb" data-name="Digits Even/Odd"><div class="big">#️⃣</div><div class="title">Digits Even/Odd</div><div class="sub">Volatility 10 (1s)</div></div>
      <div class="tile fb" data-name="Trend Rider"><div class="big">📈</div><div class="title">Trend Rider</div><div class="sub">Volatility 75</div></div>
      <div class="tile fb" data-name="Spike Guard"><div class="big">⚡</div><div class="title">Spike Guard</div><div class="sub">Volatility 100</div></div>
      <div class="tile fb" data-name="Touch/No-Touch"><div class="big">🫱</div><div class="title">Touch/No-Touch</div><div class="sub">Volatility 25</div></div>
    </div>
    <p class="note" style="margin-top:8px">Click any to auto-load into Dashboard.</p>
  </section>

  <!-- DTrader (official) -->
  <section id="dtrade" class="view">
    <div class="field" style="justify-content:space-between">
      <h2>DTrader</h2>
      <button id="copyBtn_dtrade" class="toggle hidden">Copy Demo → Real: OFF</button>
    </div>
    <div class="framewrap"><iframe id="iframeDtrader" src=""></iframe></div>
    <div class="note" style="margin-top:6px">Manual trading — identical to official Deriv.</div>
  </section>

  <!-- Chart (Accumulators default) -->
  <section id="chart" class="view">
    <h2 style="margin-bottom:10px">Chart — Accumulators</h2>
    <div class="framewrap"><iframe id="iframeChart" src=""></iframe></div>
    <div class="note" style="margin-top:6px">Switch to Even/Odd, Matches/Differs, Over/Under inside the panel without leaving.</div>
  </section>

  <!-- Tutorial -->
  <section id="tutorials" class="view">
    <h2>Tutorial</h2>
    <ol>
      <li>Click <b>Log in</b> (App ID <b>96054</b>) — authorize on deriv.com.</li>
      <li>Use <b>Dashboard</b> or <b>Botbuilder</b> to load/run a bot.</li>
      <li>Toggle <b>Copy Demo → Real</b> to mirror trades (requires Demo & Real tokens).</li>
      <li>Trade manually in <b>DTrade</b> or use <b>Chart</b> for Accumulators & more.</li>
    </ol>
  </section>

</main>

<!-- Slide-up trade results -->
<div id="tray" class="tray">
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h3>Transactions</h3>
      <div>
        <button id="stopBtn" class="toggle" style="background:#ef4444">Stop</button>
        <button id="resetBtn" class="toggle">Reset</button>
      </div>
    </div>
    <div class="records">
      <table id="trayTbl"><thead><tr><th>Time</th><th>Symbol</th><th>Side</th><th>Buy</th><th>Payout</th><th>P/L</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- Bottom run bar -->
<div class="runbar">
  <div class="runwrap">
    <button id="runBtn" class="runbtn"><span class="tri"></span> Run</button>
    <div class="status"><i id="prog"></i></div>
    <div id="runStatus" class="muted">Bot is not running</div>
    <div class="risk">Risk Disclaimer</div>
  </div>
</div>

<!-- Login Gate -->
<div id="gate" class="gate show">
  <div class="box">
    <h2>Login required</h2>
    <p>Connect your Deriv account to start. Demo is around <b>USD 10,000</b> by default on official Deriv.</p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
      <button id="gateLogin" class="btn primary">Log in with Deriv</button>
      <button id="gateHelp" class="btn dark">Why login?</button>
    </div>
    <p class="note" style="margin-top:10px">You’ll be redirected to deriv.com to authorize securely, then return here.</p>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const APP_ID = 96054; // your updated App ID
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=EN&brand=deriv&redirect_uri=${encodeURIComponent(location.href.split('#')[0])}`;

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => Number(n||0).toFixed(2);
const now = () => new Date().toLocaleTimeString();

/* ===== State ===== */
let ws=null, accountInfo=null;
let tokenDemo = localStorage.getItem('deriv_token_demo') || null;
let tokenReal = localStorage.getItem('deriv_token_real') || null;
let activeToken = localStorage.getItem('deriv_token_active') || null;
let mirrorOn = localStorage.getItem('sync_mirror')==='1';
let tickerId=null, currentSymbol='R_10_1S';
let running=false, anim=null, prog=0, lastSide='CALL', lastProposalEcho=null;
let txnStreamOpen=false;

/* ===== Tabs ===== */
function setTab(name){
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  $$('.view').forEach(v=>v.classList.toggle('active', v.id===name));
}
$$('.tab').forEach(t=>t.addEventListener('click',()=>setTab(t.dataset.tab)));
setTab('dashboard');

/* ===== OAuth capture (optional tokens) ===== */
(function captureTokens(){
  const p = new URLSearchParams(location.search);
  const t1=p.get('token1'), a1=p.get('acct1');
  const t2=p.get('token2'), a2=p.get('acct2');
  let stored=false;
  if (t1 && a1){ if(/VRT/i.test(a1)){ tokenDemo=t1; localStorage.setItem('deriv_token_demo',t1);} else { tokenReal=t1; localStorage.setItem('deriv_token_real',t1);} stored=true; }
  if (t2 && a2){ if(/VRT/i.test(a2)){ tokenDemo=t2; localStorage.setItem('deriv_token_demo',t2);} else { tokenReal=t2; localStorage.setItem('deriv_token_real',t2);} stored=true; }
  if (stored){ history.replaceState({},'',location.pathname); activeToken = tokenReal || tokenDemo; localStorage.setItem('deriv_token_active',activeToken); }
})();

/* ===== WebSocket ===== */
function connect(){
  if (ws) try{ ws.close(); }catch(e){}
  ws = new WebSocket(WS_URL);
  ws.onopen = ()=>{ if (activeToken) send({authorize:activeToken}); updateAuthUI(); };
  ws.onmessage = onMsg;
  ws.onerror = ()=>toast('WebSocket error');
}
function send(o){ if (ws && ws.readyState===1) ws.send(JSON.stringify(o)); }
connect();

/* ===== Gate & Auth UI ===== */
function updateGate(){ $('#gate').classList.toggle('show', !accountInfo); }
function setCopyLabel(el){ el.classList.toggle('on', mirrorOn); el.textContent='Copy Demo → Real: '+(mirrorOn?'ON':'OFF'); }
function updateAuthUI(){
  const authed = !!accountInfo;
  $('#loginBtn').classList.toggle('hidden', authed);
  $('#logoutBtn').classList.toggle('hidden', !authed);
  $('#acctBox').classList.toggle('hidden', !authed);
  const both = !!tokenDemo && !!tokenReal;
  ['#copyToggle','#copyBtn_builder','#copyBtn_analysis','#copyBtn_signals','#copyBtn_dtrade'].forEach(sel=>{
    const el=$(sel); if (el){ el.classList.toggle('hidden', !(authed && both)); setCopyLabel(el); }
  });
  if (!authed){ updateGate(); return; }
  const is_demo = accountInfo.is_virtual;
  $('#acctType').textContent = is_demo ? 'Demo' : 'Real';
  $('#acctDot').className = 'dot ' + (is_demo ? 'demo' : 'real');
  $('#acctBal').textContent = `${accountInfo.currency || 'USD'} ${fmt(accountInfo.balance || 0)}`;
  updateGate();
}
$('#loginBtn').onclick = ()=>location.href=OAUTH_URL;
$('#gateLogin').onclick = ()=>location.href=OAUTH_URL;
$('#gateHelp').onclick = ()=>alert('We authorize on deriv.com, then return here. We only use the token to request balances, ticks, and place trades via Deriv API.');
$('#logoutBtn').onclick = ()=>{
  localStorage.removeItem('deriv_token_active');
  accountInfo=null; activeToken=null; updateAuthUI(); connect();
};
$('#acctBtn').onclick = ()=>$('#acctMenu').classList.toggle('open');
document.addEventListener('click',e=>{
  if (!$('#acctBox').contains(e.target)) $('#acctMenu').classList.remove('open');
});
$('#useDemo').onclick = ()=>{ if (tokenDemo){ activeToken=tokenDemo; localStorage.setItem('deriv_token_active',activeToken); connect(); } else toast('No demo token yet. Log in with demo.'); };
$('#useReal').onclick = ()=>{ if (tokenReal){ activeToken=tokenReal; localStorage.setItem('deriv_token_active',activeToken); connect(); } else toast('No real token yet. Log in with real.'); };
$('#addToken').onclick = ()=>{
  const t = prompt('Paste a Deriv API token (virtual or real):'); if(!t) return;
  const s = new WebSocket(WS_URL);
  s.onopen = ()=>s.send(JSON.stringify({authorize:t}));
  s.onmessage = m=>{
    const d=JSON.parse(m.data);
    if (d.authorize){
      if (d.authorize.is_virtual){ tokenDemo=t; localStorage.setItem('deriv_token_demo',t); }
      else { tokenReal=t; localStorage.setItem('deriv_token_real',t); }
      activeToken = tokenReal || tokenDemo; localStorage.setItem('deriv_token_active',activeToken);
      s.close(); toast('Token saved. Reconnecting…'); connect();
    }
  };
};

/* ===== Mirror toggle ===== */
function toggleMirror(){
  mirrorOn=!mirrorOn; localStorage.setItem('sync_mirror',mirrorOn?'1':'0');
  ['#copyToggle','#copyBtn_builder','#copyBtn_analysis','#copyBtn_signals','#copyBtn_dtrade'].forEach(sel=>{const el=$(sel); if (el) setCopyLabel(el);});
  toast(mirrorOn?'✅ Copy Demo → Real Enabled':'❌ Copy Demo → Real Disabled');
}
['#copyToggle','#copyBtn_builder','#copyBtn_analysis','#copyBtn_signals','#copyBtn_dtrade'].forEach(sel=>{
  const el=$(sel); if (el) el.addEventListener('click',toggleMirror);
});

/* ===== Socket router ===== */
function onMsg(msg){
  const d = JSON.parse(msg.data);

  if (d.msg_type==='authorize'){
    accountInfo = d.authorize;
    send({balance:1});
    send({active_symbols:'full', product_type:'basic'});
    if (!txnStreamOpen){ send({transaction:1, subscribe:1}); txnStreamOpen=true; }
    updateAuthUI(); setIframes();
  }

  if (d.msg_type==='balance' && d.balance){
    accountInfo.balance = d.balance.balance;
    updateAuthUI();
  }

  if (d.msg_type==='active_symbols' && d.active_symbols){ buildSymbols(d.active_symbols); }

  if (d.msg_type==='tick'){ renderTick(d.tick); }

  if (d.msg_type==='proposal'){ const id=d.proposal?.id; if (id && running) send({buy:id, price:d.proposal.ask_price}); }

  if (d.msg_type==='buy'){
    addRows(now(), currentSymbol, lastSide, d.buy.buy_price, null, 0);
    if (mirrorOn && accountInfo?.is_virtual && tokenReal){ mirrorTrade(lastProposalEcho); }
  }

  if (d.msg_type==='transaction' && d.transaction){
    if (d.transaction.action==='sell'){
      const pl = Number(d.transaction.amount);
      addRows(now(), d.transaction.symbol || currentSymbol, lastSide, '—', '—', pl);
      send({balance:1});
    }
  }
}

/* ===== Symbols / Ticks ===== */
function buildSymbols(list){
  const wanted=['R_10','R_25','R_50','R_75','R_100','R_10_1S','R_25_1S','R_50_1S','R_75_1S','R_100_1S'];
  const syms=list.filter(s=>wanted.includes(s.symbol));
  const sel=$('#symbolSel'); sel.innerHTML='';
  syms.forEach(s=>{ const o=document.createElement('option'); o.value=s.symbol; o.textContent=s.display_name; sel.appendChild(o); });
  sel.value='R_10_1S'; subscribeTicks('R_10_1S');
}
function subscribeTicks(sym){
  currentSymbol=sym;
  if (tickerId) send({forget:tickerId});
  send({ticks:sym, subscribe:1});
}
$('#symbolSel').onchange = e=>subscribeTicks(e.target.value);
function renderTick(t){
  const line=`[${new Date(t.epoch*1000).toLocaleTimeString()}] ${t.symbol}  ${t.quote}`;
  const box=$('#ticksBox'); const p=document.createElement('div'); p.textContent=line; box.appendChild(p); box.scrollTop=box.scrollHeight;
}

/* ===== Run bar & tray ===== */
$('#runBtn').onclick = ()=> running ? stopRun() : startRun();
$('#stopBtn').onclick = stopRun;
$('#resetBtn').onclick = ()=>{ stopRun(); $('#trayTbl tbody').innerHTML=''; $('#tray').classList.remove('open'); };

function startRun(){
  if (!accountInfo){ toast('Please log in first.'); return; }
  running=true; $('#runStatus').textContent='Running…'; animateBar(true); $('#tray').classList.add('open');

  lastSide = $('#sideSel').value;
  const dur = +$('#dur').value || 1;
  let stake = +$('#stake').value || 1;
  const sym = $('#symbolSel').value || currentSymbol;

  if (mirrorOn && tokenReal){
    fetchRealBalance(bal=>{
      if (bal!=null){
        const maxStake=Math.max(0.35, Math.min(stake, Math.floor(bal*0.05*100)/100));
        if (maxStake<stake){ stake=maxStake; toast(`Stake adjusted to $${fmt(stake)} based on Real balance`); }
      }
      requestAndBuy(sym, stake, dur);
    });
  } else {
    requestAndBuy(sym, stake, dur);
  }
}
function stopRun(){ running=false; $('#runStatus').textContent='Bot is not running'; animateBar(false); }
function animateBar(on){
  const bar=$('#prog'); if (!on){ cancelAnimationFrame(anim); prog=0; bar.style.width='0'; return; }
  const step=()=>{ prog=(prog+2)%100; bar.style.width=prog+'%'; anim=requestAnimationFrame(step); }; step();
}
function requestAndBuy(sym, stake, dur){
  const req={proposal:1, amount:stake, basis:'stake', contract_type:lastSide, currency:(accountInfo.currency||'USD'), duration:dur, duration_unit:'t', symbol:sym};
  lastProposalEcho=req; send(req);
}
function addRows(time,sym,side,buy,payout,pl){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${time}</td><td>${sym}</td><td>${side}</td><td>${buy==='—'?'—':('$'+fmt(buy||0))}</td><td>${payout?('$'+fmt(payout)):'—'}</td><td class="${(pl||0)>=0?'pl-green':'pl-red'}">${pl>=0?'+':''}${fmt(pl||0)}</td>`;
  $('#resTbl tbody').prepend(tr.cloneNode(true));
  $('#trayTbl tbody').prepend(tr);
}

/* ===== Mirror Demo → Real ===== */
function mirrorTrade(echo_req){
  if (!tokenReal) return;
  const s=new WebSocket(WS_URL);
  s.onopen=()=>s.send(JSON.stringify({authorize:tokenReal}));
  s.onmessage=m=>{
    const d=JSON.parse(m.data);
    if (d.msg_type==='authorize'){ s.send(JSON.stringify(echo_req)); }
    if (d.msg_type==='proposal'){ s.send(JSON.stringify({buy:d.proposal.id, price:d.proposal.ask_price})); }
    if (d.msg_type==='buy'){ s.close(); toast('Mirrored trade to REAL'); }
  };
}
function fetchRealBalance(cb){
  const s=new WebSocket(WS_URL);
  s.onopen=()=>s.send(JSON.stringify({authorize:tokenReal}));
  s.onmessage=m=>{
    const d=JSON.parse(m.data);
    if (d.msg_type==='authorize'){ s.send(JSON.stringify({balance:1})); }
    if (d.msg_type==='balance'){ cb(d.balance?.balance ?? null); s.close(); }
  };
}

/* ===== Dashboard tiles ===== */
$('#tLocal').onclick = ()=>$('#fileLocal').click();
$('#fileLocal').onchange = e=>{
  const f=e.target.files[0]; if (!f) return;
  $('#botName').textContent=f.name; $('#chosenBot').classList.remove('hidden');
  toast('Bot loaded from local file.');
};
$('#tBuilder').onclick = ()=>setTab('builder');
$('#tQuick').onclick = ()=>{
  $('#botName').textContent='Quick Strategy — Rise on V10 (1s)';
  $('#chosenBot').classList.remove('hidden');
  $('#symbolSel').value='R_10_1S'; subscribeTicks('R_10_1S'); $('#sideSel').value='CALL';
  toast('Quick strategy ready.');
};
$('#tDrive').onclick = ()=>toast('Drive integration coming soon.');
$$('.fb').forEach(el=>el.addEventListener('click',()=>{
  $('#botName').textContent=el.dataset.name; $('#chosenBot').classList.remove('hidden');
  setTab('dashboard'); toast(`Loaded "${el.dataset.name}"`);
}));

/* ===== Iframes (Deriv apps) ===== */
function setIframes(){
  const botURL     = `https://app.deriv.com/bot?app_id=${APP_ID}`;
  const dtraderURL = `https://app.deriv.com/trader?app_id=${APP_ID}`;
  const chartURL   = `https://app.deriv.com/trader?app_id=${APP_ID}#accumulators`;
  $('#iframeBot').src = botURL;
  $('#iframeDtrader').src = dtraderURL;
  $('#iframeChart').src = chartURL;
}

/* ===== Toast ===== */
function toast(msg){
  const d=document.createElement('div');
  d.textContent=msg;
  d.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:74px;background:#0b223f;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.2);z-index:99';
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),2200);
}

/* ===== Top buttons ===== */
$('#loginBtn').onclick = ()=>location.href=OAUTH_URL;

/* ===== Start ===== */
updateAuthUI(); // shows login gate at first
</script>
</body>
</html>
